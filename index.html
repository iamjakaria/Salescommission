<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faith Engineering | Enterprise Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --accent-blue: #38bdf8;
            --card-bg: rgba(30, 41, 59, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --modal-bg: rgba(15, 23, 42, 0.98);
            --income-green: #10b981;
            --expense-red: #ef4444;
            --profit-gold: #f59e0b;
            --letter-purple: #a855f7;
        }

/* Management Card Styles */
.mgmt-card {
    background: var(--card-bg);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.mgmt-card::before {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 5px;
}
.card-chairman::before { background: linear-gradient(90deg, #38bdf8, #818cf8); }
.card-md::before { background: linear-gradient(90deg, #4ade80, #2dd4bf); }
.card-director::before { background: linear-gradient(90deg, #fbbf24, #fb923c); }

.mgmt-photo {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255,255,255,0.1);
    margin-bottom: 15px;
    background: #1e293b;
}
.mgmt-name { font-weight: 800; font-size: 1.1rem; margin: 0; color: #fff; }
.mgmt-desig { font-size: 0.75rem; color: var(--accent-blue); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
.mgmt-msg { 
    font-size: 0.85rem; 
    line-height: 1.6; 
    color: var(--text-muted); 
    font-style: italic; 
    background: rgba(0,0,0,0.2); 
    padding: 15px; 
    border-radius: 12px;
}
.mgmt-sig { max-height: 40px; margin-top: 15px; opacity: 0.8; filter: brightness(1.2); }
        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
        }

        /* LOGIN INTERFACE STYLES */
        #login-overlay {
            position: fixed; inset: 0; 
            background: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
            z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 24px; padding: 25px; width: 85%; max-width: 300px;
            text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .login-card h2 { margin-bottom: 5px; font-weight: 800; color: #fff; }
        .login-card p { color: var(--accent-blue); font-size: 0.75rem; letter-spacing: 0.1em; margin-bottom: 30px; }
        .login-input-group { margin-bottom: 20px; text-align: left; }
        .login-input-group label { display: block; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .login-input-group input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 12px; color: white; box-sizing: border-box; outline: none; }
        .login-input-group input:focus { border-color: var(--accent-blue); }
        .login-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--accent-blue); color: #000; font-weight: 800; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(56, 189, 248, 0.4); }

        /* LOGOUT BUTTON */
        .logout-btn {
            position: absolute; top: 15px; right: 15px; background: rgba(239, 68, 68, 0.1);
            color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px;
            padding: 8px 12px; font-size: 0.7rem; font-weight: 700; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .logout-btn:hover { background: #ef4444; color: white; }

        /* ORIGINAL STYLES */
        header { text-align: center; padding: 40px 20px 10px; position: relative; width: 100%; max-width: 420px;}
        header h1 { margin: 0; font-weight: 800; letter-spacing: -0.05em; font-size: 1.8rem; text-transform: uppercase; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        header p { color: var(--accent-blue); font-size: 0.75rem; font-weight: 600; letter-spacing: 0.2em; margin-top: 5px; text-transform: uppercase; }

        #active-view-indicator {
            margin-bottom: 20px;
            padding: 5px 15px;
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 800;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            display: none;
        }

        .view-container { width: 90%; max-width: 420px; display: none; animation: fadeIn 0.3s ease-out; }
        .view-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .search-container { margin-bottom: 15px; position: relative; }
        .search-container i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.8rem; }
        .quick-search { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 10px; padding: 10px 10px 10px 35px; color: white; box-sizing: border-box; outline: none; font-size: 0.85rem; transition: 0.3s; }
        .quick-search:focus { border-color: var(--accent-blue); background: rgba(255,255,255,0.1); }

        .bento-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding-bottom: 40px; }

        .nav-header { grid-column: span 3; display: flex; gap: 10px; margin-bottom: 12px; }
        .back-btn, .add-folder-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 12px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .back-btn { flex: 2; color: var(--accent-blue); }
        .add-folder-btn { flex: 1; color: #4ade80; }

        .nav-card { background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 18px; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; text-decoration: none; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; overflow: hidden;}
        .nav-card:hover { border-color: rgba(56, 189, 248, 0.4); background: rgba(30, 41, 59, 0.8); transform: translateY(-2px); }
        .icon-bg { position: absolute; width: 35px; height: 35px; border-radius: 50%; filter: blur(18px); z-index: 1; opacity: 0.15; }
        .nav-card i { font-size: 1.6rem; margin-bottom: 10px; position: relative; z-index: 2; }
        .nav-card span { font-size: 0.65rem; font-weight: 600; color: var(--text-main); position: relative; z-index: 2; text-align: center; width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .folder-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; transition: 0.2s; z-index: 10; }
        .nav-card:hover .folder-actions { opacity: 1; }
        .folder-actions button { background: rgba(0,0,0,0.5); border: none; color: white; width: 20px; height: 20px; border-radius: 4px; font-size: 0.6rem; cursor: pointer; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--bg-dark); border: 1px solid var(--glass-border); border-radius: 24px; padding: 25px; width: 100%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; font-size: 1.1rem; color: var(--accent-blue); display: flex; align-items: center; gap: 10px; }
        
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 10px; padding: 10px; color: white; box-sizing: border-box; outline: none; font-size: 0.9rem; }
        
        .color-picker { display: flex; gap: 10px; margin-top: 5px; }
        .color-opt { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-opt.selected { border-color: white; transform: scale(1.1); }

        .q-table-container { margin-top: 15px; overflow-x: auto; }
        .q-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .q-table th { text-align: left; color: var(--text-muted); padding: 8px; border-bottom: 1px solid var(--glass-border); }
        .q-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .grand-total-row { font-weight: 800; color: #4ade80; font-size: 0.9rem; }

        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-cancel { background: #334155; color: white; }
        .btn-create { background: var(--accent-blue); color: #000; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-download { background: #4ade80; color: #000; }
        .btn-share { background: #25d366; color: white; }
        .btn-print { background: #64748b; color: white; }
        .btn-convert { background: #fbbf24; color: #000; }
        .btn-add-item { background: rgba(56, 189, 248, 0.1); color: var(--accent-blue); border: 1px dashed var(--accent-blue) !important; width: 100%; margin-top: 10px; padding: 8px; font-weight: 600; cursor: pointer; }

        .settings-section { margin-bottom: 10px; border: 1px solid var(--glass-border); border-radius: 15px; background: rgba(255,255,255,0.02); overflow: hidden; }
        .settings-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.03); }
        .settings-header:hover { background: rgba(255,255,255,0.07); }
        .settings-header h4 { margin: 0; font-size: 0.85rem; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 10px; }
        .settings-header i.chevron { transition: 0.3s; font-size: 0.8rem; color: var(--text-muted); }
        
        .settings-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s; }
        .settings-section.open .settings-content { max-height: 1000px; padding: 15px; }
        .settings-section.open .settings-header i.chevron { transform: rotate(180deg); color: var(--accent-blue); }

        .img-preview-container { position: relative; margin-top: 5px; }
        .img-preview { width: 60px; height: 60px; border: 1px solid var(--glass-border); border-radius: 8px; object-fit: contain; background: #fff; display: none; }
        .delete-img-btn { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 0.6rem; cursor: pointer; display: none; }
        .img-preview-container:hover .delete-img-btn { display: block; }

        .inventory-qty-input { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); color: #4ade80; padding: 4px 8px; border-radius: 4px; width: 60px; outline: none; font-weight: bold; text-align: center; }

        #pdf-template { display: none; }

        /* Toggle Switch Styles */
        .toggle-switch { display: flex; align-items: center; margin-bottom: 10px; }
        .toggle-label { flex: 1; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        .toggle-container { position: relative; width: 40px; height: 20px; }
        .toggle-checkbox { display: none; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-checkbox:checked + .toggle-slider { background-color: var(--accent-blue); }
        .toggle-checkbox:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Summary Cards */
        .summary-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .summary-card { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; text-align: center; }
        .summary-card.income { border-color: rgba(16, 185, 129, 0.3); }
        .summary-card.expense { border-color: rgba(239, 68, 68, 0.3); }
        .summary-card.balance { border-color: rgba(56, 189, 248, 0.3); }
        .summary-card.order { border-color: rgba(245, 158, 11, 0.3); }
        .summary-card.value-card { border-color: rgba(139, 92, 246, 0.3); }
        .summary-card.cost { border-color: rgba(239, 68, 68, 0.3); }
        .summary-card.profit { border-color: rgba(16, 185, 129, 0.3); }
        .summary-card .value { font-size: 1.4rem; font-weight: 800; margin: 8px 0; }
        .summary-card.income .value { color: var(--income-green); }
        .summary-card.expense .value { color: var(--expense-red); }
        .summary-card.balance .value { color: var(--accent-blue); }
        .summary-card.order .value { color: #f59e0b; }
        .summary-card.value-card .value { color: #8b5cf6; }
        .summary-card.cost .value { color: #ef4444; }
        .summary-card.profit .value { color: #10b981; }
        .summary-card .label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }

        /* Accounts Table Styling */
        .accounts-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 10px; }
        .accounts-table th { text-align: left; padding: 10px; border-bottom: 2px solid var(--glass-border); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .accounts-table.income th { color: var(--income-green); border-color: rgba(16, 185, 129, 0.3); }
        .accounts-table.expense th { color: var(--expense-red); border-color: rgba(239, 68, 68, 0.3); }
        .accounts-table.transactions th { color: var(--accent-blue); border-color: rgba(56, 189, 248, 0.3); }
        .accounts-table.workorder th { color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }
        
        .accounts-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .accounts-table tr:hover { background: rgba(255,255,255,0.03); }
        
        .income-amount { color: var(--income-green); font-weight: 600; }
        .expense-amount { color: var(--expense-red); font-weight: 600; }
        .profit-amount { color: #10b981; font-weight: 600; }
        .loss-amount { color: #ef4444; font-weight: 600; }
        
        .accounts-table tfoot tr { background: rgba(255,255,255,0.05); font-weight: 800; }
        .accounts-table.income tfoot tr { background: rgba(16, 185, 129, 0.1); }
        .accounts-table.expense tfoot tr { background: rgba(239, 68, 68, 0.1); }
        .accounts-table.transactions tfoot tr { background: rgba(56, 189, 248, 0.1); }
        .accounts-table.workorder tfoot tr { background: rgba(245, 158, 11, 0.1); }

        /* Action buttons */
        .table-actions { display: flex; gap: 8px; }
        .table-actions button { background: none; border: none; color: inherit; cursor: pointer; font-size: 0.7rem; opacity: 0.7; transition: opacity 0.2s; }
        .table-actions button:hover { opacity: 1; }

        /* Category Management Styles */
        .category-management {
            padding: 15px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            margin-top: 15px;
        }
        
        .category-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .category-item:hover {
            background: rgba(255,255,255,0.07);
            border-color: rgba(56, 189, 248, 0.2);
        }
        
        .category-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .category-name {
            flex: 1;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        
        .category-actions {
            display: flex;
            gap: 8px;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        
        .category-item:hover .category-actions {
            opacity: 1;
        }
        
        .category-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-btn {
            background: rgba(56, 189, 248, 0.2);
            color: var(--accent-blue);
        }
        
        .delete-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .empty-state i {
            font-size: 2rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Autocomplete styling */
        .autocomplete-container { position: relative; }
        .autocomplete-suggestions { 
            position: absolute; 
            border: 1px solid var(--glass-border);
            border-radius: 10px; 
            background: var(--card-bg); 
            backdrop-filter: blur(12px); 
            z-index: 99; 
            top: 100%; 
            left: 0; 
            right: 0; 
            max-height: 200px; 
            overflow-y: auto;
            display: none;
        }
        .autocomplete-suggestion { 
            padding: 10px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }
        .autocomplete-suggestion:hover { 
            background: rgba(56, 189, 248, 0.1); 
        }
        .autocomplete-suggestion strong { 
            color: var(--accent-blue); 
        }
        .autocomplete-suggestion small { 
            color: var(--text-muted); 
            font-size: 0.75rem; 
            margin-left: 8px;
        }

        /* Tab-specific category management */
        .tab-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .tab-management-title {
            font-size: 1rem;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tab-back-btn {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 8px 15px;
            color: var(--accent-blue);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* File Management Styles - UPDATED FOR BETTER MOBILE DISPLAY */
        .file-upload-container {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.02);
            border: 1px dashed var(--glass-border);
            border-radius: 15px;
        }
        
        .file-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 25px;
            border-radius: 10px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload-area:hover {
            background: rgba(255,255,255,0.05);
            border-color: var(--accent-blue);
        }
        
        .file-upload-area i {
            font-size: 2.5rem;
            color: var(--accent-blue);
            margin-bottom: 15px;
        }
        
        .file-upload-area p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }
        
        .file-upload-area input {
            display: none;
        }
        
        .file-upload-form {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }
        
        .file-upload-form.active {
            display: block;
        }
        
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 20px;
            width: 100%;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        /* Custom scrollbar for files grid */
        .files-grid::-webkit-scrollbar {
            width: 4px;
        }
        
        .files-grid::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .files-grid::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 10px;
        }
        
        .file-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            min-height: 160px;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .file-card:hover {
            border-color: rgba(56, 189, 248, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .file-icon {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 10px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
            min-height: 32px;
        }
        
        .file-size {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .file-actions {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            gap: 5px;
        }
        
        .file-btn {
            padding: 6px 8px;
            border-radius: 6px;
            border: none;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            justify-content: center;
            min-width: 0;
            overflow: hidden;
        }
        
        .preview-btn {
            background: rgba(56, 189, 248, 0.2);
            color: var(--accent-blue);
        }
        
        .download-btn {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        
        .delete-file-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .file-preview-modal {
            z-index: 1100;
        }
        
        .file-preview-content {
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .file-preview-container {
            margin-top: 20px;
            text-align: center;
        }
        
        .file-preview-img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }
        
        .file-preview-pdf {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 10px;
        }
        
        .file-preview-text {
            width: 100%;
            height: 300px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 15px;
            color: var(--text-main);
            font-family: monospace;
            font-size: 0.8rem;
            overflow: auto;
            text-align: left;
        }
        
        .file-preview-placeholder {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }
        
        .file-preview-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        .file-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 600;
            margin-top: 5px;
            align-self: flex-start;
        }
        
        .file-type-image { background: rgba(56, 189, 248, 0.2); color: var(--accent-blue); }
        .file-type-pdf { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .file-type-doc { background: rgba(37, 99, 235, 0.2); color: #2563eb; }
        .file-type-excel { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .file-type-text { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .file-type-other { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }

        @media (max-width: 350px) { 
            .bento-grid { grid-template-columns: repeat(2, 1fr); } 
            .nav-header { grid-column: span 2; }
            .summary-cards { grid-template-columns: 1fr; }
            .category-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .category-actions { align-self: flex-end; }
            .files-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
            .file-card { padding: 12px; }
            .file-btn { padding: 5px; font-size: 0.6rem; }
            .file-name { font-size: 0.7rem; }
        }

        /* For very small screens */
        @media (max-width: 280px) {
            .files-grid { grid-template-columns: 1fr; }
            .file-actions { flex-wrap: wrap; }
            .file-btn { flex: 1 0 45%; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2>FAITH ENGINEERING</h2>
            <p>Authorized Personnel Only</p>
            <div class="login-input-group">
                <label>Login ID</label>
                <input type="text" id="login-id" placeholder="Enter ID">
            </div>
            <div class="login-input-group">
                <label>Password</label>
                <input type="password" id="login-pass" placeholder="••••••••">
            </div>
            <button class="login-btn" onclick="checkAuth()">System Only</button>
            <div id="login-error" style="color: #ef4444; font-size: 0.7rem; margin-top: 15px; display: none; font-weight: 700;">Invalid Credentials</div>
        </div>
    </div>

    <header>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        <h1 id="brand-header">FAITH ENGINEERING</h1>
        <p id="brand-slogan">ENTERPRISE RESOURCE PLANNING</p>
    </header>

    <div id="active-view-indicator">Home</div>

    <div id="main-menu" class="view-container active">
        <div class="bento-grid">
            <a onclick="openView('main-menu')" class="nav-card"><div class="icon-bg" style="background:#38bdf8"></div><i class="fas fa-house" style="color:#38bdf8"></i><span>Home</span></a>
            <a onclick="openView('management-view')" class="nav-card"><div class="icon-bg" style="background:#f87171"></div><i class="fas fa-user-tie" style="color:#f87171"></i><span>Management</span></a>

<div id="management-view" class="view-container">
    <div class="nav-header">
        <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
    </div>
    <div id="mgmt-content-area">
        </div>
</div>
            <a onclick="openView('documents-menu')" class="nav-card"><div class="icon-bg" style="background:#a78bfa"></div><i class="fas fa-file-shield" style="color:#a78bfa"></i><span>Documents</span></a>
            <a onclick="openView('clients-view')" class="nav-card"><div class="icon-bg" style="background:#4ade80"></div><i class="fas fa-handshake" style="color:#4ade80"></i><span>Clients</span></a>
            <a onclick="openView('supplier-view')" class="nav-card"><div class="icon-bg" style="background:#2dd4bf"></div><i class="fas fa-truck-ramp-box" style="color:#2dd4bf"></i><span>Supplier</span></a>
            <a onclick="openView('products-menu')" class="nav-card"><div class="icon-bg" style="background:#fbbf24"></div><i class="fas fa-microchip" style="color:#fbbf24"></i><span>Products</span></a>
            <a onclick="openView('inventory-view')" class="nav-card"><div class="icon-bg" style="background:#60a5fa"></div><i class="fas fa-warehouse" style="color:#60a5fa"></i><span>Inventory</span></a>
            <a onclick="openView('commercial-menu')" class="nav-card"><div class="icon-bg" style="background:#c084fc"></div><i class="fas fa-briefcase" style="color:#c084fc"></i><span>Commercial</span></a>
            <a onclick="openView('accounts-menu')" class="nav-card"><div class="icon-bg" style="background:#34d399"></div><i class="fas fa-vault" style="color:#34d399"></i><span>Accounts</span></a>
            <a onclick="openView('workorder-menu')" class="nav-card"><div class="icon-bg" style="background:#f97316"></div><i class="fas fa-screwdriver-wrench" style="color:#f97316"></i><span>Work Order</span></a>
            <a onclick="openView('projects-menu')" class="nav-card"><div class="icon-bg" style="background:#818cf8"></div><i class="fas fa-diagram-project" style="color:#818cf8"></i><span>Projects</span></a>
            <a onclick="openView('settings-view')" class="nav-card"><div class="icon-bg" style="background:#fb923c"></div><i class="fas fa-gears" style="color:#fb923c"></i><span>Settings</span></a>
        </div>
    </div>

    <div id="inventory-view" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
        </div>
        <h3 style="text-align:center; color: #60a5fa; margin-top: 0;">Stock Inventory</h3>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search inventory..." onkeyup="quickFilterTable('inventory-table-body', this.value)">
        </div>

        <div class="q-table-container">
            <table class="q-table">
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Items</th>
                        <th>Description</th>
                        <th>Available Qty</th>
                    </tr>
                </thead>
                <tbody id="inventory-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="products-menu" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openView('category-management-view')"><i class="fas fa-folder-plus"></i> Manage Categories</div>
        </div>
        <div class="bento-grid" id="products-menu-folder-grid"></div>
    </div>

    <div id="category-management-view" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('products-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openCategoryModal()"><i class="fas fa-plus"></i> New Category</div>
        </div>
        
        <h3 style="text-align:center; color: var(--accent-blue); margin-top: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <i class="fas fa-folder-tree"></i> Category Management
        </h3>
        
        <p style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin: 10px 0 20px 0;">
            Manage all product categories from here
        </p>
        
        <div class="category-management">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" class="quick-search" placeholder="Search categories..." onkeyup="filterCategories(this.value)">
            </div>
            
            <div class="category-list" id="categories-list"></div>
        </div>
    </div>

    <div id="folder-content-view" class="view-container">
        <div class="nav-header">
            <div class="back-btn" id="folder-view-back-btn" onclick="openView('products-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" id="add-item-btn-container" onclick="openProductEntryModal()"><i class="fas fa-plus"></i> Add Item</div>
        </div>
        <h3 id="folder-view-title" style="text-align:center; color: var(--accent-blue); margin-top: 0;">Folder</h3>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search items in this folder..." onkeyup="quickFilterTable('folder-products-table-body', this.value)">
        </div>

        <div class="q-table-container">
            <table class="q-table">
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Items</th>
                        <th>Description</th>
                        <th>Unit</th>
                        <th>Unit Price</th>
                        <th id="folder-action-header">Action</th>
                    </tr>
                </thead>
                <tbody id="folder-products-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="documents-menu" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openView('documents-category-management')"><i class="fas fa-folder-plus"></i> Manage Folders</div>
        </div>
        <div class="bento-grid" id="documents-menu-folder-grid"></div>
    </div>

    <div id="documents-category-management" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('documents-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openTabCategoryModal('documents')"><i class="fas fa-plus"></i> New Folder</div>
        </div>
        
        <div class="tab-management-header">
            <h3 class="tab-management-title">
                <i class="fas fa-file-shield"></i> Documents Folders
            </h3>
        </div>
        
        <p style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin: 10px 0 20px 0;">
            Manage all document folders from here
        </p>
        
        <div class="category-management">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" class="quick-search" placeholder="Search document folders..." onkeyup="filterTabCategories(this.value, 'documents')">
            </div>
            
            <div class="category-list" id="documents-categories-list"></div>
        </div>
    </div>

    <div id="projects-menu" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openView('projects-category-management')"><i class="fas fa-folder-plus"></i> Manage Folders</div>
        </div>
        <div class="bento-grid" id="projects-menu-folder-grid"></div>
    </div>

    <div id="projects-category-management" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('projects-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openTabCategoryModal('projects')"><i class="fas fa-plus"></i> New Folder</div>
        </div>
        
        <div class="tab-management-header">
            <h3 class="tab-management-title">
                <i class="fas fa-diagram-project"></i> Projects Folders
            </h3>
        </div>
        
        <p style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin: 10px 0 20px 0;">
            Manage all project folders from here
        </p>
        
        <div class="category-management">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" class="quick-search" placeholder="Search project folders..." onkeyup="filterTabCategories(this.value, 'projects')">
            </div>
            
            <div class="category-list" id="projects-categories-list"></div>
        </div>
    </div>

    <div id="documents-folder-files-view" class="view-container">
        <div class="nav-header">
            <div class="back-btn" id="documents-folder-back-btn"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="triggerFileUpload('documents')"><i class="fas fa-upload"></i> Upload File</div>
        </div>
        
        <h3 id="documents-folder-title" style="text-align:center; color: var(--accent-blue); margin-top: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <i class="fas fa-folder"></i> Folder
        </h3>
        
        <div class="file-upload-container" id="documents-file-upload-container">
            <div class="file-upload-area" onclick="triggerFileUpload('documents')">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload or drag & drop files here</p>
                <p style="font-size: 0.7rem; margin-top: 5px;">Supports: JPG, PNG, PDF, Excel, Word, Text, XML, HSE files</p>
                <input type="file" id="documents-file-input" multiple onchange="handleFileSelection(this.files, 'documents')">
            </div>
            
            <div class="file-upload-form" id="documents-file-upload-form">
                <div class="form-group">
                    <label>File Name</label>
                    <input type="text" id="documents-file-name" placeholder="Enter file name (optional)">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="documents-file-description" rows="2" placeholder="File description (optional)"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="cancelFileUpload('documents')">Cancel</button>
                    <button class="btn-create" onclick="uploadFile('documents')">Upload File</button>
                </div>
            </div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search files..." onkeyup="filterFiles(this.value, 'documents')">
        </div>
        
        <div class="files-grid" id="documents-files-grid"></div>
    </div>

    <div id="projects-folder-files-view" class="view-container">
        <div class="nav-header">
            <div class="back-btn" id="projects-folder-back-btn"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="triggerFileUpload('projects')"><i class="fas fa-upload"></i> Upload File</div>
        </div>
        
        <h3 id="projects-folder-title" style="text-align:center; color: var(--accent-blue); margin-top: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <i class="fas fa-folder"></i> Folder
        </h3>
        
        <div class="file-upload-container" id="projects-file-upload-container">
            <div class="file-upload-area" onclick="triggerFileUpload('projects')">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload or drag & drop files here</p>
                <p style="font-size: 0.7rem; margin-top: 5px;">Supports: JPG, PNG, PDF, Excel, Word, Text, XML, HSE files</p>
                <input type="file" id="projects-file-input" multiple onchange="handleFileSelection(this.files, 'projects')">
            </div>
            
            <div class="file-upload-form" id="projects-file-upload-form">
                <div class="form-group">
                    <label>File Name</label>
                    <input type="text" id="projects-file-name" placeholder="Enter file name (optional)">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projects-file-description" rows="2" placeholder="File description (optional)"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="cancelFileUpload('projects')">Cancel</button>
                    <button class="btn-create" onclick="uploadFile('projects')">Upload File</button>
                </div>
            </div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search files..." onkeyup="filterFiles(this.value, 'projects')">
        </div>
        
        <div class="files-grid" id="projects-files-grid"></div>
    </div>

    <div id="workorder-menu" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openView('workorder-category-management')"><i class="fas fa-folder-plus"></i> Manage Folders</div>
        </div>
        <div class="bento-grid" id="workorder-menu-folder-grid"></div>
    </div>

    <div id="workorder-category-management" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('workorder-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openTabCategoryModal('workorder')"><i class="fas fa-plus"></i> New Folder</div>
        </div>
        
        <div class="tab-management-header">
            <h3 class="tab-management-title">
                <i class="fas fa-screwdriver-wrench"></i> Work Order Folders
            </h3>
        </div>
        
        <p style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin: 10px 0 20px 0;">
            Manage all work order folders from here
        </p>
        
        <div class="category-management">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" class="quick-search" placeholder="Search work order folders..." onkeyup="filterTabCategories(this.value, 'workorder')">
            </div>
            
            <div class="category-list" id="workorder-categories-list"></div>
        </div>
    </div>

    <div id="workorder-folder-files-view" class="view-container">
        <div class="nav-header">
            <div class="back-btn" id="workorder-folder-back-btn"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="triggerFileUpload('workorder')"><i class="fas fa-upload"></i> Upload File</div>
        </div>
        
        <h3 id="workorder-folder-title" style="text-align:center; color: var(--accent-blue); margin-top: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <i class="fas fa-folder"></i> Folder
        </h3>
        
        <div class="file-upload-container" id="workorder-file-upload-container">
            <div class="file-upload-area" onclick="triggerFileUpload('workorder')">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload or drag & drop files here</p>
                <p style="font-size: 0.7rem; margin-top: 5px;">Supports: JPG, PNG, PDF, Excel, Word, Text, XML, HSE files</p>
                <input type="file" id="workorder-file-input" multiple onchange="handleFileSelection(this.files, 'workorder')">
            </div>
            
            <div class="file-upload-form" id="workorder-file-upload-form">
                <div class="form-group">
                    <label>File Name</label>
                    <input type="text" id="workorder-file-name" placeholder="Enter file name (optional)">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="workorder-file-description" rows="2" placeholder="File description (optional)"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="cancelFileUpload('workorder')">Cancel</button>
                    <button class="btn-create" onclick="uploadFile('workorder')">Upload File</button>
                </div>
            </div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search files..." onkeyup="filterFiles(this.value, 'workorder')">
        </div>
        
        <div class="files-grid" id="workorder-files-grid"></div>
    </div>

    <div id="folder-workorder-summary" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('workorder-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openWorkOrderModal()"><i class="fas fa-plus"></i> Add Order</div>
        </div>
        <h3 style="text-align:center; color:#f59e0b; margin-top: 0;">Work Order Summary</h3>
        
        <div class="summary-cards">
            <div class="summary-card order">
                <div class="label">Total Orders</div>
                <div class="value" id="total-orders">0</div>
            </div>
            <div class="summary-card value-card">
                <div class="label">Total Value</div>
                <div class="value" id="total-order-value">৳ 0</div>
            </div>
            <div class="summary-card cost">
                <div class="label">Total Cost</div>
                <div class="value" id="total-order-cost">৳ 0</div>
            </div>
            <div class="summary-card profit">
                <div class="label">Total Profit</div>
                <div class="value" id="total-order-profit">৳ 0</div>
            </div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search work orders..." onkeyup="quickFilterTable('workorder-table-body', this.value)">
        </div>

        <div class="q-table-container">
            <table class="accounts-table workorder">
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Date</th>
                        <th>Client</th>
                        <th>Order ID</th>
                        <th>Type</th>
                        <th>Value</th>
                        <th>Cost</th>
                        <th>Profit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="workorder-table-body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" style="text-align: right; font-weight: 800;">Grand Total Profit:</td>
                        <td id="workorder-total-value" style="color: #8b5cf6; font-weight: 800;">৳ 0</td>
                        <td id="workorder-total-cost" style="color: #ef4444; font-weight: 800;">৳ 0</td>
                        <td id="workorder-grand-profit" style="color: #10b981; font-weight: 800;">৳ 0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div id="file-preview-modal" class="modal-overlay file-preview-modal">
        <div class="modal-content file-preview-content">
            <h3 id="file-preview-title">File Preview</h3>
            <div class="file-preview-container" id="file-preview-container"></div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('file-preview-modal')">Close</button>
                <button class="btn-download" onclick="downloadPreviewedFile()"><i class="fas fa-download"></i> Download</button>
                <button class="btn-delete" onclick="deletePreviewedFile()"><i class="fas fa-trash"></i> Delete</button>
            </div>
        </div>
    </div>

    <div id="commercial-menu" class="view-container">
        <div class="bento-grid">
            <div class="nav-header"><div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div></div>
            <a onclick="openView('folder-quotation')" class="nav-card"><div class="icon-bg" style="background:#c084fc"></div><i class="fas fa-file-lines" style="color:#c084fc"></i><span>Quotation</span></a>
            <a onclick="openView('folder-invoice')" class="nav-card"><div class="icon-bg" style="background:#c084fc"></div><i class="fas fa-file-invoice" style="color:#c084fc"></i><span>Invoice</span></a>
            <a onclick="openView('folder-challan')" class="nav-card"><div class="icon-bg" style="background:#c084fc"></div><i class="fas fa-truck-fast" style="color:#c084fc"></i><span>Delivery Challan</span></a>
            <a onclick="openView('folder-po')" class="nav-card"><div class="icon-bg" style="background:#c084fc"></div><i class="fas fa-cart-shopping" style="color:#c084fc"></i><span>Purchase Order</span></a>
            <a onclick="openView('folder-receipt')" class="nav-card"><div class="icon-bg" style="background:#c084fc"></div><i class="fas fa-receipt" style="color:#c084fc"></i><span>Money Receipt</span></a>
            <a onclick="openView('folder-letter')" class="nav-card"><div class="icon-bg" style="background:#a855f7"></div><i class="fas fa-envelope" style="color:#a855f7"></i><span>Letter</span></a>
        </div>
    </div>

    <div id="folder-letter" class="view-container">
        <div class="bento-grid" id="grid-letter">
            <div class="nav-header">
                <div class="back-btn" onclick="openView('commercial-menu')"><i class="fas fa-arrow-left"></i> Back</div>
                <div class="add-folder-btn" onclick="openLetterModal()"><i class="fas fa-plus"></i> New Letter</div>
            </div>
        </div>
    </div>

    <div id="folder-quotation" class="view-container"><div class="bento-grid" id="grid-quotation"><div class="nav-header"><div class="back-btn" onclick="openView('commercial-menu')"><i class="fas fa-arrow-left"></i> Back</div><div class="add-folder-btn" onclick="openDocModal('QUOTATION')"><i class="fas fa-plus"></i> New</div></div></div></div>
    <div id="folder-invoice" class="view-container"><div class="bento-grid" id="grid-invoice"><div class="nav-header"><div class="back-btn" onclick="openView('commercial-menu')"><i class="fas fa-arrow-left"></i> Back</div><div class="add-folder-btn" onclick="openDocModal('INVOICE')"><i class="fas fa-plus"></i> New</div></div></div></div>
    <div id="folder-challan" class="view-container"><div class="bento-grid" id="grid-challan"><div class="nav-header"><div class="back-btn" onclick="openView('commercial-menu')"><i class="fas fa-arrow-left"></i> Back</div><div class="add-folder-btn" onclick="openDocModal('CHALLAN')"><i class="fas fa-plus"></i> New</div></div></div></div>
    <div id="folder-po" class="view-container"><div class="bento-grid" id="grid-po"><div class="nav-header"><div class="back-btn" onclick="openView('commercial-menu')"><i class="fas fa-arrow-left"></i> Back</div><div class="add-folder-btn" onclick="openDocModal('PO')"><i class="fas fa-plus"></i> New</div></div></div></div>
    <div id="folder-receipt" class="view-container"><div class="bento-grid" id="grid-receipt"><div class="nav-header"><div class="back-btn" onclick="openView('commercial-menu')"><i class="fas fa-arrow-left"></i> Back</div><div class="add-folder-btn" onclick="openMR()"><i class="fas fa-plus"></i> New</div></div></div></div>

    <div id="clients-view" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openClientModal()"><i class="fas fa-plus"></i> Add</div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search clients..." onkeyup="quickFilterTable('clients-table-body', this.value)">
        </div>

        <div class="q-table-container">
            <table class="q-table">
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Client</th>
                        <th>Person</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clients-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="supplier-view" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openSupplierModal()"><i class="fas fa-plus"></i> Add</div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search suppliers..." onkeyup="quickFilterTable('supplier-table-body', this.value)">
        </div>

        <div class="q-table-container">
            <table class="q-table">
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Org</th>
                        <th>Product</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="supplier-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="accounts-menu" class="view-container">
        <div class="bento-grid">
            <div class="nav-header"><div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div></div>
            <a onclick="openView('folder-income')" class="nav-card"><div class="icon-bg" style="background:#4ade80"></div><i class="fas fa-money-bill-trend-up" style="color:#4ade80"></i><span>Income</span></a>
            <a onclick="openView('folder-expense')" class="nav-card"><div class="icon-bg" style="background:#f87171"></div><i class="fas fa-money-bill-transfer" style="color:#f87171"></i><span>Expense</span></a>
            <a onclick="openView('folder-transactions')" class="nav-card"><div class="icon-bg" style="background:#60a5fa"></div><i class="fas fa-building-columns" style="color:#60a5fa"></i><span>Transactions</span></a>
        </div>
    </div>

    <div id="folder-income" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('accounts-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openIncomeModal()"><i class="fas fa-plus"></i> Add Income</div>
        </div>
        <h3 style="text-align:center; color:var(--income-green); margin-top: 0;">Income Records</h3>
        
        <div class="summary-cards">
            <div class="summary-card income">
                <div class="label">Total Income</div>
                <div class="value" id="total-income">৳ 0</div>
            </div>
            <div class="summary-card balance">
                <div class="label">This Month</div>
                <div class="value" id="month-income">৳ 0</div>
            </div>
            <div class="summary-card income" style="grid-column: span 2;">
                <div class="label">This Year</div>
                <div class="value" id="year-income">৳ 0</div>
            </div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search income records..." onkeyup="quickFilterTable('income-table-body', this.value)">
        </div>

        <div class="q-table-container">
            <table class="accounts-table income">
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Date</th>
                        <th>Purpose</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="income-table-body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: 800;">Grand Total:</td>
                        <td id="income-grand-total" style="color: var(--income-green); font-weight: 800;">৳ 0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div id="folder-expense" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('accounts-menu')"><i class="fas fa-arrow-left"></i> Back</div>
            <div class="add-folder-btn" onclick="openExpenseModal()"><i class="fas fa-plus"></i> Add Expense</div>
        </div>
        <h3 style="text-align:center; color:var(--expense-red); margin-top: 0;">Expense Tracking</h3>
        
        <div class="summary-cards">
            <div class="summary-card expense">
                <div class="label">Total Expense</div>
                <div class="value" id="total-expense">৳ 0</div>
            </div>
            <div class="summary-card balance">
                <div class="label">This Month</div>
                <div class="value" id="month-expense">৳ 0</div>
            </div>
            <div class="summary-card expense" style="grid-column: span 2;">
                <div class="label">This Year</div>
                <div class="value" id="year-expense">৳ 0</div>
            </div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search expense records..." onkeyup="quickFilterTable('expense-table-body', this.value)">
        </div>

        <div class="q-table-container">
            <table class="accounts-table expense">
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Date</th>
                        <th>Purpose</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="expense-table-body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: 800;">Grand Total:</td>
                        <td id="expense-grand-total" style="color: var(--expense-red); font-weight: 800;">৳ 0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div id="folder-transactions" class="view-container">
        <div class="nav-header">
            <div class="back-btn" onclick="openView('accounts-menu')"><i class="fas fa-arrow-left"></i> Back</div>
        </div>
        <h3 style="text-align:center; color:var(--accent-blue); margin-top: 0;">Transaction History</h3>
        
        <div class="summary-cards">
            <div class="summary-card income">
                <div class="label">Total Income</div>
                <div class="value" id="summary-total-income">৳ 0</div>
            </div>
            <div class="summary-card expense">
                <div class="label">Total Expense</div>
                <div class="value" id="summary-total-expense">৳ 0</div>
            </div>
            <div class="summary-card balance" style="grid-column: span 2;">
                <div class="label">Current Balance</div>
                <div class="value" id="current-balance">৳ 0</div>
            </div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="quick-search" placeholder="Search transactions..." onkeyup="quickFilterTable('transactions-table-body', this.value)">
        </div>

        <div class="q-table-container">
            <table class="accounts-table transactions">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="transactions-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="settings-view" class="view-container">
        <div class="nav-header" style="margin-bottom: 20px;">
            <div class="back-btn" onclick="openView('main-menu')"><i class="fas fa-arrow-left"></i> Back</div>
        </div>

        <div class="settings-section">
            <div class="settings-header" onclick="toggleSection(this)">
                <h4><i class="fas fa-building"></i> General Information</h4>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="settings-content">
                <div class="form-group"><label>Company Name</label><input type="text" id="set-comp-name"></div>
                <div class="form-group"><label>Company Slogan</label><input type="text" id="set-comp-slogan" placeholder="e.g. Innovation in Control"></div>
                <div class="form-group"><label>Company Address</label><textarea id="set-comp-addr" rows="2"></textarea></div>
                <div class="form-group"><label>Mobile</label><input type="text" id="set-comp-mobile"></div>
                <div class="form-group"><label>Email</label><input type="text" id="set-comp-email"></div>
                <div class="form-group"><label>Website</label><input type="text" id="set-comp-web"></div>
                <div class="form-group"><label>Currency Symbol</label>
                    <select id="set-currency">
                        <option value="৳">৳ (BDT)</option>
                        <option value="$">$ (USD)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-header" onclick="toggleSection(this)">
                <h4><i class="fas fa-file-pdf"></i> PDF Page Layout</h4>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="settings-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group"><label>Top (in)</label><input type="number" step="0.1" id="set-m-top" value="0.5"></div>
                    <div class="form-group"><label>Bottom (in)</label><input type="number" step="0.1" id="set-m-bottom" value="0.5"></div>
                    <div class="form-group"><label>Left (in)</label><input type="number" step="0.1" id="set-m-left" value="0.5"></div>
                    <div class="form-group"><label>Right (in)</label><input type="number" step="0.1" id="set-m-right" value="0.5"></div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-header" onclick="toggleSection(this)">
                <h4><i class="fas fa-stamp"></i> Media & Seals</h4>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="settings-content">
                <div class="toggle-switch">
                    <div class="toggle-label">Show Company Logo in PDF</div>
                    <div class="toggle-container">
                        <input type="checkbox" id="toggle-logo" class="toggle-checkbox">
                        <label for="toggle-logo" class="toggle-slider"></label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Company Logo</label>
                    <input type="file" accept="image/*" onchange="encodeImg(this, 'prev-logo', 'data-logo')">
                    <div class="img-preview-container">
                        <img id="prev-logo" class="img-preview">
                        <button class="delete-img-btn" onclick="deleteImage('data-logo', 'prev-logo')">×</button>
                    </div>
                </div>
                
                <div class="toggle-switch">
                    <div class="toggle-label">Show Company Seal in PDF</div>
                    <div class="toggle-container">
                        <input type="checkbox" id="toggle-seal" class="toggle-checkbox">
                        <label for="toggle-seal" class="toggle-slider"></label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Company Seal</label>
                    <input type="file" accept="image/*" onchange="encodeImg(this, 'prev-seal', 'data-seal')">
                    <div class="img-preview-container">
                        <img id="prev-seal" class="img-preview">
                        <button class="delete-img-btn" onclick="deleteImage('data-seal', 'prev-seal')">×</button>
                    </div>
                </div>
                
                <div class="form-group"><label>Doc Signature (General)</label><input type="file" accept="image/*" onchange="encodeImg(this, 'prev-gen-sig', 'data-gen-sig')">
                    <div class="img-preview-container">
                        <img id="prev-gen-sig" class="img-preview">
                        <button class="delete-img-btn" onclick="deleteImage('data-gen-sig', 'prev-gen-sig')">×</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-header" onclick="toggleSection(this)">
                <h4><i class="fas fa-user-shield"></i> Executive Management</h4>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="settings-content">
                <div class="form-group"><label>Chairman's Name</label><input type="text" id="set-chair-name"></div>
                <div class="form-group"><label>Chairman's Message</label><textarea id="set-chair-msg"></textarea></div>
                <div class="form-group"><label>Chairman's Signature</label><input type="file" accept="image/*" onchange="encodeImg(this, 'prev-chair-sig', 'data-chair-sig')">
                    <div class="img-preview-container">
                        <img id="prev-chair-sig" class="img-preview">
                        <button class="delete-img-btn" onclick="deleteImage('data-chair-sig', 'prev-chair-sig')">×</button>
                    </div>
                </div>
                <hr style="border:0; border-top:1px solid var(--glass-border); margin:15px 0;">
                <div class="form-group"><label>MD's Name</label><input type="text" id="set-md-name"></div>
                <div class="form-group"><label>MD's Message</label><textarea id="set-md-msg"></textarea></div>
                <div class="form-group"><label>MD's Signature</label><input type="file" accept="image/*" onchange="encodeImg(this, 'prev-md-sig', 'data-md-sig')">
                    <div class="img-preview-container">
                        <img id="prev-md-sig" class="img-preview">
                        <button class="delete-img-btn" onclick="deleteImage('data-md-sig', 'prev-md-sig')">×</button>
                    </div>
                </div>
                <hr style="border:0; border-top:1px solid var(--glass-border); margin:15px 0;">
                <div class="form-group"><label>Director's Name</label><input type="text" id="set-dir-name"></div>
                <div class="form-group"><label>Director's Message</label><textarea id="set-dir-msg"></textarea></div>
                <div class="form-group"><label>Director's Signature</label><input type="file" accept="image/*" onchange="encodeImg(this, 'prev-dir-sig', 'data-dir-sig')">
                    <div class="img-preview-container">
                        <img id="prev-dir-sig" class="img-preview">
                        <button class="delete-img-btn" onclick="deleteImage('data-dir-sig', 'prev-dir-sig')">×</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-header" onclick="toggleSection(this)">
                <h4><i class="fas fa-file-signature"></i> Authorized Signatory</h4>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="settings-content">
                <div class="form-group"><label>Signatory Name</label><input type="text" id="set-sig-name"></div>
                <div class="form-group"><label>Signatory Designation</label><input type="text" id="set-sig-desig"></div>
                <div class="form-group"><label>Upload Signature</label><input type="file" accept="image/*" onchange="encodeImg(this, 'prev-auth-sig', 'data-auth-sig')">
                    <div class="img-preview-container">
                        <img id="prev-auth-sig" class="img-preview">
                        <button class="delete-img-btn" onclick="deleteImage('data-auth-sig', 'prev-auth-sig')">×</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-header" onclick="toggleSection(this)">
                <h4><i class="fas fa-list-check"></i> Terms & Conditions</h4>
                <i class="fas fa-chevron-down chevron"></i>
            </div>
            <div class="settings-content">
                <div class="form-group"><label>Quotation Terms</label><textarea id="set-terms-q" rows="3"></textarea></div>
                <div class="form-group"><label>Invoice Terms</label><textarea id="set-terms-inv" rows="3"></textarea></div>
                <div class="form-group"><label>Challan Terms</label><textarea id="set-terms-ch" rows="3"></textarea></div>
                <div class="form-group"><label>PO Terms</label><textarea id="set-terms-po" rows="3"></textarea></div>
            </div>
        </div>

        <div class="modal-actions" style="margin-bottom: 50px;">
            <button class="btn-create" onclick="saveSettings()">Save & Update</button>
        </div>
    </div>

    <div id="category-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="category-modal-title">Create New Category</h3>
            <div class="form-group">
                <label>Category Name</label>
                <input type="text" id="category-name" placeholder="Enter category name">
            </div>
            <div class="form-group">
                <label>Category Color</label>
                <div class="color-picker" id="category-color-picker">
                    <div class="color-opt" style="background:#38bdf8" onclick="selectCategoryColor('#38bdf8', this)"></div>
                    <div class="color-opt" style="background:#f87171" onclick="selectCategoryColor('#f87171', this)"></div>
                    <div class="color-opt" style="background:#4ade80" onclick="selectCategoryColor('#4ade80', this)"></div>
                    <div class="color-opt" style="background:#fbbf24" onclick="selectCategoryColor('#fbbf24', this)"></div>
                    <div class="color-opt" style="background:#a78bfa" onclick="selectCategoryColor('#a78bfa', this)"></div>
                    <div class="color-opt" style="background:#2dd4bf" onclick="selectCategoryColor('#2dd4bf', this)"></div>
                    <div class="color-opt" style="background:#fb923c" onclick="selectCategoryColor('#fb923c', this)"></div>
                    <div class="color-opt" style="background:#c084fc" onclick="selectCategoryColor('#c084fc', this)"></div>
                </div>
            </div>
            <input type="hidden" id="category-edit-id" value="">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('category-modal')">Cancel</button>
                <button class="btn-create" onclick="saveCategory()">Save Category</button>
            </div>
        </div>
    </div>

    <div id="tab-category-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="tab-category-modal-title">Create New Folder</h3>
            <div class="form-group">
                <label>Folder Name</label>
                <input type="text" id="tab-category-name" placeholder="Enter folder name">
            </div>
            <div class="form-group">
                <label>Folder Color</label>
                <div class="color-picker" id="tab-category-color-picker">
                    <div class="color-opt" style="background:#38bdf8" onclick="selectTabCategoryColor('#38bdf8', this)"></div>
                    <div class="color-opt" style="background:#f87171" onclick="selectTabCategoryColor('#f87171', this)"></div>
                    <div class="color-opt" style="background:#4ade80" onclick="selectTabCategoryColor('#4ade80', this)"></div>
                    <div class="color-opt" style="background:#fbbf24" onclick="selectTabCategoryColor('#fbbf24', this)"></div>
                    <div class="color-opt" style="background:#a78bfa" onclick="selectTabCategoryColor('#a78bfa', this)"></div>
                    <div class="color-opt" style="background:#2dd4bf" onclick="selectTabCategoryColor('#2dd4bf', this)"></div>
                    <div class="color-opt" style="background:#fb923c" onclick="selectTabCategoryColor('#fb923c', this)"></div>
                    <div class="color-opt" style="background:#c084fc" onclick="selectTabCategoryColor('#c084fc', this)"></div>
                </div>
            </div>
            <input type="hidden" id="tab-category-edit-id" value="">
            <input type="hidden" id="tab-category-parent" value="">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('tab-category-modal')">Cancel</button>
                <button class="btn-create" onclick="saveTabCategory()">Save Folder</button>
            </div>
        </div>
    </div>

    <div id="letter-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="letter-modal-title">Create New Letter</h3>
            
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;"><label>Date</label><input type="date" id="letter-date"></div>
                <div class="form-group" style="flex: 1;"><label>Document ID</label><input type="text" id="letter-id" readonly></div>
            </div>
            <div class="form-group"><label>Document Title</label><input type="text" id="letter-title" placeholder="Enter letter title/subject"></div>
            <div class="form-group"><label>Document Text</label><textarea id="letter-text" rows="10" placeholder="Enter letter content (will be displayed in justified format in PDF)"></textarea></div>
            
            <input type="hidden" id="letter-edit-id" value="">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('letter-modal')">Cancel</button>
                <button class="btn-create" onclick="saveLetter()">Save Letter</button>
            </div>
        </div>
    </div>

    <div id="product-entry-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="p-modal-title">Add Product Info</h3>
            <div class="form-group"><label>Item Name</label><input type="text" id="p-item"></div>
            <div class="form-group"><label>Description</label><textarea id="p-desc" rows="2"></textarea></div>
            <div class="form-group"><label>Unit</label><input type="text" id="p-unit" placeholder="Pcs, Kg, etc."></div>
            <div class="form-group"><label>Unit Price</label><input type="number" id="p-price"></div>
            <input type="hidden" id="p-edit-idx" value="-1">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('product-entry-modal')">Cancel</button>
                <button class="btn-create" onclick="saveProductEntry()">Save Entry</button>
            </div>
        </div>
    </div>

    <div id="client-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="cl-modal-title">Client Information</h3>
            <div class="form-group"><label>Client Name</label><input type="text" id="cl-name"></div>
            <div class="form-group"><label>Address</label><textarea id="cl-address" rows="2"></textarea></div>
            <div class="form-group"><label>Contact Person</label><input type="text" id="cl-person"></div>
            <div class="form-group"><label>Phone</label><input type="text" id="cl-phone"></div>
            <div class="form-group"><label>Email</label><input type="email" id="cl-email"></div>
            <input type="hidden" id="cl-edit-idx" value="-1">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('client-modal')">Cancel</button>
                <button class="btn-create" onclick="saveClient()">Save Client</button>
            </div>
        </div>
    </div>

    <div id="supplier-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="sup-modal-title">Supplier Information</h3>
            <div class="form-group"><label>Organization</label><input type="text" id="sup-org"></div>
            <div class="form-group"><label>Address</label><textarea id="sup-address" rows="2"></textarea></div>
            <div class="form-group"><label>Contact Person</label><input type="text" id="sup-person"></div>
            <div class="form-group"><label>Phone</label><input type="text" id="sup-phone"></div>
            <div class="form-group"><label>Email</label><input type="email" id="sup-email"></div>
            <div class="form-group"><label>Product Type</label><input type="text" id="sup-type" placeholder="e.g. Electronics, Raw Materials"></div>
            <input type="hidden" id="sup-edit-idx" value="-1">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('supplier-modal')">Cancel</button>
                <button class="btn-create" onclick="saveSupplier()">Save Supplier</button>
            </div>
        </div>
    </div>

    <div id="folder-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="folder-modal-title">Create Sub Folder</h3>
            <div class="form-group"><label>Folder Name</label><input type="text" id="f-name"></div>
            <div class="form-group">
                <label>Folder Color</label>
                <div class="color-picker" id="f-color-picker">
                    <div class="color-opt" style="background:#38bdf8" onclick="selectFolderColor('#38bdf8', this)"></div>
                    <div class="color-opt" style="background:#f87171" onclick="selectFolderColor('#f87171', this)"></div>
                    <div class="color-opt" style="background:#4ade80" onclick="selectFolderColor('#4ade80', this)"></div>
                    <div class="color-opt" style="background:#fbbf24" onclick="selectFolderColor('#fbbf24', this)"></div>
                    <div class="color-opt" style="background:#a78bfa" onclick="selectFolderColor('#a78bfa', this)"></div>
                </div>
            </div>
            <input type="hidden" id="f-parent">
            <input type="hidden" id="f-edit-id">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('folder-modal')">Cancel</button>
                <button class="btn-create" onclick="saveFolder()">Save Folder</button>
            </div>
        </div>
    </div>

    <div id="income-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="income-modal-title">Add Income Record</h3>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="income-date">
            </div>
            <div class="form-group">
                <label>Purpose</label>
                <input type="text" id="income-purpose" placeholder="e.g., Invoice Payment, Service Fee, etc.">
            </div>
            <div class="form-group">
                <label>Amount (৳)</label>
                <input type="number" id="income-amount" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="income-description" rows="2" placeholder="Additional details..."></textarea>
            </div>
            <input type="hidden" id="income-edit-id" value="-1">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('income-modal')">Cancel</button>
                <button class="btn-create" onclick="saveIncome()">Save Record</button>
            </div>
        </div>
    </div>

    <div id="expense-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="expense-modal-title">Add Expense Record</h3>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="expense-date">
            </div>
            <div class="form-group">
                <label>Purpose</label>
                <input type="text" id="expense-purpose" placeholder="e.g., Office Supplies, Utilities, etc.">
            </div>
            <div class="form-group">
                <label>Amount (৳)</label>
                <input type="number" id="expense-amount" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="expense-description" rows="2" placeholder="Additional details..."></textarea>
            </div>
            <input type="hidden" id="expense-edit-id" value="-1">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('expense-modal')">Cancel</button>
                <button class="btn-create" onclick="saveExpense()">Save Record</button>
            </div>
        </div>
    </div>

    <div id="workorder-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="workorder-modal-title">Add Work Order</h3>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="workorder-date">
            </div>
            <div class="form-group autocomplete-container">
                <label>Client</label>
                <input type="text" id="workorder-client" placeholder="Type client name..." onkeyup="filterClients(this)">
                <div id="client-autocomplete" class="autocomplete-suggestions"></div>
            </div>
            <div class="form-group">
                <label>Order ID</label>
                <input type="text" id="workorder-id" placeholder="e.g., WO-2024-001">
            </div>
            <div class="form-group">
                <label>Order Type</label>
                <input type="text" id="workorder-type" placeholder="e.g., Installation, Maintenance, etc.">
            </div>
            <div class="form-group">
                <label>Order Value (৳)</label>
                <input type="number" id="workorder-value" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Order Cost (৳)</label>
                <input type="number" id="workorder-cost" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="workorder-description" rows="2" placeholder="Order details..."></textarea>
            </div>
            <input type="hidden" id="workorder-edit-id" value="-1">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('workorder-modal')">Cancel</button>
                <button class="btn-create" onclick="saveWorkOrder()">Save Order</button>
            </div>
        </div>
    </div>

    <div id="action-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 280px;">
            <h3 id="action-target-id">Options</h3>
            <div class="modal-actions" style="flex-direction: column;" id="standard-actions">
                <button class="btn-download" onclick="triggerDownload('download')"><i class="fas fa-file-pdf"></i> Download PDF</button>
                <button class="btn-print" onclick="triggerDownload('print')"><i class="fas fa-print"></i> Print PDF</button>
                <div id="convert-options" style="display: none; width: 100%; flex-direction: column; gap: 10px;">
                    <button class="btn-convert" onclick="convertDoc('INVOICE')"><i class="fas fa-file-invoice"></i> Convert to Invoice</button>
                    <button class="btn-convert" onclick="convertDoc('CHALLAN')"><i class="fas fa-truck-fast"></i> Convert to Delivery Challan</button>
                </div>
                <button class="btn-create" onclick="triggerEdit()"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn-delete" onclick="triggerDelete()"><i class="fas fa-trash"></i> Delete</button>
                <button class="btn-cancel" onclick="closeModal('action-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="doc-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="doc-title">Document</h3>
            
            <div class="form-group autocomplete-container">
                <label>Client</label>
                <input type="text" id="doc-client" placeholder="Type client name..." onkeyup="showClientSuggestions(this)">
                <div id="client-suggestions" class="autocomplete-suggestions"></div>
            </div>
            
            <div class="form-group"><label>Address</label><textarea id="doc-address" rows="2" readonly></textarea></div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;"><label>ID</label><input type="text" id="doc-id" readonly></div>
                <div class="form-group" style="flex: 1;"><label>Date</label><input type="date" id="doc-date"></div>
            </div>
            <div id="tax-fields" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group"><label>VAT (%)</label><input type="number" id="doc-vat" value="0"></div>
                <div class="form-group"><label>AIT (%)</label><input type="number" id="doc-ait" value="0"></div>
            </div>
            <div id="payment-fields" style="display: none;">
                <div class="form-group"><label>Paid Amount</label><input type="number" id="doc-paid" value="0" oninput="calculateDueAmount()"></div>
            </div>
            <div id="extra-fields"></div>
            <div class="q-table-container">
                <table class="q-table">
                    <thead>
                        <tr id="doc-table-head"></tr>
                    </thead>
                    <tbody id="doc-table-body"></tbody>
                    <tfoot>
                        <tr id="doc-table-foot"></tr>
                    </tfoot>
                </table>
                <button class="btn-add-item" onclick="openItemModal()">+ Add Item</button>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('doc-modal')">Cancel</button>
                <button class="btn-create" onclick="saveDocument()">Save</button>
            </div>
        </div>
    </div>

    <div id="mr-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Money Receipt</h3>
            <div class="form-group autocomplete-container">
                <label>Received From</label>
                <input type="text" id="mr-client" placeholder="Type client name..." onkeyup="showClientSuggestions(this, 'mr')">
                <div id="mr-client-suggestions" class="autocomplete-suggestions"></div>
            </div>
            <div class="form-group"><label>Address</label><textarea id="mr-address" readonly rows="2"></textarea></div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex:1;"><label>Receipt ID</label><input type="text" id="mr-id" readonly></div>
                <div class="form-group" style="flex:1;"><label>Date</label><input type="date" id="mr-date"></div>
            </div>
            <div class="form-group"><label>Received Amount</label><input type="number" id="mr-amount" oninput="updateWords()"></div>
            <div class="form-group"><label>Amount In Words</label><input type="text" id="mr-words" readonly style="color: #4ade80; font-weight: 600;"></div>
            <div class="form-group"><label>Payment Mode</label>
                <select id="mr-mode" onchange="toggleChequeFields()">
                    <option value="Cash">Cash</option>
                    <option value="Cheque">Cheque</option>
                    <option value="Pay Order">Pay Order</option>
                    <option value="TT">TT</option>
                    <option value="Mobile Banking">Mobile Banking</option>
                </select>
            </div>
            <div id="cheque-details" style="display:none;">
                <div style="display: flex; gap:10px;">
                    <div class="form-group" style="flex:1;"><label>Cheque No.</label><input type="text" id="mr-chq-no"></div>
                    <div class="form-group" style="flex:1;"><label>Bank Name</label><input type="text" id="mr-bank"></div>
                </div>
            </div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeModal('mr-modal')">Cancel</button><button class="btn-create" onclick="saveMoneyReceipt()">Save Receipt</button></div>
        </div>
    </div>

    <div id="item-modal" class="modal-overlay" style="z-index: 1200;">
        <div class="modal-content" style="max-width: 320px;">
            <h3>Item Details</h3>
            <div class="form-group autocomplete-container">
                <label>Product</label>
                <input type="text" id="item-select" placeholder="Type product name..." onkeyup="showProductSuggestions(this)">
                <div id="product-suggestions" class="autocomplete-suggestions"></div>
            </div>
            <div class="form-group"><label>Desc</label><input type="text" id="item-desc"></div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;"><label>Qty</label><input type="number" id="item-qty"></div>
                <div class="form-group" style="flex: 1;"><label>Unit</label><input type="text" id="item-unit"></div>
            </div>
            <div class="form-group" id="item-price-field"><label>Price</label><input type="number" id="item-price"></div>
            <div class="form-group" id="item-remarks-field" style="display:none;"><label>Remarks</label><input type="text" id="item-remarks"></div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeModal('item-modal')">Back</button><button class="btn-create" onclick="addItemToList()">Add</button></div>
        </div>
    </div>

    <div id="pdf-template">
        <div id="pdf-inner-content" style="position: relative; min-height: 10.5in; font-family: Arial, sans-serif; color: #333; background: #fff; box-sizing: border-box; overflow: hidden; page-break-inside: avoid; padding-right: 15px;">
            
            <div id="pdf-top-left-box" style="position: absolute; top: 0; left: 20px; width: 40px; height: 40px; background: #0000FF; z-index: 10; transform: rotate(90deg);"></div>
            <div id="pdf-top-left-box-2" style="position: absolute; top: 20px; left: 0; width: 40px; height: 40px; background: #0000FF; z-index: 11; transform: rotate(90deg);"></div>

            <div id="pdf-footer-bottom-box" style="position: absolute; bottom: 0; right: 20px; width: 40px; height: 40px; background: #FF0000; z-index: 10;"></div>
            <div id="pdf-footer-bottom-box-2" style="position: absolute; bottom: 20px; right: 0; width: 40px; height: 40px; background: #FF0000; z-index: 11;"></div>

            <div id="pdf-logo-container" style="position: absolute; top:0px; right: 0px; text-align: right; display: none;">
                <img id="pdf-comp-logo" style="max-height: 90px; max-width: 120px;">
            </div>

            <div style="text-align: center; border-bottom: 2px solid #FF0000; padding-bottom: 8px;">
                <h1 id="pdf-comp-name" style="margin: 0; font-size: 36px; text-transform: uppercase; color: #FF0000;">FAITH ENGINEERING</h1>
                <p id="pdf-comp-addr-line" style="margin: 3px 0 2px 0; font-size: 14px; color: #0000FF; font-weight: 500;"></p>
                <p id="pdf-comp-contact-line" style="margin: 0; font-size: 14px; color: #0000FF; font-style: normal;"></p>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <h2 id="pdf-type-label" style="margin: 0; color: #0000FF; text-transform: uppercase; font-weight: 900; letter-spacing: 2px; display: inline-block; padding-bottom: 2px; font-size: 14px;">QUOTATION</h2>
            </div>

            <div id="pdf-letter-header" style="display: none; text-align: center; margin-top: 20px;">
                <h2 id="pdf-letter-title" style="margin: 0; color: #a855f7; text-transform: uppercase; font-weight: 900; letter-spacing: 1px; font-size: 16px;"></h2>
            </div>

            <div id="pdf-client-section" style="display: flex; justify-content: space-between; margin-top: 20px; align-items: flex-start; width: 98%;">
                <div style="width: 55%;">
                    <p style="margin: 0; font-size: 12px; font-weight: bold; color: #555;">To,</p>
                    <p id="pdf-client-name" style="margin: 5px 0 2px 0; font-weight: bold; font-size: 12px; color: #000;"></p>
                    <p id="pdf-client-addr" style="margin: 0; font-size: 12px; line-height: 1.3; color: #444;"></p>
                </div>
                <div style="width: 43%; display: flex; flex-direction: column; align-items: flex-end;">
                    <table style="font-size: 12px; border-collapse: collapse; min-width: 180px;">
                        <tr>
                            <td style="font-weight: bold; padding: 2px 10px 2px 0; text-align: left; width: 40%;">No.</td>
                            <td id="pdf-id" style="padding: 2px 0; text-align: left;"></td>
                        </tr>
                        <tr>
                            <td style="font-weight: bold; padding: 2px 10px 2px 0; text-align: left;">Date:</td>
                            <td id="pdf-date" style="padding: 2px 0; text-align: left;"></td>
                        </tr>
                        <tr id="pdf-order-row" style="display:none;">
                            <td id="pdf-ref-label" style="font-weight: bold; padding: 2px 10px 2px 0; text-align: left;">Order No:</td>
                            <td id="pdf-order-id" style="padding: 2px 0; text-align: left;"></td>
                        </tr>
                        <tr id="pdf-gate-row" style="display:none;">
                            <td style="font-weight: bold; padding: 2px 10px 2px 0; text-align: left;">Gate Pass:</td>
                            <td id="pdf-gate-id" style="padding: 2px 0; text-align: left;"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div id="pdf-subject-container" style="margin-top: 15px; font-size: 12px; display: none; border-top: 1px dashed #eee; padding-top: 10px; width: 98%;">
                <strong>Subject:</strong> <span id="pdf-subject-text" style="font-weight: bold; font-size: 12px;"></span>
            </div>

            <div id="pdf-letter-content" style="display: none; margin-top: 25px; width: 98%;">
                <div id="pdf-letter-text" style="font-size: 12px; line-height: 1.6; text-align: justify; margin-bottom: 20px;"></div>
            </div>

            <div id="pdf-mr-container" style="display:none; margin-top: 25px; width: 98%;">
                <div style="border: 2px solid #0000FF; padding: 20px; border-radius: 5px; margin-bottom: 20px; width: 100%; box-sizing: border-box;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 11px; margin-bottom: 10px;">
                            <strong>Received From:</strong> <span id="pdf-mr-client-name" style="font-weight: 700;"></span>
                        </div>
                        <div style="font-size: 11px;">
                            <strong>Address:</strong> <span id="pdf-mr-client-addr"></span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px; font-size: 11px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div><strong>Receipt No:</strong> <span id="pdf-mr-id" style="color: #FF0000; font-weight: 700;"></span></div>
                            <div><strong>Date:</strong> <span id="pdf-mr-date"></span></div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Payment Mode:</strong> <span id="pdf-mr-mode"></span>
                        </div>
                        <div id="pdf-mr-extra" style="font-size: 10px; margin-bottom: 15px;"></div>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0; padding: 20px; background: rgba(255, 0, 0, 0.05); border: 1px solid #FF0000; border-radius: 5px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; font-weight: 700; color: #0000FF; text-transform: uppercase;">Amount Received</p>
                        <p style="margin: 0; font-size: 28px; font-weight: 900; color: #FF0000; letter-spacing: 1px;"><span id="pdf-mr-curr">৳</span> <span id="pdf-mr-amount"></span></p>
                        <div style="height: 2px; width: 200px; background: linear-gradient(90deg, #FF0000, #0000FF); margin: 15px auto; border-radius: 2px;"></div>
                        <p style="margin: 15px 0 0 0; font-size: 11px; font-weight: 600; color: #555;">In Words:</p>
                        <p id="pdf-mr-words-text" style="margin: 8px 0; font-size: 11px; font-weight: 600; color: #000; line-height: 1.3;"></p>
                    </div>
                    
                    <div style="margin-top: 25px; border-top: 1px solid #888; padding-top: 15px; font-size: 11px; color: #555; text-align: center;">
                        <p style="margin: 5px 0;">Thank you for your payment</p>
                        <p style="margin: 5px 0; font-size: 10px; font-style: italic;">This is a computer generated receipt</p>
                    </div>
                </div>
            </div>

            <div id="pdf-standard-table">
                <table style="width: 98%; border-collapse: collapse; margin-top: 20px; border: 1px solid #ddd; box-sizing: border-box;">
                    <thead id="pdf-table-head-container" style="font-size: 11px;"></thead>
                    <tbody id="pdf-table-body" style="font-size: 10px;"></tbody>
                    <tfoot id="pdf-table-foot-container" style="font-size: 11px;"></tfoot>
                </table>
            </div>

            <div id="pdf-words-container" style="margin-top: 20px; font-size: 11px; width: 98%;">
                <strong>Amount in words:</strong> <span id="pdf-grand-words" style="font-style: normal;"></span>
            </div>

            <div id="pdf-terms-section" style="margin-top: 15px; font-size: 11px; width: 98%;">
                <strong>Terms & Conditions:</strong>
                <div id="pdf-terms" style="white-space: pre-wrap; margin-top: 5px; line-height: 1.4; color: #555; font-size: 11px;"></div>
            </div>
            
            <div id="pdf-seal-container" style="margin-top: 20px; text-align: center; display: none;">
                <img id="pdf-seal" style="max-height: 85px; max-width: 85px;">
            </div>
            
            <div style="margin-top: 40px; display: flex; justify-content: space-between; align-items: flex-end; font-size: 11px; width: 98%;">
                <div id="pdf-receiver-section" style="text-align: center; visibility: hidden;">
                    <div style="height: 50px; display: flex; align-items: center; justify-content: center;"></div>
                    <div style="border-top: 1px solid #999; width: 140px; padding-top: 5px; font-size: 11px;">Receiver Signature</div>
                </div>
                <div style="text-align: center;">
                    <div style="min-height: 45px; display: flex; align-items: flex-end; justify-content: center; margin-bottom: 5px;">
                        <img id="pdf-auth-sig" style="max-height: 45px; display:none;">
                    </div>
                    <div style="border-top: 1px solid #999; width: 160px; margin: 0 auto; padding-top: 5px;">
                        <div style="text-align: center;">
                            <p style="margin:0; font-weight:bold; font-size:11px; line-height: 1.3;">For <span id="pdf-for-comp">FAITH ENGINEERING</span></p>
                            <p id="pdf-sig-name" style="margin:0; font-size:11px; line-height: 1.3;"></p>
                            <p id="pdf-sig-desig" style="margin:0; font-size:11px; line-height: 1.3; color: #555;"></p>
                        </div>
                    </div>
                </div>

            <div id="pdf-footer-wrapper" style="position: absolute; bottom: 0; left: 0; right: 0; text-align: center; padding-right: 15px;">
                <div style="font-size: 12px; color: #0000FF; font-weight: bold; text-transform: uppercase; border-top: 2px solid #00FF00; padding-top: 10px; width: 70%; margin: 0 auto;" id="pdf-footer-slogan"></div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== AUTHENTICATION FUNCTIONS ====================
        function checkAuth() {
    const id = document.getElementById('login-id').value;
    const pass = document.getElementById('login-pass').value;
    const error = document.getElementById('login-error');

    if (id === 'jakaria' && pass === '106984') {
        // CHANGE THIS line from sessionStorage to localStorage
        localStorage.setItem('fe_auth', 'true'); 
        document.getElementById('login-overlay').style.display = 'none';
        error.style.display = 'none';
    } else {
        error.style.display = 'block';
    }
}

        function logout() {
    // CHANGE THIS line from sessionStorage to localStorage
    localStorage.removeItem('fe_auth');
    location.reload();
}

        // Run on load
(function initAuth() {
    // CHANGE THIS line from sessionStorage to localStorage
    if (localStorage.getItem('fe_auth') === 'true') {
        document.getElementById('login-overlay').style.display = 'none';
    }
})();

        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBV_Ph0Xx1f8C7vNbv-q5mErDhDkxncnkE",
            authDomain: "faithengineering-7f75b.firebaseapp.com",
            databaseURL: "https://faithengineering-7f75b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "faithengineering-7f75b",
            storageBucket: "faithengineering-7f75b.firebasestorage.app",
            messagingSenderId: "333974275134",
            appId: "1:333974275134:web:3eedb2a82ab7aca8f93d6f",
            measurementId: "G-98RSMZ9H22"
        };

        // Initialize Firebase
        let app;
        let database;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // Create a mock database object if Firebase fails
            database = {
                ref: (path) => ({
                    set: () => Promise.resolve(),
                    get: () => Promise.resolve({ val: () => null }),
                    once: () => Promise.resolve({ val: () => null }),
                    push: () => ({ key: Date.now().toString(), set: () => Promise.resolve() }),
                    remove: () => Promise.resolve(),
                    off: () => {},
                    on: (event, callback) => {
                        // Mock listener
                        setTimeout(() => callback({ val: () => null }), 100);
                    }
                })
            };
        }

        class FirebaseStorage {
            constructor() {
                this.db = database;
                this.userId = 'default_user';
                this.rootPath = 'faithengineering';
                this.initialized = false;
                this.testConnection();
            }
            
            async testConnection() {
                try {
                    const testRef = this.db.ref(this.getPath('test'));
                    await testRef.set({ test: Date.now() });
                    this.initialized = true;
                    console.log("Firebase connection test successful");
                } catch (error) {
                    console.warn("Firebase connection failed, using localStorage only");
                    this.initialized = false;
                }
            }
            
            getPath(key) {
                return `${this.rootPath}/${this.userId}/${key}`;
            }
            
            async save(key, value) {
                try {
                    const path = this.getPath(key);
                    console.log("Saving to Firebase:", key, value);
                    
                    // Always save to localStorage first
                    localStorage.setItem(`fe_${key}`, JSON.stringify(value));
                    
                    // Try to save to Firebase if initialized
                    if (this.initialized) {
                        await this.db.ref(path).set(value);
                        console.log('Data saved to Firebase successfully');
                    }
                    return true;
                } catch (error) {
                    console.error('Firebase save error, using localStorage only:', error);
                    localStorage.setItem(`fe_${key}`, JSON.stringify(value));
                    return false;
                }
            }
            
            async get(key) {
                try {
                    // Always check localStorage first for speed
                    const localData = localStorage.getItem(`fe_${key}`);
                    let data = localData ? JSON.parse(localData) : null;
                    
                    // Try to get from Firebase if initialized
                    if (this.initialized) {
                        const path = this.getPath(key);
                        const snapshot = await this.db.ref(path).once('value');
                        const firebaseData = snapshot.val();
                        
                        if (firebaseData !== null) {
                            // Update localStorage with Firebase data
                            localStorage.setItem(`fe_${key}`, JSON.stringify(firebaseData));
                            return firebaseData;
                        } else if (data === null) {
                            // Check if data exists in old path (for backward compatibility)
                            const oldPath = `${this.rootPath}/${key}`;
                            const oldSnapshot = await this.db.ref(oldPath).once('value');
                            const oldData = oldSnapshot.val();
                            
                            if (oldData !== null) {
                                // Migrate to new path
                                await this.save(key, oldData);
                                return oldData;
                            }
                        }
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Firebase get error, using localStorage:', error);
                    const localData = localStorage.getItem(`fe_${key}`);
                    return localData ? JSON.parse(localData) : null;
                }
            }
            
            async remove(key) {
                try {
                    localStorage.removeItem(`fe_${key}`);
                    
                    if (this.initialized) {
                        const path = this.getPath(key);
                        await this.db.ref(path).remove();
                    }
                    return true;
                } catch (error) {
                    console.error('Firebase remove error:', error);
                    localStorage.removeItem(`fe_${key}`);
                    return false;
                }
            }
            
            listen(key, callback) {
                // Always load from localStorage first
                const localData = localStorage.getItem(`fe_${key}`);
                if (localData) {
                    try {
                        callback(JSON.parse(localData));
                    } catch (e) {
                        callback(null);
                    }
                }
                
                // Set up Firebase listener if initialized
                if (this.initialized) {
                    try {
                        const path = this.getPath(key);
                        this.db.ref(path).on('value', (snapshot) => {
                            const data = snapshot.val();
                            if (data !== null) {
                                localStorage.setItem(`fe_${key}`, JSON.stringify(data));
                                callback(data);
                            }
                        });
                    } catch (error) {
                        console.error('Firebase listener error:', error);
                    }
                }
            }
            
            stopListening(key) {
                if (this.initialized) {
                    try {
                        const path = this.getPath(key);
                        this.db.ref(path).off();
                    } catch (error) {
                        console.error('Firebase stop listening error:', error);
                    }
                }
            }
            
            async push(key, value) {
                try {
                    // Get current data
                    const currentData = await this.get(key) || [];
                    
                    // Add new item
                    currentData.push(value);
                    
                    // Save the updated array
                    await this.save(key, currentData);
                    
                    return currentData.length - 1; // Return index
                } catch (error) {
                    console.error('Firebase push error:', error);
                    const data = await this.get(key) || [];
                    data.push(value);
                    await this.save(key, data);
                    return data.length - 1;
                }
            }
            
            async updateItem(key, index, value) {
                try {
                    const data = await this.get(key) || [];
                    if (index >= 0 && index < data.length) {
                        data[index] = value;
                        await this.save(key, data);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Firebase updateItem error:', error);
                    return false;
                }
            }
            
            async removeItem(key, index) {
                try {
                    const data = await this.get(key) || [];
                    if (index >= 0 && index < data.length) {
                        data.splice(index, 1);
                        await this.save(key, data);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Firebase removeItem error:', error);
                    return false;
                }
            }
        }

        // Create global Storage instance
        const Storage = new FirebaseStorage();

        // ==================== GLOBAL VARIABLES ====================
        let currentDocType = '';
        let docItems = [];
        let selectedDocId = null;
        let selectedFolderColor = '#38bdf8';
        let selectedCategoryColor = '#38bdf8';
        let selectedTabCategoryColor = '#38bdf8';
        let currentActiveFolderId = null;
        let currentTabCategoryParent = '';
        let currentFileFolderContext = null;
        let currentPreviewFile = null;
        let selectedFiles = [];

        const MASTER_LIST_FOLDER_ID = 'master-list-products';

        // UPDATED VIEW NAME MAP WITH CORRECTED TITLES
        const viewNameMap = {
            'main-menu': 'Home',
            'inventory-view': 'Stock Inventory',
            'products-menu': 'Products Catalog',
            'category-management-view': 'Category Management',
            'folder-content-view': 'Browse Folder',
            'documents-menu': 'Documents Storage',
            'documents-category-management': 'Documents Folder Management',
            'documents-folder-files-view': 'Documents Folder',
            'projects-menu': 'Projects Management',
            'projects-category-management': 'Projects Folder Management',
            'projects-folder-files-view': 'Projects Folder',
            'clients-view': 'Client Database',
            'supplier-view': 'Supplier Records',
            'settings-view': 'System Settings',
            'commercial-menu': 'Commercial Hub',
            'folder-quotation': 'Quotation Records',
            'folder-invoice': 'Invoice Records',
            'folder-challan': 'Delivery Challans',
            'folder-po': 'Purchase Orders',
            'folder-receipt': 'Money Receipts',
            'folder-letter': 'Letter Documents',
            'accounts-menu': 'Accounts & Ledgers',
            'folder-income': 'Income Management',
            'folder-expense': 'Expense Tracking',
            'folder-transactions': 'Transaction History',
            'workorder-menu': 'Work Orders',
            'workorder-category-management': 'Work Order Folder Management',
            'workorder-folder-files-view': 'Work Order Folder',
            'folder-workorder-summary': 'Work Order Summary'
        };

        // ==================== UTILITY FUNCTIONS ====================
        function openView(id) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            
            const indicator = document.getElementById('active-view-indicator');
            const viewName = viewNameMap[id] || 'Viewing';
            indicator.innerText = viewName;
            indicator.style.display = (id === 'main-menu') ? 'none' : 'inline-block';
            document.querySelectorAll('.quick-search').forEach(input => input.value = '');
            
            // Load appropriate data for the view
            loadViewData(id);
        }

        function loadViewData(id) {
            const loaders = {
                'settings-view': loadSettings,
                'clients-view': renderClients,
                'supplier-view': renderSuppliers,
                'inventory-view': renderInventory,
                'products-menu': () => renderFolders('products-menu'),
                'documents-menu': () => renderTabFolders('documents-menu'),
                'projects-menu': () => renderTabFolders('projects-menu'),
                'workorder-menu': () => renderTabFolders('workorder-menu'),
                'category-management-view': renderCategories,
                'documents-category-management': () => renderTabCategories('documents'),
                'projects-category-management': () => renderTabCategories('projects'),
                'workorder-category-management': () => renderTabCategories('workorder'),
                'folder-content-view': () => {
                    if(currentActiveFolderId === MASTER_LIST_FOLDER_ID) renderMasterProducts();
                    else renderFolderProducts();
                },
                'folder-income': renderIncome,
                'folder-expense': renderExpense,
                'folder-transactions': renderTransactions,
                'folder-workorder-summary': renderWorkOrders,
                'documents-folder-files-view': () => renderFolderFiles('documents'),
                'projects-folder-files-view': () => renderFolderFiles('projects'),
                'workorder-folder-files-view': () => renderFolderFiles('workorder'),
                'folder-letter': renderLetterFolder,
                // FIX: Add commercial folder renderers
                'folder-quotation': () => renderCommercialFolder('QUOTATION'),
                'folder-invoice': () => renderCommercialFolder('INVOICE'),
                'folder-challan': () => renderCommercialFolder('CHALLAN'),
                'folder-po': () => renderCommercialFolder('PO'),
                'folder-receipt': () => renderCommercialFolder('RECEIPT')
            };

            if (loaders[id]) loaders[id]();
        }

        function closeModal(id) { 
            document.getElementById(id).style.display = 'none'; 
        }

        function quickFilterTable(tableId, query) {
            const tbody = document.getElementById(tableId);
            if (!tbody) return;
            const rows = tbody.getElementsByTagName('tr');
            const term = query.toLowerCase();
            for (let i = 0; i < rows.length; i++) {
                const text = rows[i].innerText.toLowerCase();
                rows[i].style.display = text.includes(term) ? '' : 'none';
            }
        }

        function toggleSection(header) {
            const section = header.parentElement;
            const isOpen = section.classList.contains('open');
            document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('open'));
            if (!isOpen) section.classList.add('open');
        }

        // ==================== IMAGE MANAGEMENT ====================
        function deleteImage(storageKey, previewId) {
            if (!confirm('Are you sure you want to delete this image?')) return;
            localStorage.removeItem(storageKey);
            const preview = document.getElementById(previewId);
            if (preview) {
                preview.src = '';
                preview.style.display = 'none';
            }
            const deleteBtn = preview?.parentElement.querySelector('.delete-img-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            alert('Image deleted successfully!');
        }

        function encodeImg(input, prevId, storageKey) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64 = reader.result;
                localStorage.setItem(storageKey, base64);
                const preview = document.getElementById(prevId);
                if (preview) {
                    preview.src = base64;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }

        // ==================== DATA STORAGE FUNCTIONS ====================
        async function getDocs() { 
            const docs = await Storage.get('faith_commercial_docs');
            return docs || []; 
        }
        
        async function saveDocs(docs) { 
            await Storage.save('faith_commercial_docs', docs); 
        }
        
        async function getLetterDocuments() { 
            const docs = await Storage.get('faith_letter_docs');
            return docs || []; 
        }
        
        async function saveLetterDocuments(docs) { 
            await Storage.save('faith_letter_docs', docs); 
        }
        
        async function getFolders() { 
            const folders = await Storage.get('faith_folders');
            return folders || []; 
        }
        
        async function saveFolders(data) { 
            await Storage.save('faith_folders', data); 
        }
        
        async function getClients() { 
            const clients = await Storage.get('faith_clients');
            return clients || []; 
        }
        
        async function saveClients(data) { 
            await Storage.save('faith_clients', data); 
        }
        
        async function getSuppliers() { 
            const suppliers = await Storage.get('faith_suppliers');
            return suppliers || []; 
        }
        
        async function saveSuppliers(data) { 
            await Storage.save('faith_suppliers', data); 
        }
        
        async function getInventoryStock() { 
            const stock = await Storage.get('faith_inventory_stock');
            return stock || {}; 
        }
        
        async function saveInventoryStock(stock) { 
            await Storage.save('faith_inventory_stock', stock); 
        }
        
        async function getIncomeRecords() { 
            const records = await Storage.get('faith_income_records');
            return records || []; 
        }
        
        async function saveIncomeRecords(records) { 
            await Storage.save('faith_income_records', records); 
        }
        
        async function getExpenseRecords() { 
            const records = await Storage.get('faith_expense_records');
            return records || []; 
        }
        
        async function saveExpenseRecords(records) { 
            await Storage.save('faith_expense_records', records); 
        }
        
        async function getWorkOrders() { 
            const orders = await Storage.get('faith_work_orders');
            return orders || []; 
        }
        
        async function saveWorkOrders(orders) { 
            await Storage.save('faith_work_orders', orders); 
        }
        
        async function getTabCategories(tabName) { 
            const categories = await Storage.get(`faith_${tabName}_categories`);
            return categories || []; 
        }
        
        async function saveTabCategories(tabName, data) { 
            await Storage.save(`faith_${tabName}_categories`, data); 
        }
        
        async function getFolderFiles(folderId, context = 'documents') { 
            const files = await Storage.get(`faith_${context}_files_${folderId}`);
            return files || []; 
        }
        
        async function saveFolderFiles(folderId, files, context = 'documents') { 
            await Storage.save(`faith_${context}_files_${folderId}`, files); 
        }

        // ==================== LETTER FUNCTIONS ====================
        async function openLetterModal(letter = null) {
            document.getElementById('letter-modal-title').innerText = letter ? 'Edit Letter' : 'Create New Letter';
            
            if (letter) {
                document.getElementById('letter-id').value = letter.id;
                document.getElementById('letter-date').value = letter.date;
                document.getElementById('letter-title').value = letter.title;
                document.getElementById('letter-text').value = letter.text;
                document.getElementById('letter-edit-id').value = letter.id;
            } else {
                const lastId = await Storage.get('last_id_LETTER') || 10049;
                document.getElementById('letter-id').value = 'FE-LTR-' + (parseInt(lastId) + 1);
                document.getElementById('letter-date').valueAsDate = new Date();
                document.getElementById('letter-title').value = '';
                document.getElementById('letter-text').value = '';
                document.getElementById('letter-edit-id').value = '';
            }
            
            document.getElementById('letter-modal').style.display = 'flex';
        }

        async function saveLetter() {
            const letterData = {
                id: document.getElementById('letter-id').value,
                date: document.getElementById('letter-date').value,
                title: document.getElementById('letter-title').value,
                text: document.getElementById('letter-text').value,
                type: 'LETTER',
                grid: 'grid-letter'
            };
            
            const editId = document.getElementById('letter-edit-id').value;
            let letters = await getLetterDocuments();
            
            if (editId) {
                const index = letters.findIndex(l => l.id === editId);
                if (index !== -1) letters[index] = letterData;
            } else {
                letters.push(letterData);
                await Storage.save('last_id_LETTER', letterData.id.split('-').pop());
                renderCard('grid-letter', letterData.id, '#a855f7', 'fa-envelope');
            }
            
            await saveLetterDocuments(letters);
            closeModal('letter-modal');
        }

        async function renderLetterFolder() {
            const grid = document.getElementById('grid-letter');
            if(!grid) return;
            const header = grid.querySelector('.nav-header');
            grid.innerHTML = '';
            if(header) grid.appendChild(header);
            
            const letters = await getLetterDocuments();
            letters.forEach(letter => {
                renderCard('grid-letter', letter.id, '#a855f7', 'fa-envelope');
            });
        }

        async function editLetter(letterId) {
            const letters = await getLetterDocuments();
            const letter = letters.find(l => l.id === letterId);
            if (letter) openLetterModal(letter);
        }

        async function deleteLetter(letterId) {
            if (!confirm('Delete this letter?')) return;
            let letters = await getLetterDocuments();
            letters = letters.filter(l => l.id !== letterId);
            await saveLetterDocuments(letters);
            const card = document.getElementById('card-' + letterId);
            if (card) card.remove();
        }

        // ==================== FILE MANAGEMENT - UPDATED ====================
        function triggerFileUpload(context = 'documents') {
            const fileInput = document.getElementById(`${context}-file-input`);
            if (fileInput) {
                fileInput.click();
            }
        }

        function handleFileSelection(files, context = 'documents') {
            if (files.length > 0) {
                selectedFiles = Array.from(files);
                showFileUploadForm(context);
            }
        }

        function showFileUploadForm(context = 'documents') {
            const form = document.getElementById(`${context}-file-upload-form`);
            const fileNameInput = document.getElementById(`${context}-file-name`);
            
            if (form && fileNameInput) {
                form.classList.add('active');
                if (selectedFiles.length === 1) {
                    const fileNameWithoutExt = selectedFiles[0].name.split('.').slice(0, -1).join('.');
                    fileNameInput.value = fileNameWithoutExt;
                } else {
                    fileNameInput.value = '';
                }
            }
        }

        function cancelFileUpload(context = 'documents') {
            const form = document.getElementById(`${context}-file-upload-form`);
            const fileInput = document.getElementById(`${context}-file-input`);
            
            if (form) form.classList.remove('active');
            if (fileInput) fileInput.value = '';
            selectedFiles = [];
        }

        async function uploadFile(context = 'documents') {
            if (selectedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }

            const fileNameInput = document.getElementById(`${context}-file-name`);
            const fileDescriptionInput = document.getElementById(`${context}-file-description`);
            
            if (!fileNameInput || !fileDescriptionInput) {
                alert('Error: File upload form not properly initialized');
                return;
            }

            const customFileName = fileNameInput.value.trim();
            const fileDescription = fileDescriptionInput.value.trim();
            const folderId = currentFileFolderContext?.folderId;
            
            if (!folderId) {
                alert('Error: No folder selected');
                return;
            }

            const filesData = await getFolderFiles(folderId, context);
            
            // Show uploading progress
            const uploadStatus = document.createElement('div');
            uploadStatus.style.cssText = 'background: rgba(56, 189, 248, 0.1); border: 1px solid var(--accent-blue); border-radius: 10px; padding: 10px; margin-top: 10px; text-align: center; font-size: 0.8rem;';
            uploadStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Uploading ${selectedFiles.length} file(s)...`;
            document.querySelector(`#${context}-file-upload-container`).appendChild(uploadStatus);
            
            try {
                for (let index = 0; index < selectedFiles.length; index++) {
                    const file = selectedFiles[index];
                    
                    // Process file without reading entire content for large files
                    const fileData = {
                        id: Date.now() + index,
                        name: customFileName || file.name.split('.').slice(0, -1).join('.'),
                        originalName: file.name,
                        type: file.type,
                        size: file.size,
                        sizeFormatted: formatFileSize(file.size),
                        description: fileDescription,
                        // Store file as object URL instead of base64 for faster processing
                        data: URL.createObjectURL(file),
                        uploaded: new Date().toISOString(),
                        extension: file.name.split('.').pop().toLowerCase(),
                        fileObject: file // Store the file object for later use
                    };
                    
                    filesData.push(fileData);
                    
                    // Update progress
                    uploadStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Uploading file ${index + 1} of ${selectedFiles.length}...`;
                }
                
                await saveFolderFiles(folderId, filesData, context);
                uploadStatus.innerHTML = `<i class="fas fa-check" style="color: #4ade80;"></i> Successfully uploaded ${selectedFiles.length} file(s)`;
                
                setTimeout(() => {
                    uploadStatus.remove();
                }, 2000);
                
            } catch (error) {
                uploadStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Error uploading files`;
                console.error('Upload error:', error);
            }
            
            cancelFileUpload(context);
            selectedFiles = [];
            renderFolderFiles(context);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function renderFolderFiles(context = 'documents') {
            const grid = document.getElementById(`${context}-files-grid`);
            const folderId = currentFileFolderContext?.folderId;
            
            if (!grid || !folderId) return;
            
            const files = await getFolderFiles(folderId, context);
            grid.innerHTML = '';
            
            if (files.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: span 2;">
                        <i class="fas fa-file-upload"></i>
                        <p>No files uploaded yet</p>
                        <p style="font-size: 0.7rem; margin-top: 10px;">Upload your first file to get started</p>
                    </div>
                `;
                return;
            }
            
            files.sort((a, b) => new Date(b.uploaded) - new Date(a.uploaded));
            
            files.forEach(file => {
                const fileType = getFileType(file.extension, file.type);
                const fileIcon = getFileIcon(fileType);
                const fileCard = document.createElement('div');
                fileCard.className = 'file-card';
                
                fileCard.innerHTML = `
                    <div class="file-icon" style="color: ${getFileTypeColor(fileType)}">
                        <i class="${fileIcon}"></i>
                    </div>
                    <div class="file-name" title="${file.name}">${file.name}</div>
                    <div class="file-size">${file.sizeFormatted}</div>
                    <span class="file-type-badge file-type-${fileType}">${file.extension.toUpperCase()}</span>
                    <div class="file-actions">
                        <button class="file-btn preview-btn" onclick="previewFile('${context}', ${file.id})">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button class="file-btn download-btn" onclick="downloadFile('${context}', ${file.id})">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="file-btn delete-file-btn" onclick="deleteFile('${context}', ${file.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                grid.appendChild(fileCard);
            });
        }

        function getFileType(extension, mimeType) {
            const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const pdfTypes = ['pdf'];
            const docTypes = ['doc', 'docx', 'rtf'];
            const excelTypes = ['xls', 'xlsx', 'csv'];
            const textTypes = ['txt', 'xml', 'json', 'hse'];
            
            if (imageTypes.includes(extension)) return 'image';
            if (pdfTypes.includes(extension)) return 'pdf';
            if (docTypes.includes(extension)) return 'doc';
            if (excelTypes.includes(extension)) return 'excel';
            if (textTypes.includes(extension)) return 'text';
            return 'other';
        }

        function getFileIcon(fileType) {
            const icons = {
                'image': 'fas fa-file-image',
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'excel': 'fas fa-file-excel',
                'text': 'fas fa-file-alt',
                'other': 'fas fa-file'
            };
            return icons[fileType] || 'fas fa-file';
        }

        function getFileTypeColor(fileType) {
            const colors = {
                'image': '#38bdf8',
                'pdf': '#ef4444',
                'doc': '#2563eb',
                'excel': '#22c55e',
                'text': '#a855f7',
                'other': '#fbbf24'
            };
            return colors[fileType] || '#fbbf24';
        }

        function filterFiles(query, context = 'documents') {
            const files = document.querySelectorAll(`#${context}-files-grid .file-card`);
            const term = query.toLowerCase();
            
            files.forEach(file => {
                const fileName = file.querySelector('.file-name').textContent.toLowerCase();
                file.style.display = fileName.includes(term) ? 'block' : 'none';
            });
        }

        async function previewFile(context, fileId) {
            const folderId = currentFileFolderContext?.folderId;
            const files = await getFolderFiles(folderId, context);
            const file = files.find(f => f.id == fileId);
            
            if (!file) {
                alert('File not found');
                return;
            }
            
            currentPreviewFile = { ...file, context, folderId };
            document.getElementById('file-preview-title').innerText = file.name;
            const previewContainer = document.getElementById('file-preview-container');
            previewContainer.innerHTML = '';
            
            const fileType = getFileType(file.extension, file.type);
            
            // For large files, show a loading message
            previewContainer.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--accent-blue); margin-bottom: 15px;"></i>
                    <p>Loading file preview...</p>
                </div>
            `;
            
            // Load file preview in background
            setTimeout(() => {
                try {
                    switch(fileType) {
                        case 'image':
                            previewContainer.innerHTML = `
                                <img src="${file.data}" class="file-preview-img" alt="${file.name}">
                                <div style="margin-top: 10px;">
                                    <p><strong>Size:</strong> ${file.sizeFormatted}</p>
                                    <p><strong>Uploaded:</strong> ${new Date(file.uploaded).toLocaleDateString()}</p>
                                    ${file.description ? `<p><strong>Description:</strong> ${file.description}</p>` : ''}
                                </div>
                            `;
                            break;
                            
                        case 'pdf':
                            previewContainer.innerHTML = `
                                <iframe src="${file.data}" class="file-preview-pdf"></iframe>
                                <div style="margin-top: 10px;">
                                    <p><strong>Size:</strong> ${file.sizeFormatted}</p>
                                    <p><strong>Uploaded:</strong> ${new Date(file.uploaded).toLocaleDateString()}</p>
                                    ${file.description ? `<p><strong>Description:</strong> ${file.description}</p>` : ''}
                                </div>
                            `;
                            break;
                            
                        case 'text':
                            // For text files, try to read content if available
                            if (file.fileObject) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    previewContainer.innerHTML = `
                                        <div class="file-preview-text">${e.target.result}</div>
                                        <div style="margin-top: 10px;">
                                            <p><strong>Size:</strong> ${file.sizeFormatted}</p>
                                            <p><strong>Uploaded:</strong> ${new Date(file.uploaded).toLocaleDateString()}</p>
                                            ${file.description ? `<p><strong>Description:</strong> ${file.description}</p>` : ''}
                                        </div>
                                    `;
                                };
                                reader.readAsText(file.fileObject);
                            } else {
                                previewContainer.innerHTML = `
                                    <div class="file-preview-placeholder">
                                        <i class="${getFileIcon(fileType)}"></i>
                                        <p>Preview not available for this text file</p>
                                        <p>Please download the file to view its contents</p>
                                        <div style="margin-top: 10px;">
                                            <p><strong>File Type:</strong> ${file.extension.toUpperCase()}</p>
                                            <p><strong>Size:</strong> ${file.sizeFormatted}</p>
                                            <p><strong>Uploaded:</strong> ${new Date(file.uploaded).toLocaleDateString()}</p>
                                            ${file.description ? `<p><strong>Description:</strong> ${file.description}</p>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                            break;
                            
                        default:
                            previewContainer.innerHTML = `
                                <div class="file-preview-placeholder">
                                    <i class="${getFileIcon(fileType)}"></i>
                                    <p>Preview not available for this file type</p>
                                    <p>Please download the file to view its contents</p>
                                    <div style="margin-top: 10px;">
                                        <p><strong>File Type:</strong> ${file.extension.toUpperCase()}</p>
                                        <p><strong>Size:</strong> ${file.sizeFormatted}</p>
                                        <p><strong>Uploaded:</strong> ${new Date(file.uploaded).toLocaleDateString()}</p>
                                        ${file.description ? `<p><strong>Description:</strong> ${file.description}</p>` : ''}
                                    </div>
                                </div>
                            `;
                    }
                } catch (e) {
                    previewContainer.innerHTML = `
                        <div class="file-preview-placeholder">
                            <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                            <p>Error loading preview</p>
                            <p>The file may be too large or in an unsupported format</p>
                        </div>
                    `;
                }
            }, 100);
            
            document.getElementById('file-preview-modal').style.display = 'flex';
        }

        async function deletePreviewedFile() {
            if (currentPreviewFile && confirm('Are you sure you want to delete this file?')) {
                await deleteFile(currentPreviewFile.context, currentPreviewFile.id);
                closeModal('file-preview-modal');
            }
        }

        async function deleteFile(context, fileId) {
            const folderId = currentFileFolderContext?.folderId;
            if (!folderId) return;
            
            if (!confirm('Are you sure you want to delete this file?')) return;
            
            const files = await getFolderFiles(folderId, context);
            const fileIndex = files.findIndex(f => f.id == fileId);
            
            if (fileIndex === -1) {
                alert('File not found');
                return;
            }
            
            // Clean up object URL if it exists
            if (files[fileIndex].data && files[fileIndex].data.startsWith('blob:')) {
                try {
                    URL.revokeObjectURL(files[fileIndex].data);
                } catch (e) {
                    console.warn('Error revoking object URL:', e);
                }
            }
            
            files.splice(fileIndex, 1);
            await saveFolderFiles(folderId, files, context);
            renderFolderFiles(context);
            
            if (currentPreviewFile && currentPreviewFile.id == fileId) {
                closeModal('file-preview-modal');
            }
        }

        function downloadPreviewedFile() {
            if (currentPreviewFile) {
                downloadFile(currentPreviewFile.context, currentPreviewFile.id);
            }
        }

        async function downloadFile(context, fileId) {
            const folderId = currentFileFolderContext?.folderId;
            const files = await getFolderFiles(folderId, context);
            const file = files.find(f => f.id == fileId);
            
            if (!file) {
                alert('File not found');
                return;
            }
            
            try {
                // If we have the file object, use it directly
                if (file.fileObject) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(file.fileObject);
                    link.download = file.originalName || file.name + '.' + file.extension;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                } 
                // If we have a blob URL, fetch and download
                else if (file.data && file.data.startsWith('blob:')) {
                    const response = await fetch(file.data);
                    const blob = await response.blob();
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = file.originalName || file.name + '.' + file.extension;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                } 
                // Fallback to data URL
                else if (file.data) {
                    const link = document.createElement('a');
                    link.href = file.data;
                    link.download = file.originalName || file.name + '.' + file.extension;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    throw new Error('No file data available');
                }
                
                closeModal('file-preview-modal');
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading file. Please try again.');
            }
        }

        function openFolderFilesView(folder, context = 'documents') {
            currentFileFolderContext = {
                folderId: folder.id,
                folderName: folder.name,
                context: context
            };
            
            const viewMap = {
                'documents': {
                    viewId: 'documents-folder-files-view',
                    backBtnId: 'documents-folder-back-btn',
                    titleId: 'documents-folder-title'
                },
                'projects': {
                    viewId: 'projects-folder-files-view',
                    backBtnId: 'projects-folder-back-btn',
                    titleId: 'projects-folder-title'
                },
                'workorder': {
                    viewId: 'workorder-folder-files-view',
                    backBtnId: 'workorder-folder-back-btn',
                    titleId: 'workorder-folder-title'
                }
            };
            
            const config = viewMap[context];
            if (!config) return;
            
            document.getElementById(config.backBtnId).onclick = () => {
                if (context === 'documents') openView('documents-menu');
                else if (context === 'projects') openView('projects-menu');
                else if (context === 'workorder') openView('workorder-menu');
            };
            
            document.getElementById(config.titleId).innerHTML = `<i class="fas fa-folder" style="color:${folder.color}"></i> ${folder.name}`;
            openView(config.viewId);
        }

        // ==================== CATEGORY MANAGEMENT ====================
        function openCategoryModal(category = null) {
            document.getElementById('category-modal-title').innerText = category ? 'Edit Category' : 'Create New Category';
            document.getElementById('category-name').value = category ? category.name : '';
            document.getElementById('category-edit-id').value = category ? category.id : '';
            
            document.querySelectorAll('.color-opt').forEach(opt => opt.classList.remove('selected'));
            
            if (category) {
                document.querySelectorAll('.color-opt').forEach(opt => {
                    if (opt.style.background === category.color || opt.style.backgroundColor === category.color) {
                        opt.classList.add('selected');
                        selectedCategoryColor = category.color;
                    }
                });
            } else {
                const firstColorOpt = document.querySelector('.color-opt');
                if (firstColorOpt) {
                    firstColorOpt.classList.add('selected');
                    selectedCategoryColor = '#38bdf8';
                }
            }
            
            document.getElementById('category-modal').style.display = 'flex';
        }

        function selectCategoryColor(color, el) {
            selectedCategoryColor = color;
            document.querySelectorAll('.color-opt').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        async function saveCategory() {
            const name = document.getElementById('category-name').value;
            const editId = document.getElementById('category-edit-id').value;
            
            if (!name) {
                alert('Please enter a category name');
                return;
            }
            
            let categories = await getFolders();
            
            if (editId) {
                const index = categories.findIndex(c => c.id == editId);
                if (index !== -1) {
                    categories[index].name = name;
                    categories[index].color = selectedCategoryColor;
                }
            } else {
                const newCategory = {
                    id: Date.now(),
                    name: name,
                    color: selectedCategoryColor,
                    parent: 'products-menu'
                };
                categories.push(newCategory);
            }
            
            await saveFolders(categories);
            closeModal('category-modal');
            renderCategories();
            renderFolders('products-menu');
        }

        async function renderCategories() {
            const categoriesList = document.getElementById('categories-list');
            const categories = (await getFolders()).filter(f => f.parent === 'products-menu');
            
            if (categories.length === 0) {
                categoriesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>No categories found</p>
                        <p style="font-size: 0.7rem; margin-top: 10px;">Create your first category to organize products</p>
                    </div>
                `;
                return;
            }
            
            categoriesList.innerHTML = '';
            categories.sort((a, b) => a.name.localeCompare(b.name));
            
            for (const category of categories) {
                const categoryProducts = await Storage.get(`folder_data_${category.id}`) || [];
                const productCount = categoryProducts.length;
                
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.innerHTML = `
                    <div class="category-color" style="background: ${category.color}"></div>
                    <div class="category-name">
                        ${category.name}
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 3px;">
                            ${productCount} product${productCount !== 1 ? 's' : ''}
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="category-btn edit-btn" onclick="editCategory(${category.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="category-btn delete-btn" onclick="deleteCategory(${category.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                categoryItem.onclick = (e) => {
                    if (!e.target.closest('.category-actions')) {
                        openFolderView(category.id, category.name, 'products-menu');
                    }
                };
                
                categoriesList.appendChild(categoryItem);
            }
        }

        async function editCategory(id) {
            const categories = (await getFolders()).filter(f => f.parent === 'products-menu');
            const category = categories.find(c => c.id == id);
            if (category) openCategoryModal(category);
        }

        async function deleteCategory(id) {
            if (!confirm('Are you sure you want to delete this category? All products in this category will also be deleted.')) return;
            
            let categories = await getFolders();
            categories = categories.filter(f => f.id != id);
            await saveFolders(categories);
            await Storage.remove(`folder_data_${id}`);
            renderCategories();
            renderFolders('products-menu');
        }

        function filterCategories(query) {
            const categories = document.querySelectorAll('.category-item');
            const term = query.toLowerCase();
            
            categories.forEach(category => {
                const categoryName = category.querySelector('.category-name').textContent.toLowerCase();
                category.style.display = categoryName.includes(term) ? 'flex' : 'none';
            });
        }

        // ==================== TAB CATEGORY MANAGEMENT ====================
        function openTabCategoryModal(tabName, category = null) {
            currentTabCategoryParent = tabName;
            document.getElementById('tab-category-modal-title').innerText = category ? 'Edit Folder' : 'Create New Folder';
            document.getElementById('tab-category-name').value = category ? category.name : '';
            document.getElementById('tab-category-edit-id').value = category ? category.id : '';
            document.getElementById('tab-category-parent').value = tabName;
            
            document.querySelectorAll('#tab-category-color-picker .color-opt').forEach(opt => opt.classList.remove('selected'));
            
            if (category) {
                document.querySelectorAll('#tab-category-color-picker .color-opt').forEach(opt => {
                    if (opt.style.background === category.color || opt.style.backgroundColor === category.color) {
                        opt.classList.add('selected');
                        selectedTabCategoryColor = category.color;
                    }
                });
            } else {
                const firstColorOpt = document.querySelector('#tab-category-color-picker .color-opt');
                if (firstColorOpt) {
                    firstColorOpt.classList.add('selected');
                    selectedTabCategoryColor = '#38bdf8';
                }
            }
            
            document.getElementById('tab-category-modal').style.display = 'flex';
        }

        function selectTabCategoryColor(color, el) {
            selectedTabCategoryColor = color;
            document.querySelectorAll('#tab-category-color-picker .color-opt').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        async function saveTabCategory() {
            const name = document.getElementById('tab-category-name').value;
            const editId = document.getElementById('tab-category-edit-id').value;
            const parent = document.getElementById('tab-category-parent').value;
            
            if (!name) {
                alert('Please enter a folder name');
                return;
            }
            
            let categories = await getTabCategories(parent);
            
            if (editId) {
                const index = categories.findIndex(c => c.id == editId);
                if (index !== -1) {
                    categories[index].name = name;
                    categories[index].color = selectedTabCategoryColor;
                }
            } else {
                const newCategory = {
                    id: Date.now(),
                    name: name,
                    color: selectedTabCategoryColor,
                    parent: parent
                };
                categories.push(newCategory);
            }
            
            await saveTabCategories(parent, categories);
            closeModal('tab-category-modal');
            renderTabCategories(parent);
            renderTabFolders(parent + '-menu');
        }

        async function renderTabCategories(tabName) {
            const categoriesList = document.getElementById(`${tabName}-categories-list`);
            const categories = await getTabCategories(tabName);
            
            if (categories.length === 0) {
                categoriesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>No folders found</p>
                        <p style="font-size: 0.7rem; margin-top: 10px;">Create your first folder to organize items</p>
                    </div>
                `;
                return;
            }
            
            categoriesList.innerHTML = '';
            categories.sort((a, b) => a.name.localeCompare(b.name));
            
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.innerHTML = `
                    <div class="category-color" style="background: ${category.color}"></div>
                    <div class="category-name">${category.name}</div>
                    <div class="category-actions">
                        <button class="category-btn edit-btn" onclick="editTabCategory('${tabName}', ${category.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="category-btn delete-btn" onclick="deleteTabCategory('${tabName}', ${category.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                categoryItem.onclick = (e) => {
                    if (!e.target.closest('.category-actions')) {
                        openFolderFilesView(category, tabName);
                    }
                };
                
                categoriesList.appendChild(categoryItem);
            });
        }

        async function editTabCategory(tabName, id) {
            const categories = await getTabCategories(tabName);
            const category = categories.find(c => c.id == id);
            if (category) openTabCategoryModal(tabName, category);
        }

        async function deleteTabCategory(tabName, id) {
            if (!confirm('Are you sure you want to delete this folder? All files in this folder will also be deleted.')) return;
            
            let categories = await getTabCategories(tabName);
            categories = categories.filter(f => f.id != id);
            await saveTabCategories(tabName, categories);
            await Storage.remove(`faith_${tabName}_files_${id}`);
            renderTabCategories(tabName);
            renderTabFolders(tabName + '-menu');
        }

        function filterTabCategories(query, tabName) {
            const categories = document.querySelectorAll(`#${tabName}-categories-list .category-item`);
            const term = query.toLowerCase();
            
            categories.forEach(category => {
                const categoryName = category.querySelector('.category-name').textContent.toLowerCase();
                category.style.display = categoryName.includes(term) ? 'flex' : 'none';
            });
        }

        async function renderTabFolders(parentId) {
            const tabName = parentId.replace('-menu', '');
            const grid = document.getElementById(parentId + '-folder-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            const folders = await getTabCategories(tabName);
            folders.forEach(f => {
                const card = document.createElement('div');
                card.className = "nav-card";
                card.onclick = () => openFolderFilesView(f, tabName);
                card.innerHTML = `<div class="icon-bg" style="background:${f.color}"></div><i class="fas fa-folder" style="color:${f.color}"></i><span>${f.name}</span>`;
                grid.appendChild(card);
            });
            
            if (parentId === 'workorder-menu') {
                const summaryCard = document.createElement('div');
                summaryCard.className = "nav-card";
                summaryCard.onclick = () => openView('folder-workorder-summary');
                summaryCard.innerHTML = `<div class="icon-bg" style="background:#f59e0b"></div><i class="fas fa-chart-line" style="color:#f59e0b"></i><span>Summary</span>`;
                grid.prepend(summaryCard);
            }
        }

        // ==================== PRODUCTS MANAGEMENT - FIXED DUPLICATES ====================
        async function renderFolders(parentId) {
            const grid = document.getElementById(parentId + '-folder-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            if(parentId === 'products-menu') {
                const masterCard = document.createElement('div');
                masterCard.className = "nav-card";
                masterCard.onclick = () => openFolderView(MASTER_LIST_FOLDER_ID, 'Master List', parentId);
                masterCard.innerHTML = `<div class="icon-bg" style="background:linear-gradient(45deg, #f06, #4a90e2); opacity: 0.3;"></div><i class="fas fa-layer-group" style="color:#fff;"></i><span style="font-weight: 800; color: #4ade80;">Master List</span>`;
                grid.appendChild(masterCard);
            }
            
            const folders = (await getFolders()).filter(f => f.parent === parentId);
            folders.forEach(f => {
                const card = document.createElement('div');
                card.className = "nav-card";
                card.onclick = () => openFolderView(f.id, f.name, parentId);
                card.innerHTML = `<div class="icon-bg" style="background:${f.color}"></div><i class="fas fa-folder" style="color:${f.color}"></i><span>${f.name}</span>`;
                grid.appendChild(card);
            });
        }

        function openFolderView(folderId, folderName, parentMenuId) {
            currentActiveFolderId = folderId;
            document.getElementById('folder-view-title').innerText = folderName;
            document.getElementById('folder-view-back-btn').onclick = () => openView(parentMenuId);
            const addBtn = document.getElementById('add-item-btn-container');
            const actionHeader = document.getElementById('folder-action-header');
            
            if(folderId === MASTER_LIST_FOLDER_ID) {
                addBtn.style.display = 'none';
                actionHeader.style.display = 'none';
                renderMasterProducts();
            } else {
                addBtn.style.display = 'flex';
                actionHeader.style.display = 'table-cell';
                renderFolderProducts();
            }
            openView('folder-content-view');
        }

        async function renderMasterProducts() {
            const body = document.getElementById('folder-products-table-body');
            body.innerHTML = ''; // Ensure clean slate
            
            let slNo = 1;
            const allFolders = (await getFolders()).filter(f => f.parent === 'products-menu');
            let htmlContent = '';
            
            for (const folder of allFolders) {
                const folderProducts = await Storage.get(`folder_data_${folder.id}`) || [];
                
                folderProducts.forEach(p => {
                    htmlContent += `<tr>
                        <td>${slNo++}</td>
                        <td>${p.item}</td>
                        <td>${p.desc}</td>
                        <td>${p.unit}</td>
                        <td>${p.price}</td>
                        <td style="display:none;"></td>
                    </tr>`;
                });
            }
            
            if (slNo === 1) {
                body.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color: var(--text-muted);">Master list is empty.</td></tr>';
            } else {
                body.innerHTML = htmlContent;
            }
        }


        function openProductEntryModal(existingProduct = null, idx = -1) {
            document.getElementById('p-modal-title').innerText = existingProduct ? "Edit Product Info" : "Add Product Info";
            document.getElementById('p-item').value = existingProduct ? existingProduct.item : '';
            document.getElementById('p-desc').value = existingProduct ? existingProduct.desc : '';
            document.getElementById('p-unit').value = existingProduct ? existingProduct.unit : '';
            document.getElementById('p-price').value = existingProduct ? existingProduct.price : '';
            document.getElementById('p-edit-idx').value = idx;
            document.getElementById('product-entry-modal').style.display = 'flex';
        }

        async function saveProductEntry() {
            const item = document.getElementById('p-item').value.trim();
            const desc = document.getElementById('p-desc').value.trim();
            const unit = document.getElementById('p-unit').value.trim();
            const price = document.getElementById('p-price').value;
            const editIdx = parseInt(document.getElementById('p-edit-idx').value);

            if(!item) { alert("Enter item name"); return; }
            
            const storageKey = `folder_data_${currentActiveFolderId}`;
            let data = await Storage.get(storageKey) || [];
            
            const productObj = { item, desc, unit, price };

            if(editIdx > -1) {
                data[editIdx] = productObj;
            } else {
                data.push(productObj);
            }
            
            // Save and wait for confirmation before updating UI
            await Storage.save(storageKey, data);
            closeModal('product-entry-modal');
            
            // Re-render specifically to clear any phantom rows
            renderFolderProducts();
            updateInventoryStock();
        }

        async function renderFolderProducts() {
            const body = document.getElementById('folder-products-table-body');
            // FIX 1: Explicitly clear the table before starting the loop
            body.innerHTML = '';
            
            if (currentActiveFolderId === MASTER_LIST_FOLDER_ID) {
                renderMasterProducts();
                return;
            }
            
            const storageKey = `folder_data_${currentActiveFolderId}`;
            const data = await Storage.get(storageKey) || [];
            
            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color: var(--text-muted);">No products in this folder.</td></tr>';
                return;
            }
            
            // FIX 2: Create a fresh HTML string and inject once to prevent browser redraw loops
            let htmlContent = '';
            data.forEach((p, idx) => {
                htmlContent += `<tr>
                    <td>${idx + 1}</td>
                    <td>${p.item}</td>
                    <td>${p.desc}</td>
                    <td>${p.unit}</td>
                    <td>${p.price}</td>
                    <td>
                        <button onclick="editProductEntry(${idx})" style="color:var(--accent-blue); border:none; background:none; cursor:pointer; margin-right:10px;"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteProductEntry(${idx})" style="color:#ef4444; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            body.innerHTML = htmlContent;
        }

        async function editProductEntry(idx) {
            const storageKey = `folder_data_${currentActiveFolderId}`;
            const data = await Storage.get(storageKey) || [];
            
            if (idx >= 0 && idx < data.length) {
                openProductEntryModal(data[idx], idx);
            } else {
                alert('Product not found!');
            }
        }

        async function deleteProductEntry(idx) {
            if(!confirm("Delete this entry?")) return;
            
            const storageKey = `folder_data_${currentActiveFolderId}`;
            let data = await Storage.get(storageKey) || [];
            
            if (idx >= 0 && idx < data.length) {
                data.splice(idx, 1);
                await Storage.save(storageKey, data);
                renderFolderProducts();
                
                // Also update inventory
                updateInventoryStock();
            } else {
                alert('Product not found!');
            }
        }

        async function updateInventoryStock() {
            const stock = await getInventoryStock();
            const allFolders = (await getFolders()).filter(f => f.parent === 'products-menu');
            const newStock = {};
            
            for (const folder of allFolders) {
                const folderProducts = await Storage.get(`folder_data_${folder.id}`) || [];
                folderProducts.forEach(p => {
                    // Unique key for stock tracking based on item and description
                    const stockKey = `${p.item}-${p.desc}`;
                    if (!(stockKey in newStock)) {
                        newStock[stockKey] = stock[stockKey] || 0;
                    }
                });
            }
            await saveInventoryStock(newStock);
        }
        
        async function renderManagement() {
    const s = await Storage.get('faith_settings') || {};
    const container = document.getElementById('mgmt-content-area');
    
    // Define the structure for the three leaders
    const leaders = [
        { 
            key: 'chair', 
            title: 'Chairman', 
            class: 'card-chairman',
            name: s.chairName, 
            msg: s.chairMsg, 
            sig: localStorage.getItem('data-chair-sig') 
        },
        { 
            key: 'md', 
            title: 'Managing Director', 
            class: 'card-md',
            name: s.mdName, 
            msg: s.mdMsg, 
            sig: localStorage.getItem('data-md-sig') 
        },
        { 
            key: 'dir', 
            title: 'Director', 
            class: 'card-director',
            name: s.dirName, 
            msg: s.dirMsg, 
            sig: localStorage.getItem('data-dir-sig') 
        }
    ];

    container.innerHTML = '';

    leaders.forEach(leader => {
        // Only show if a name is set in settings
        if (leader.name) {
            const card = document.createElement('div');
            card.className = `mgmt-card ${leader.class}`;
            card.innerHTML = `
                <div class="mgmt-name">${leader.name}</div>
                <div class="mgmt-desig">${leader.title}</div>
                ${leader.msg ? `<div class="mgmt-msg">"${leader.msg}"</div>` : ''}
                ${leader.sig ? `<img src="${leader.sig}" class="mgmt-sig">` : ''}
            `;
            container.appendChild(card);
        }
    });

    if (container.innerHTML === '') {
        container.innerHTML = `<div class="empty-state"><i class="fas fa-user-slash"></i><p>No management data found. Please update Executive Management info in Settings.</p></div>`;
    }
}

// Update your existing loadViewData function to include this:
// Add 'management-view': renderManagement inside the loaders object.

        // ==================== INVENTORY ====================
        async function renderInventory() {
            const body = document.getElementById('inventory-table-body');
            body.innerHTML = '';
            const stock = await getInventoryStock();
            const allFolders = (await getFolders()).filter(f => f.parent === 'products-menu');
            let allItems = [];
            
            for (const folder of allFolders) {
                const folderProducts = await Storage.get(`folder_data_${folder.id}`) || [];
                folderProducts.forEach(p => allItems.push(p));
            }
            
            if (allItems.length === 0) {
                body.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: var(--text-muted);">No products found.</td></tr>';
                return;
            }
            
            allItems.sort((a, b) => a.item.localeCompare(b.item));
            
            allItems.forEach((p, idx) => {
                const stockKey = `${p.item}-${p.desc}`;
                const currentQty = stock[stockKey] || 0;
                body.innerHTML += `<tr>
                    <td>${idx + 1}</td>
                    <td>${p.item}</td>
                    <td>${p.desc}</td>
                    <td><input type="number" class="inventory-qty-input" value="${currentQty}" onchange="updateStockQty('${stockKey}', this.value)"></td>
                </tr>`;
            });
        }

        async function updateStockQty(key, val) {
            const stock = await getInventoryStock();
            stock[key] = parseFloat(val) || 0;
            await saveInventoryStock(stock);
        }

        // ==================== CLIENTS ====================
        function openClientModal(existingClient = null, idx = -1) { 
            document.getElementById('cl-modal-title').innerText = existingClient ? "Edit Client Info" : "Client Information";
            document.getElementById('cl-name').value = existingClient ? existingClient.name : '';
            document.getElementById('cl-address').value = existingClient ? existingClient.address : '';
            document.getElementById('cl-person').value = existingClient ? existingClient.person : '';
            document.getElementById('cl-phone').value = existingClient ? existingClient.phone : '';
            document.getElementById('cl-email').value = existingClient ? existingClient.email : '';
            document.getElementById('cl-edit-idx').value = idx;
            document.getElementById('client-modal').style.display = 'flex'; 
        }
        
        async function saveClient() {
            const clients = await getClients();
            const editIdx = parseInt(document.getElementById('cl-edit-idx').value);
            const clientData = {
                name: document.getElementById('cl-name').value,
                address: document.getElementById('cl-address').value,
                person: document.getElementById('cl-person').value,
                phone: document.getElementById('cl-phone').value,
                email: document.getElementById('cl-email').value
            };
            
            if(editIdx > -1) {
                clients[editIdx] = clientData;
            } else {
                clients.push(clientData);
            }

            await saveClients(clients);
            renderClients();
            closeModal('client-modal');
        }

        async function renderClients() {
            const body = document.getElementById('clients-table-body');
            body.innerHTML = '';
            const clients = await getClients();
            
            if (clients.length === 0) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: var(--text-muted);">No clients found. Click "Add" to add clients.</td></tr>';
                return;
            }
            
            clients.forEach((c, idx) => {
                body.innerHTML += `<tr>
                    <td>${idx + 1}</td>
                    <td>${c.name}</td>
                    <td>${c.person}</td>
                    <td>${c.phone}</td>
                    <td>
                        <button onclick="editClient(${idx})" style="color:var(--accent-blue); border:none; background:none; cursor:pointer; margin-right:10px;"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteClient(${idx})" style="color:#ef4444; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        async function editClient(idx) {
            const clients = await getClients();
            openClientModal(clients[idx], idx);
        }

        async function deleteClient(idx) {
            if(!confirm("Delete client?")) return;
            const c = await getClients();
            c.splice(idx, 1);
            await saveClients(c);
            renderClients();
        }

        // ==================== SUPPLIERS ====================
        function openSupplierModal(existingSup = null, idx = -1) { 
            document.getElementById('sup-modal-title').innerText = existingSup ? "Edit Supplier Info" : "Supplier Information";
            document.getElementById('sup-org').value = existingSup ? existingSup.org : '';
            document.getElementById('sup-address').value = existingSup ? existingSup.address : '';
            document.getElementById('sup-person').value = existingSup ? existingSup.person : '';
            document.getElementById('sup-phone').value = existingSup ? existingSup.phone : '';
            document.getElementById('sup-email').value = existingSup ? existingSup.email : '';
            document.getElementById('sup-type').value = existingSup ? existingSup.type : '';
            document.getElementById('sup-edit-idx').value = idx;
            document.getElementById('supplier-modal').style.display = 'flex'; 
        }
        
        async function saveSupplier() {
            const suppliers = await getSuppliers();
            const editIdx = parseInt(document.getElementById('sup-edit-idx').value);
            const supData = {
                org: document.getElementById('sup-org').value,
                address: document.getElementById('sup-address').value,
                person: document.getElementById('sup-person').value,
                phone: document.getElementById('sup-phone').value,
                email: document.getElementById('sup-email').value,
                type: document.getElementById('sup-type').value
            };

            if(editIdx > -1) {
                suppliers[editIdx] = supData;
            } else {
                suppliers.push(supData);
            }

            await saveSuppliers(suppliers);
            renderSuppliers();
            closeModal('supplier-modal');
        }

        async function renderSuppliers() {
            const body = document.getElementById('supplier-table-body');
            body.innerHTML = '';
            const suppliers = await getSuppliers();
            
            if (suppliers.length === 0) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: var(--text-muted);">No suppliers found. Click "Add" to add suppliers.</td></tr>';
                return;
            }
            
            suppliers.forEach((s, idx) => {
                body.innerHTML += `<tr>
                    <td>${idx + 1}</td>
                    <td>${s.org}</td>
                    <td>${s.type}</td>
                    <td>${s.phone}</td>
                    <td>
                        <button onclick="editSupplier(${idx})" style="color:var(--accent-blue); border:none; background:none; cursor:pointer; margin-right:10px;"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteSupplier(${idx})" style="color:#ef4444; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        async function editSupplier(idx) {
            const suppliers = await getSuppliers();
            openSupplierModal(suppliers[idx], idx);
        }

        async function deleteSupplier(idx) {
            if(!confirm("Delete supplier?")) return;
            const s = await getSuppliers();
            s.splice(idx, 1);
            await saveSuppliers(s);
            renderSuppliers();
        }

        // ==================== SETTINGS ====================
async function loadSettings() {
    const s = await Storage.get('faith_settings') || {};
    document.getElementById('set-comp-name').value = s.compName || '';
    document.getElementById('set-comp-slogan').value = s.compSlogan || '';
    document.getElementById('set-comp-addr').value = s.compAddr || '';
    document.getElementById('set-comp-mobile').value = s.mobile || '';
    document.getElementById('set-comp-email').value = s.email || '';
    document.getElementById('set-comp-web').value = s.web || '';
    document.getElementById('set-currency').value = s.currency || '৳';
    document.getElementById('set-sig-name').value = s.sigName || '';
    document.getElementById('set-sig-desig').value = s.sigDesig || '';
    document.getElementById('set-terms-q').value = s.termsQ || '';
    document.getElementById('set-terms-inv').value = s.termsInv || '';
    document.getElementById('set-terms-ch').value = s.termsCh || '';
    document.getElementById('set-terms-po').value = s.termsPo || '';
    document.getElementById('set-m-top').value = s.mTop || '0.5';
    document.getElementById('set-m-bottom').value = s.mBottom || '0.5';
    document.getElementById('set-m-left').value = s.mLeft || '0.5';
    document.getElementById('set-m-right').value = s.mRight || '0.5';

    // ADD THESE LINES FOR EXECUTIVE MANAGEMENT:
    document.getElementById('set-chair-name').value = s.chairName || '';
    document.getElementById('set-chair-msg').value = s.chairMsg || '';
    document.getElementById('set-md-name').value = s.mdName || '';
    document.getElementById('set-md-msg').value = s.mdMsg || '';
    document.getElementById('set-dir-name').value = s.dirName || '';
    document.getElementById('set-dir-msg').value = s.dirMsg || '';
    
    const showLogo = await Storage.get('showLogoPDF') === 'true';
    const showSeal = await Storage.get('showSealPDF') === 'true';
    document.getElementById('toggle-logo').checked = showLogo;
    document.getElementById('toggle-seal').checked = showSeal;
    
    const imageKeys = ['logo', 'seal', 'auth-sig', 'gen-sig', 'chair-sig', 'md-sig', 'dir-sig'];
    for (const key of imageKeys) {
        const data = localStorage.getItem('data-' + key);
        if(data) {
            const prev = document.getElementById('prev-' + key);
            prev.src = data; 
            prev.style.display = 'block';
        }
    }
}

        async function saveSettings() {
    const settings = {
        compName: document.getElementById('set-comp-name').value,
        compSlogan: document.getElementById('set-comp-slogan').value,
        compAddr: document.getElementById('set-comp-addr').value,
        mobile: document.getElementById('set-comp-mobile').value,
        email: document.getElementById('set-comp-email').value,
        web: document.getElementById('set-comp-web').value,
        currency: document.getElementById('set-currency').value,
        sigName: document.getElementById('set-sig-name').value,
        sigDesig: document.getElementById('set-sig-desig').value,
        termsQ: document.getElementById('set-terms-q').value,
        termsInv: document.getElementById('set-terms-inv').value,
        termsCh: document.getElementById('set-terms-ch').value,
        termsPo: document.getElementById('set-terms-po').value,
        mTop: document.getElementById('set-m-top').value,
        mBottom: document.getElementById('set-m-bottom').value,
        mLeft: document.getElementById('set-m-left').value,
        mRight: document.getElementById('set-m-right').value,

        // ADD THESE LINES TO GRAB DATA FROM THE EXECUTIVE FIELDS:
        chairName: document.getElementById('set-chair-name').value,
        chairMsg: document.getElementById('set-chair-msg').value,
        mdName: document.getElementById('set-md-name').value,
        mdMsg: document.getElementById('set-md-msg').value,
        dirName: document.getElementById('set-dir-name').value,
        dirMsg: document.getElementById('set-dir-msg').value
    };

    await Storage.save('faith_settings', settings);
    
    await Storage.save('showLogoPDF', document.getElementById('toggle-logo').checked);
    await Storage.save('showSealPDF', document.getElementById('toggle-seal').checked);
    
    document.getElementById('brand-header').innerText = settings.compName || "FAITH ENGINEERING";
    document.getElementById('brand-slogan').innerText = settings.compSlogan || "ENTERPRISE RESOURCE PLANNING";
    alert("Settings Updated!");
}

        // ==================== ACCOUNTS FUNCTIONS ====================
        function openIncomeModal(record = null, idx = -1) {
            document.getElementById('income-modal-title').innerText = record ? 'Edit Income Record' : 'Add Income Record';
            document.getElementById('income-date').value = record ? record.date : new Date().toISOString().split('T')[0];
            document.getElementById('income-purpose').value = record ? record.purpose : '';
            document.getElementById('income-amount').value = record ? record.amount : '';
            document.getElementById('income-description').value = record ? record.description : '';
            document.getElementById('income-edit-id').value = idx;
            document.getElementById('income-modal').style.display = 'flex';
        }

        function openExpenseModal(record = null, idx = -1) {
            document.getElementById('expense-modal-title').innerText = record ? 'Edit Expense Record' : 'Add Expense Record';
            document.getElementById('expense-date').value = record ? record.date : new Date().toISOString().split('T')[0];
            document.getElementById('expense-purpose').value = record ? record.purpose : '';
            document.getElementById('expense-amount').value = record ? record.amount : '';
            document.getElementById('expense-description').value = record ? record.description : '';
            document.getElementById('expense-edit-id').value = idx;
            document.getElementById('expense-modal').style.display = 'flex';
        }

        async function saveIncome() {
            const records = await getIncomeRecords();
            const editId = parseInt(document.getElementById('income-edit-id').value);
            const incomeData = {
                date: document.getElementById('income-date').value,
                purpose: document.getElementById('income-purpose').value,
                amount: parseFloat(document.getElementById('income-amount').value) || 0,
                description: document.getElementById('income-description').value
            };
            
            if(editId > -1) {
                records[editId] = incomeData;
            } else {
                records.push(incomeData);
            }
            
            await saveIncomeRecords(records);
            renderIncome();
            closeModal('income-modal');
        }

        async function saveExpense() {
            const records = await getExpenseRecords();
            const editId = parseInt(document.getElementById('expense-edit-id').value);
            const expenseData = {
                date: document.getElementById('expense-date').value,
                purpose: document.getElementById('expense-purpose').value,
                amount: parseFloat(document.getElementById('expense-amount').value) || 0,
                description: document.getElementById('expense-description').value
            };
            
            if(editId > -1) {
                records[editId] = expenseData;
            } else {
                records.push(expenseData);
            }
            
            await saveExpenseRecords(records);
            renderExpense();
            closeModal('expense-modal');
        }

        function formatDateDisplay(dateStr) {
            if (!dateStr) return "";
            const [year, month, day] = dateStr.split('-');
            return `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year}`;
        }

        async function renderIncome() {
            const records = await getIncomeRecords();
            const tbody = document.getElementById('income-table-body');
            const grandTotalEl = document.getElementById('income-grand-total');
            const totalIncomeEl = document.getElementById('total-income');
            const monthIncomeEl = document.getElementById('month-income');
            const yearIncomeEl = document.getElementById('year-income');
            
            tbody.innerHTML = '';
            let grandTotal = 0;
            let monthTotal = 0;
            let yearTotal = 0;
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            records.forEach((record, idx) => {
                const amount = parseFloat(record.amount) || 0;
                grandTotal += amount;
                
                const recordDate = new Date(record.date);
                if (recordDate.getMonth() + 1 === currentMonth && recordDate.getFullYear() === currentYear) {
                    monthTotal += amount;
                }
                
                if (recordDate.getFullYear() === currentYear) {
                    yearTotal += amount;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${formatDateDisplay(record.date)}</td>
                        <td>${record.purpose}</td>
                        <td class="income-amount">৳ ${amount.toLocaleString()}</td>
                        <td class="table-actions">
                            <button onclick="editIncome(${idx})" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteIncome(${idx})" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: var(--text-muted);">No income records found.</td></tr>';
            }
            
            grandTotalEl.innerText = `৳ ${grandTotal.toLocaleString()}`;
            totalIncomeEl.innerText = `৳ ${grandTotal.toLocaleString()}`;
            monthIncomeEl.innerText = `৳ ${monthTotal.toLocaleString()}`;
            yearIncomeEl.innerText = `৳ ${yearTotal.toLocaleString()}`;
        }

        async function renderExpense() {
            const records = await getExpenseRecords();
            const tbody = document.getElementById('expense-table-body');
            const grandTotalEl = document.getElementById('expense-grand-total');
            const totalExpenseEl = document.getElementById('total-expense');
            const monthExpenseEl = document.getElementById('month-expense');
            const yearExpenseEl = document.getElementById('year-expense');
            
            tbody.innerHTML = '';
            let grandTotal = 0;
            let monthTotal = 0;
            let yearTotal = 0;
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            records.forEach((record, idx) => {
                const amount = parseFloat(record.amount) || 0;
                grandTotal += amount;
                
                const recordDate = new Date(record.date);
                if (recordDate.getMonth() + 1 === currentMonth && recordDate.getFullYear() === currentYear) {
                    monthTotal += amount;
                }
                
                if (recordDate.getFullYear() === currentYear) {
                    yearTotal += amount;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${formatDateDisplay(record.date)}</td>
                        <td>${record.purpose}</td>
                        <td class="expense-amount">৳ ${amount.toLocaleString()}</td>
                        <td class="table-actions">
                            <button onclick="editExpense(${idx})" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteExpense(${idx})" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: var(--text-muted);">No expense records found.</td></tr>';
            }
            
            grandTotalEl.innerText = `৳ ${grandTotal.toLocaleString()}`;
            totalExpenseEl.innerText = `৳ ${grandTotal.toLocaleString()}`;
            monthExpenseEl.innerText = `৳ ${monthTotal.toLocaleString()}`;
            yearExpenseEl.innerText = `৳ ${yearTotal.toLocaleString()}`;
        }

        async function renderTransactions() {
            const incomeRecords = await getIncomeRecords();
            const expenseRecords = await getExpenseRecords();
            const tbody = document.getElementById('transactions-table-body');
            const totalIncomeEl = document.getElementById('summary-total-income');
            const totalExpenseEl = document.getElementById('summary-total-expense');
            const currentBalanceEl = document.getElementById('current-balance');
            
            tbody.innerHTML = '';
            
            const allTransactions = [];
            
            incomeRecords.forEach(record => {
                allTransactions.push({
                    ...record,
                    type: 'INCOME',
                    typeDisplay: 'Income',
                    amount: parseFloat(record.amount) || 0
                });
            });
            
            expenseRecords.forEach(record => {
                allTransactions.push({
                    ...record,
                    type: 'EXPENSE',
                    typeDisplay: 'Expense',
                    amount: parseFloat(record.amount) || 0
                });
            });
            
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let totalIncome = 0;
            let totalExpense = 0;
            
            allTransactions.forEach(transaction => {
                if (transaction.type === 'INCOME') {
                    totalIncome += transaction.amount;
                } else {
                    totalExpense += transaction.amount;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${formatDateDisplay(transaction.date)}</td>
                        <td><span class="${transaction.type === 'INCOME' ? 'income-amount' : 'expense-amount'}">${transaction.typeDisplay}</span></td>
                        <td>${transaction.purpose}</td>
                        <td class="${transaction.type === 'INCOME' ? 'income-amount' : 'expense-amount'}">${transaction.type === 'INCOME' ? '+' : '-'}৳ ${transaction.amount.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            if (allTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: var(--text-muted);">No transactions found.</td></tr>';
            }
            
            const balance = totalIncome - totalExpense;
            totalIncomeEl.innerText = `৳ ${totalIncome.toLocaleString()}`;
            totalExpenseEl.innerText = `৳ ${totalExpense.toLocaleString()}`;
            currentBalanceEl.innerText = `৳ ${balance.toLocaleString()}`;
            currentBalanceEl.style.color = balance >= 0 ? 'var(--income-green)' : 'var(--expense-red)';
        }

        async function editIncome(idx) {
            const records = await getIncomeRecords();
            openIncomeModal(records[idx], idx);
        }

        async function editExpense(idx) {
            const records = await getExpenseRecords();
            openExpenseModal(records[idx], idx);
        }

        async function deleteIncome(idx) {
            if (!confirm('Delete this income record?')) return;
            const records = await getIncomeRecords();
            records.splice(idx, 1);
            await saveIncomeRecords(records);
            renderIncome();
            renderTransactions();
        }

        async function deleteExpense(idx) {
            if (!confirm('Delete this expense record?')) return;
            const records = await getExpenseRecords();
            records.splice(idx, 1);
            await saveExpenseRecords(records);
            renderExpense();
            renderTransactions();
        }

        // ==================== WORK ORDER FUNCTIONS ====================
        async function filterClients(input) {
            const filter = input.value.toUpperCase();
            const clientList = document.getElementById("client-autocomplete");
            clientList.innerHTML = "";
            
            if (filter.length === 0) {
                clientList.style.display = "none";
                return;
            }
            
            const clients = await getClients();
            let hasMatches = false;
            
            clients.forEach(client => {
                if (client.name.toUpperCase().includes(filter)) {
                    const item = document.createElement("div");
                    item.className = "autocomplete-suggestion";
                    item.innerHTML = `<strong>${client.name}</strong><br><small>${client.person || ''} - ${client.phone || ''}</small>`;
                    item.onclick = function() {
                        input.value = client.name;
                        clientList.style.display = "none";
                    };
                    clientList.appendChild(item);
                    hasMatches = true;
                }
            });
            
            clientList.style.display = hasMatches ? "block" : "none";
        }

        function openWorkOrderModal(order = null, idx = -1) {
            document.getElementById('workorder-modal-title').innerText = order ? 'Edit Work Order' : 'Add Work Order';
            document.getElementById('workorder-date').value = order ? order.date : new Date().toISOString().split('T')[0];
            
            document.getElementById('workorder-client').value = order ? order.client : '';
            document.getElementById('client-autocomplete').innerHTML = '';
            document.getElementById('client-autocomplete').style.display = 'none';
            
            document.getElementById('workorder-id').value = order ? order.id : '';
            document.getElementById('workorder-type').value = order ? order.type : '';
            document.getElementById('workorder-value').value = order ? order.value : '';
            document.getElementById('workorder-cost').value = order ? order.cost : '';
            document.getElementById('workorder-description').value = order ? order.description : '';
            document.getElementById('workorder-edit-id').value = idx;
            document.getElementById('workorder-modal').style.display = 'flex';
        }

        async function saveWorkOrder() {
            const orders = await getWorkOrders();
            const editId = parseInt(document.getElementById('workorder-edit-id').value);
            const workOrderData = {
                date: document.getElementById('workorder-date').value,
                client: document.getElementById('workorder-client').value,
                id: document.getElementById('workorder-id').value,
                type: document.getElementById('workorder-type').value,
                value: parseFloat(document.getElementById('workorder-value').value) || 0,
                cost: parseFloat(document.getElementById('workorder-cost').value) || 0,
                description: document.getElementById('workorder-description').value
            };
            
            workOrderData.profit = workOrderData.value - workOrderData.cost;
            
            if(editId > -1) {
                orders[editId] = workOrderData;
            } else {
                orders.push(workOrderData);
            }
            
            await saveWorkOrders(orders);
            renderWorkOrders();
            closeModal('workorder-modal');
        }

        async function renderWorkOrders() {
            const orders = await getWorkOrders();
            const tbody = document.getElementById('workorder-table-body');
            const totalOrdersEl = document.getElementById('total-orders');
            const totalValueEl = document.getElementById('total-order-value');
            const totalCostEl = document.getElementById('total-order-cost');
            const totalProfitEl = document.getElementById('total-order-profit');
            const grandValueEl = document.getElementById('workorder-total-value');
            const grandCostEl = document.getElementById('workorder-total-cost');
            const grandProfitEl = document.getElementById('workorder-grand-profit');
            
            tbody.innerHTML = '';
            let totalOrders = 0;
            let totalValue = 0;
            let totalCost = 0;
            let totalProfit = 0;
            
            orders.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            orders.forEach((order, idx) => {
                const value = parseFloat(order.value) || 0;
                const cost = parseFloat(order.cost) || 0;
                const profit = value - cost;
                
                totalOrders++;
                totalValue += value;
                totalCost += cost;
                totalProfit += profit;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${formatDateDisplay(order.date)}</td>
                        <td>${order.client}</td>
                        <td>${order.id}</td>
                        <td>${order.type}</td>
                        <td class="income-amount">৳ ${value.toLocaleString()}</td>
                        <td class="expense-amount">৳ ${cost.toLocaleString()}</td>
                        <td class="${profit >= 0 ? 'profit-amount' : 'loss-amount'}">৳ ${profit.toLocaleString()}</td>
                        <td class="table-actions">
                            <button onclick="editWorkOrder(${idx})" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteWorkOrder(${idx})" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 20px; color: var(--text-muted);">No work orders found.</td></tr>';
            }
            
            totalOrdersEl.innerText = totalOrders;
            totalValueEl.innerText = `৳ ${totalValue.toLocaleString()}`;
            totalCostEl.innerText = `৳ ${totalCost.toLocaleString()}`;
            totalProfitEl.innerText = `৳ ${totalProfit.toLocaleString()}`;
            grandValueEl.innerText = `৳ ${totalValue.toLocaleString()}`;
            grandCostEl.innerText = `৳ ${totalCost.toLocaleString()}`;
            grandProfitEl.innerText = `৳ ${totalProfit.toLocaleString()}`;
            
            totalProfitEl.style.color = totalProfit >= 0 ? 'var(--income-green)' : 'var(--expense-red)';
            grandProfitEl.style.color = totalProfit >= 0 ? 'var(--income-green)' : 'var(--expense-red)';
        }

        async function editWorkOrder(idx) {
            const orders = await getWorkOrders();
            openWorkOrderModal(orders[idx], idx);
        }

        async function deleteWorkOrder(idx) {
            if (!confirm('Delete this work order?')) return;
            const orders = await getWorkOrders();
            orders.splice(idx, 1);
            await saveWorkOrders(orders);
            renderWorkOrders();
        }

        // ==================== AUTOCOMPLETE FUNCTIONS ====================
        async function showClientSuggestions(inputElement, type = 'doc') {
            const filter = inputElement.value.toUpperCase();
            let suggestionsId = '';
            switch(type) {
                case 'mr': suggestionsId = 'mr-client-suggestions'; break;
                default: suggestionsId = 'client-suggestions';
            }
            const suggestionsDiv = document.getElementById(suggestionsId);
            suggestionsDiv.innerHTML = "";
            
            if (filter.length === 0) {
                suggestionsDiv.style.display = "none";
                return;
            }
            
            const clients = await getClients();
            let hasMatches = false;
            
            clients.forEach(client => {
                if (client.name.toUpperCase().includes(filter)) {
                    const item = document.createElement("div");
                    item.className = "autocomplete-suggestion";
                    item.innerHTML = `<strong>${client.name}</strong><small>${client.person ? ' - ' + client.person : ''}${client.phone ? ' - ' + client.phone : ''}</small>`;
                    item.onclick = function() {
                        inputElement.value = client.name;
                        suggestionsDiv.style.display = "none";
                        
                        const addressField = type === 'mr' ? 'mr-address' : 'doc-address';
                        document.getElementById(addressField).value = client.address || '';
                    };
                    suggestionsDiv.appendChild(item);
                    hasMatches = true;
                }
            });
            
            suggestionsDiv.style.display = hasMatches ? "block" : "none";
        }

        async function showProductSuggestions(inputElement) {
            const filter = inputElement.value.toUpperCase();
            const suggestionsDiv = document.getElementById('product-suggestions');
            suggestionsDiv.innerHTML = "";
            
            if (filter.length === 0) {
                suggestionsDiv.style.display = "none";
                return;
            }
            
            const allFolders = (await getFolders()).filter(f => f.parent === 'products-menu');
            
            // Use a Map to track unique products with folder info
            const productMap = new Map();
            
            for (const folder of allFolders) {
                const folderProducts = await Storage.get(`folder_data_${folder.id}`) || [];
                const folderName = folder.name;
                folderProducts.forEach(p => {
                    const productKey = `${folder.id}_${p.item}_${p.desc}_${p.unit}_${p.price}`;
                    if (!productMap.has(productKey)) {
                        productMap.set(productKey, {
                            ...p,
                            folderName: folderName
                        });
                    }
                });
            }
            
            let hasMatches = false;
            const allProducts = Array.from(productMap.values());
            
            allProducts.forEach(product => {
                if (product.item.toUpperCase().includes(filter) || product.desc.toUpperCase().includes(filter)) {
                    const item = document.createElement("div");
                    item.className = "autocomplete-suggestion";
                    item.innerHTML = `<strong>${product.item}</strong><small>${product.desc ? ' - ' + product.desc : ''}${product.unit ? ' (' + product.unit + ')' : ''}${product.folderName ? ' [${product.folderName}]' : ''}</small>`;
                    item.onclick = function() {
                        inputElement.value = product.item;
                        suggestionsDiv.style.display = 'none';
                        
                        document.getElementById('item-desc').value = product.desc || '';
                        document.getElementById('item-unit').value = product.unit || '';
                        document.getElementById('item-price').value = product.price || '';
                    };
                    suggestionsDiv.appendChild(item);
                    hasMatches = true;
                }
            });
            
            suggestionsDiv.style.display = hasMatches ? "block" : "none";
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(el => {
                    el.style.display = 'none';
                });
            }
        });

        // ==================== COMMERCIAL DOCUMENT FUNCTIONS - FIXED ====================
        async function renderCommercialFolder(type) {
            const gridMap = {
                'QUOTATION': 'grid-quotation',
                'INVOICE': 'grid-invoice',
                'CHALLAN': 'grid-challan',
                'PO': 'grid-po',
                'RECEIPT': 'grid-receipt'
            };
            
            const grid = document.getElementById(gridMap[type]);
            if(!grid) return;
            const header = grid.querySelector('.nav-header');
            grid.innerHTML = '';
            if(header) grid.appendChild(header);
            
            const docs = await getDocs();
            const filteredDocs = docs.filter(d => d.type === type);
            
            filteredDocs.forEach(d => {
                let icon = 'fa-file-contract';
                let color = '#c084fc';
                if (type === 'RECEIPT') {
                    icon = 'fa-receipt';
                    color = '#34d399';
                } else if (type === 'LETTER') {
                    icon = 'fa-envelope';
                    color = '#a855f7';
                }
                renderCard(gridMap[type], d.id, color, icon);
            });
        }

        function renderCard(gridId, docId, color, icon) {
            const grid = document.getElementById(gridId);
            if(!grid) return;
            
            // Check if card already exists to prevent duplicates
            const existingCard = document.getElementById('card-' + docId);
            if (existingCard) return;
            
            const card = document.createElement('a');
            card.className = "nav-card";
            card.id = "card-" + docId;
            card.onclick = () => showActions(docId);
            card.innerHTML = `<div class="icon-bg" style="background:${color}"></div><i class="fas ${icon}" style="color:${color}"></i><span>${docId}</span>`;
            grid.appendChild(card);
        }

        async function showActions(docId) {
            selectedDocId = docId;
            document.getElementById('action-target-id').innerText = docId;
            
            // First check if it's a letter
            const letters = await getLetterDocuments();
            const letter = letters.find(l => l.id === docId);
            if (letter) {
                document.getElementById('convert-options').style.display = 'none';
                document.getElementById('action-modal').style.display = 'flex';
                return;
            }
            
            // Then check if it's a commercial document
            const docs = await getDocs();
            const doc = docs.find(d => d.id === docId);
            if (!doc) {
                alert("Document not found!");
                return;
            }
            
            const conv = document.getElementById('convert-options');
            if(doc && doc.type === 'QUOTATION') {
                conv.style.display = 'flex';
            } else {
                conv.style.display = 'none';
            }
            document.getElementById('action-modal').style.display = 'flex';
        }

        function formatDate(dateStr) {
            if (!dateStr) return "";
            const [year, month, day] = dateStr.split('-');
            return `${day}.${month}.${year}`;
        }

        function generateReference() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const nums = '0123456789';
            let res = '';
            for(let i=0; i<3; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            for(let i=0; i<3; i++) res += nums.charAt(Math.floor(Math.random() * nums.length));
            return res;
        }

        async function convertDoc(targetType) {
            const docs = await getDocs();
            const sourceDoc = docs.find(d => d.id === selectedDocId);
            if(!sourceDoc) return;
            
            const prefix = targetType === 'INVOICE' ? 'FE-INV-' : 'FE-DC-';
            const lastId = await Storage.get(`last_id_${targetType}`) || 10049;
            const newId = prefix + (parseInt(lastId) + 1);
            
            const newDoc = {
                ...sourceDoc,
                type: targetType,
                id: newId,
                date: new Date().toISOString().split('T')[0],
                grid: 'grid-' + targetType.toLowerCase()
            };

            if(targetType === 'INVOICE') {
                newDoc.orderId = sourceDoc.reference || '';
            } else if (targetType === 'CHALLAN') {
                newDoc.orderId = sourceDoc.reference || '';
                newDoc.items = sourceDoc.items.map(it => ({...it, remarks: ''}));
            }

            await updateOrSave(newDoc);
            closeModal('action-modal');
            alert(`Converted to ${targetType === 'CHALLAN' ? 'Delivery Challan' : targetType}: ${newId}`);
            openView('folder-' + targetType.toLowerCase());
        }

        // ==================== IMPROVED NUMBER TO WORDS FUNCTION ====================
        function numberToWords(num) {
            if (!num || isNaN(num) || num === 0) return "Zero";
            
            const numStr = parseFloat(num).toFixed(2);
            const [integerPart, decimalPart] = numStr.split('.');
            
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const thousands = ['', 'Thousand', 'Lakh', 'Crore'];
            
            function convertInteger(n) {
                if (n == 0) return '';
                
                let words = '';
                let crore = Math.floor(n / 10000000);
                n %= 10000000;
                
                let lakh = Math.floor(n / 100000);
                n %= 100000;
                
                let thousand = Math.floor(n / 1000);
                n %= 1000;
                
                let hundred = Math.floor(n / 100);
                n %= 100;
                
                if (crore > 0) {
                    words += convertHundred(crore) + ' Crore ';
                }
                
                if (lakh > 0) {
                    words += convertHundred(lakh) + ' Lakh ';
                }
                
                if (thousand > 0) {
                    words += convertHundred(thousand) + ' Thousand ';
                }
                
                if (hundred > 0) {
                    words += ones[hundred] + ' Hundred ';
                }
                
                if (n > 0) {
                    if (words !== '') words += 'and ';
                    if (n < 20) {
                        words += ones[n];
                    } else {
                        words += tens[Math.floor(n / 10)];
                        if (n % 10 > 0) {
                            words += ' ' + ones[n % 10];
                        }
                    }
                }
                
                return words.trim();
            }
            
            function convertHundred(n) {
                if (n == 0) return '';
                
                let words = '';
                if (n >= 100) {
                    words += ones[Math.floor(n / 100)] + ' Hundred ';
                    n %= 100;
                }
                
                if (n > 0) {
                    if (words !== '') words += 'and ';
                    if (n < 20) {
                        words += ones[n];
                    } else {
                        words += tens[Math.floor(n / 10)];
                        if (n % 10 > 0) {
                            words += ' ' + ones[n % 10];
                        }
                    }
                }
                
                return words.trim();
            }
            
            let result = convertInteger(parseInt(integerPart)).trim();
            
            if (decimalPart && parseInt(decimalPart) > 0) {
                result += ' Taka and ' + convertInteger(parseInt(decimalPart)).trim() + ' Paisa';
            } else {
                result += ' Taka';
            }
            
            return result.charAt(0).toUpperCase() + result.slice(1) + ' Only';
        }

        async function triggerDownload(mode = 'download') {
            // Check if it's a letter document first
            const letters = await getLetterDocuments();
            const letter = letters.find(l => l.id === selectedDocId);
            
            if (letter) {
                // Handle letter PDF generation
                const element = renderLetterPDF(letter);
                const s = await Storage.get('faith_settings') || {};
                const mTop = parseFloat(s.mTop) || 0.5;
                const mBottom = parseFloat(s.mBottom) || 0.5;
                const mLeft = parseFloat(s.mLeft) || 0.5;
                const mRight = parseFloat(s.mRight) || 0.5;
                
                const opt = { 
                    margin: [mTop, mLeft, mBottom, mRight], 
                    filename: `${letter.id}.pdf`, 
                    image: { type: 'jpeg', quality: 0.98 }, 
                    html2canvas: { scale: 2, useCORS: true }, 
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } 
                };
                
                html2pdf().set(opt).from(element).save().then(() => {
                    element.style.display = 'none';
                    if (mode === 'print') {
                        const pdfWindow = window.open("", "_blank");
                        if (pdfWindow) {
                            pdfWindow.document.write('<iframe src="' + element.innerHTML + '" width="100%" height="100%"></iframe>');
                            pdfWindow.print();
                        }
                    }
                });
                
                closeModal('action-modal');
                return;
            }
            
            // Handle commercial documents
            const docs = await getDocs();
            const doc = docs.find(d => d.id === selectedDocId);
            
            if (!doc) {
                alert("Document not found!");
                closeModal('action-modal');
                return;
            }
            
            const s = await Storage.get('faith_settings') || {};
            const element = document.getElementById('pdf-template');
            const innerContent = document.getElementById('pdf-inner-content');
            element.style.display = 'block'; 
            
            document.getElementById('pdf-letter-header').style.display = 'none';
            document.getElementById('pdf-letter-content').style.display = 'none';
            document.getElementById('pdf-letter-title').innerText = '';
            document.getElementById('pdf-letter-text').innerHTML = '';
            
            document.getElementById('pdf-type-label').style.display = 'block';
            document.getElementById('pdf-standard-table').style.display = 'block';
            document.getElementById('pdf-client-section').style.display = 'flex';
            document.getElementById('pdf-terms-section').style.display = 'block';
            document.getElementById('pdf-subject-container').style.display = 'none';
            
            const mTop = parseFloat(s.mTop) || 0.5;
            const mBottom = parseFloat(s.mBottom) || 0.5;
            const mLeft = parseFloat(s.mLeft) || 0.5;
            const mRight = parseFloat(s.mRight) || 0.5;
            innerContent.style.minHeight = (11.69 - (mTop + mBottom)) + "in";
            document.getElementById('pdf-comp-name').innerText = s.compName || "FAITH ENGINEERING";
            document.getElementById('pdf-for-comp').innerText = s.compName || "FAITH ENGINEERING";
            document.getElementById('pdf-comp-addr-line').innerText = s.compAddr || ""; 
            document.getElementById('pdf-comp-contact-line').innerText = `Mobile: ${s.mobile || ''} | Email: ${s.email || ''} | Website: ${s.web || ''}`;
            document.getElementById('pdf-footer-slogan').innerText = s.compSlogan || "";
            
            const showLogo = await Storage.get('showLogoPDF') === 'true';
            const showSeal = await Storage.get('showSealPDF') === 'true';
            
            if (showLogo) {
                const logo = localStorage.getItem('data-logo');
                if(logo) { 
                    document.getElementById('pdf-comp-logo').src = logo; 
                    document.getElementById('pdf-logo-container').style.display = 'block'; 
                } else {
                    document.getElementById('pdf-logo-container').style.display = 'none';
                }
            } else {
                document.getElementById('pdf-logo-container').style.display = 'none';
            }
            
            if (showSeal) {
                const seal = localStorage.getItem('data-seal');
                if(seal) { 
                    document.getElementById('pdf-seal').src = seal; 
                    document.getElementById('pdf-seal-container').style.display = 'block'; 
                } else {
                    document.getElementById('pdf-seal-container').style.display = 'none';
                }
            } else {
                document.getElementById('pdf-seal-container').style.display = 'none';
            }
            
            // UPDATED: Use proper document titles in PDF
            let docTitle = doc.type;
            if (doc.type === 'RECEIPT') docTitle = 'MONEY RECEIPT';
            else if (doc.type === 'CHALLAN') docTitle = 'DELIVERY CHALLAN';
            else if (doc.type === 'PO') docTitle = 'PURCHASE ORDER';
            
            document.getElementById('pdf-type-label').innerText = docTitle;
            document.getElementById('pdf-id').innerText = doc.id;
            document.getElementById('pdf-date').innerText = formatDate(doc.date);
            
            if(doc.type === 'RECEIPT') {
                document.getElementById('pdf-client-section').style.display = 'none';
                document.getElementById('pdf-mr-client-name').innerText = doc.client;
                const clients = await getClients();
                const client = clients.find(c => c.name === doc.client);
                document.getElementById('pdf-mr-client-addr').innerText = client ? client.address : '';
            } else {
                document.getElementById('pdf-client-section').style.display = 'flex';
                document.getElementById('pdf-client-name').innerText = doc.client;
                const clients = await getClients();
                const client = clients.find(c => c.name === doc.client);
                document.getElementById('pdf-client-addr').innerText = client ? client.address : '';
            }
            
            const orderRow = document.getElementById('pdf-order-row');
            const orderLabel = document.getElementById('pdf-ref-label');
            const orderVal = document.getElementById('pdf-order-id');
            if(doc.type === 'QUOTATION' && doc.reference) {
                orderRow.style.display = 'table-row';
                orderLabel.innerText = 'Ref No:';
                orderVal.innerText = doc.reference;
            } else if (doc.orderId) {
                orderRow.style.display = 'table-row';
                orderLabel.innerText = 'Order No:';
                orderVal.innerText = doc.orderId;
            } else { orderRow.style.display = 'none'; }
            document.getElementById('pdf-gate-row').style.display = doc.gatePass ? 'table-row' : 'none';
            document.getElementById('pdf-gate-id').innerText = doc.gatePass || '';
            if ((doc.type === 'QUOTATION' || doc.type === 'PO') && doc.subject) {
                document.getElementById('pdf-subject-container').style.display = 'block';
                document.getElementById('pdf-subject-text').innerText = doc.subject;
            } else { document.getElementById('pdf-subject-container').style.display = 'none'; }
            document.getElementById('pdf-receiver-section').style.visibility = (doc.type === 'CHALLAN') ? 'visible' : 'hidden';
            
            if(doc.type === 'RECEIPT') {
                document.getElementById('pdf-terms-section').style.display = 'none';
                document.getElementById('pdf-mr-container').style.display = 'block';
                document.getElementById('pdf-standard-table').style.display = 'none';
                document.getElementById('pdf-words-container').style.display = 'none'; 
                
                document.getElementById('pdf-mr-id').innerText = doc.id;
                document.getElementById('pdf-mr-date').innerText = formatDate(doc.date);
                document.getElementById('pdf-mr-amount').innerText = parseFloat(doc.amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('pdf-mr-words-text').innerText = doc.words || numberToWords(doc.amount);
                document.getElementById('pdf-mr-mode').innerText = doc.mode;
                
                if(doc.mode === 'Cheque') {
                    document.getElementById('pdf-mr-extra').innerHTML = `<br><span style="font-size: 10px;">Cheque No: ${doc.chqNo || ''}<br>Bank: ${doc.bank || ''}</span>`;
                } else {
                    document.getElementById('pdf-mr-extra').innerHTML = '';
                }
                
                document.getElementById('pdf-mr-curr').innerText = s.currency || '৳';
            } else {
                document.getElementById('pdf-mr-container').style.display = 'none';
                document.getElementById('pdf-standard-table').style.display = 'block';
                document.getElementById('pdf-words-container').style.display = (doc.type === 'CHALLAN') ? 'none' : 'block';
                const thead = document.getElementById('pdf-table-head-container');
                const tbody = document.getElementById('pdf-table-body');
                const tfoot = document.getElementById('pdf-table-foot-container');
                tbody.innerHTML = ''; tfoot.innerHTML = '';
                let headHtml = '';
                const isChallan = doc.type === 'CHALLAN';
                if(isChallan) {
                    headHtml = `<tr style="background: #f8f8f8;"><th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 30px;">SL</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Items</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Description</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 40px;">Qty</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 40px;">Unit</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Remarks</th></tr>`;
                } else {
                    headHtml = `<tr style="background: #f8f8f8;"><th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 30px;">SL</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Items</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Description</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 40px;">Qty</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 40px;">Unit</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 70px;">Unit Price</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 80px;">Total Price</th></tr>`;
                }
                thead.innerHTML = headHtml;
                let subtotal = 0;
                doc.items.forEach((it, idx) => {
                    subtotal += it.total;
                    let rowHtml = `<tr><td style="padding:8px; border:1px solid #ddd; text-align:center;">${idx + 1}</td><td style="padding:8px; border:1px solid #ddd; text-align:left;">${it.name || ''}</td><td style="padding:8px; border:1px solid #ddd; text-align:left;">${it.desc || ''}</td><td style="padding:8px; border:1px solid #ddd; text-align:center;">${it.qty}</td><td style="padding:8px; border:1px solid #ddd; text-align:center;">${it.unit || ''}</td>`;
                    if(isChallan) { rowHtml += `<td style="padding:8px; border:1px solid #ddd; text-align:center;">${it.remarks || ''}</td>`; }
                    else { rowHtml += `<td style="padding:8px; border:1px solid #ddd; text-align:center;">${(it.price || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td><td style="padding:8px; border:1px solid #ddd; text-align:center;">${(it.total || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>`; }
                    rowHtml += `</tr>`;
                    tbody.innerHTML += rowHtml;
                });
                if(!isChallan) {
                    const vatAmt = (parseFloat(doc.vat) || 0) / 100 * subtotal;
                    const aitAmt = (parseFloat(doc.ait) || 0) / 100 * subtotal;
                    const grandTotal = subtotal + vatAmt + aitAmt;
                    const paidAmt = parseFloat(doc.paid) || 0;
                    const dueAmt = grandTotal - paidAmt;
                    const curr = s.currency || '৳';
                    let footHtml = `<tr><td colspan="5" style="padding:8px; border:1px solid #ddd; text-align:right; font-weight:bold;">Sub Total</td><td colspan="2" style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold;">${curr} ${subtotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
                    if(vatAmt > 0) footHtml += `<tr><td colspan="5" style="padding:8px; border:1px solid #ddd; text-align:right;">VAT (${doc.vat}%)</td><td colspan="2" style="padding:8px; border:1px solid #ddd; text-align:center;">${vatAmt.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
                    if(aitAmt > 0) footHtml += `<tr><td colspan="5" style="padding:8px; border:1px solid #ddd; text-align:right;">AIT (${doc.ait}%)</td><td colspan="2" style="padding:8px; border:1px solid #ddd; text-align:center;">${aitAmt.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
                    footHtml += `<tr style="background:#f0f9ff;"><td colspan="5" style="padding:8px; border:1px solid #ddd; text-align:right; font-weight:800; color:#000;">GRAND TOTAL</td><td colspan="2" style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:800; color:#000;">${curr} ${grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
                    
                    if(doc.type === 'INVOICE') {
                        footHtml += `<tr><td colspan="5" style="padding:8px; border:1px solid #ddd; text-align:right; font-weight:bold; color: #4ade80;">Paid Amount</td><td colspan="2" style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color: #4ade80;">${curr} ${paidAmt.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
                        footHtml += `<tr><td colspan="5" style="padding:8px; border:1px solid #ddd; text-align:right; font-weight:bold; color: #ef4444;">Due Amount</td><td colspan="2" style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color: #ef4444;">${curr} ${dueAmt.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
                        document.getElementById('pdf-grand-words').innerText = numberToWords(dueAmt);
                    } else {
                        document.getElementById('pdf-grand-words').innerText = numberToWords(grandTotal);
                    }
                    tfoot.innerHTML = footHtml;
                }
            }
            const auth = localStorage.getItem('data-auth-sig');
            if(auth) { document.getElementById('pdf-auth-sig').src = auth; document.getElementById('pdf-auth-sig').style.display = 'block'; }
            document.getElementById('pdf-sig-name').innerText = s.sigName || "";
            document.getElementById('pdf-sig-desig').innerText = s.sigDesig || "";
            const opt = { margin: [mTop, mLeft, mBottom, mRight], filename: `${doc.id}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            
            if(mode === 'download') {
                html2pdf().set(opt).from(element).save().then(() => {
                    element.style.display = 'none';
                });
            } else if (mode === 'print') {
                html2pdf().set(opt).from(element).toPdf().get('pdf').then(function (pdf) { 
                    const pdfBlob = pdf.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    const printWindow = window.open(pdfUrl);
                    if (printWindow) {
                        printWindow.onload = function() {
                            printWindow.print();
                        };
                    }
                    element.style.display = 'none';
                });
            }
            closeModal('action-modal');
        }

        function renderLetterPDF(doc) {
            const element = document.getElementById('pdf-template');
            const innerContent = document.getElementById('pdf-inner-content');
            element.style.display = 'block';
            
            // Clear any previous content
            document.getElementById('pdf-type-label').style.display = 'none';
            document.getElementById('pdf-letter-header').style.display = 'block';
            document.getElementById('pdf-letter-content').style.display = 'block';
            document.getElementById('pdf-standard-table').style.display = 'none';
            document.getElementById('pdf-words-container').style.display = 'none';
            document.getElementById('pdf-terms-section').style.display = 'none';
            document.getElementById('pdf-mr-container').style.display = 'none';
            document.getElementById('pdf-subject-container').style.display = 'none';
            document.getElementById('pdf-client-section').style.display = 'none';
            
            // Set letter-specific content
            document.getElementById('pdf-letter-title').innerText = doc.title;
            document.getElementById('pdf-letter-text').innerHTML = doc.text.replace(/\n/g, '<br>');
            
            // Get settings from Storage (not localStorage directly)
            Storage.get('faith_settings').then(s => {
                const settings = s || {};
                const mTop = parseFloat(settings.mTop) || 0.5;
                const mBottom = parseFloat(settings.mBottom) || 0.5;
                const mLeft = parseFloat(settings.mLeft) || 0.5;
                const mRight = parseFloat(settings.mRight) || 0.5;
                innerContent.style.minHeight = (11.69 - (mTop + mBottom)) + "in";
                
                // Set company info from settings
                document.getElementById('pdf-comp-name').innerText = settings.compName || "FAITH ENGINEERING";
                document.getElementById('pdf-for-comp').innerText = settings.compName || "FAITH ENGINEERING";
                document.getElementById('pdf-comp-addr-line').innerText = settings.compAddr || "";
                document.getElementById('pdf-comp-contact-line').innerText = `Mobile: ${settings.mobile || ''} | Email: ${settings.email || ''} | Website: ${settings.web || ''}`;
                document.getElementById('pdf-footer-slogan').innerText = settings.compSlogan || "";
                
                // Handle logo visibility
                Storage.get('showLogoPDF').then(showLogo => {
                    if (showLogo === 'true') {
                        const logo = localStorage.getItem('data-logo');
                        if(logo) { 
                            document.getElementById('pdf-comp-logo').src = logo; 
                            document.getElementById('pdf-logo-container').style.display = 'block'; 
                        } else {
                            document.getElementById('pdf-logo-container').style.display = 'none';
                        }
                    } else {
                        document.getElementById('pdf-logo-container').style.display = 'none';
                    }
                });
                
                // Handle seal visibility
                Storage.get('showSealPDF').then(showSeal => {
                    if (showSeal === 'true') {
                        const seal = localStorage.getItem('data-seal');
                        if(seal) { 
                            document.getElementById('pdf-seal').src = seal; 
                            document.getElementById('pdf-seal-container').style.display = 'block'; 
                        } else {
                            document.getElementById('pdf-seal-container').style.display = 'none';
                        }
                    } else {
                        document.getElementById('pdf-seal-container').style.display = 'none';
                    }
                });
                
                // Set signature
                const auth = localStorage.getItem('data-auth-sig');
                if(auth) { 
                    document.getElementById('pdf-auth-sig').src = auth; 
                    document.getElementById('pdf-auth-sig').style.display = 'block'; 
                }
                
                document.getElementById('pdf-sig-name').innerText = settings.sigName || "";
                document.getElementById('pdf-sig-desig').innerText = settings.sigDesig || "";
            });
            
            return element;
        }

        async function triggerDelete() {
            // First check if it's a letter
            const letters = await getLetterDocuments();
            const letter = letters.find(l => l.id === selectedDocId);
            
            if (letter) {
                deleteLetter(selectedDocId);
                closeModal('action-modal');
                return;
            }
            
            // Then check if it's a commercial document
            if(!confirm("Delete?")) return;
            let docs = await getDocs();
            docs = docs.filter(d => d.id !== selectedDocId);
            await saveDocs(docs);
            document.getElementById('card-' + selectedDocId).remove();
            closeModal('action-modal');
        }

        async function triggerEdit() {
            // First check if it's a letter
            const letters = await getLetterDocuments();
            const letter = letters.find(l => l.id === selectedDocId);
            
            if (letter) {
                closeModal('action-modal');
                openLetterModal(letter);
                return;
            }
            
            // Then check if it's a commercial document
            const docs = await getDocs();
            const doc = docs.find(d => d.id === selectedDocId);
            if (!doc) {
                alert("Document not found!");
                closeModal('action-modal');
                return;
            }
            
            closeModal('action-modal');
            if(doc.type === 'RECEIPT') openMR(doc);
            else openDocModal(doc.type, doc);
        }

        function openDocModal(type, existingDoc = null) {
            currentDocType = type;
            docItems = existingDoc ? [...existingDoc.items] : [];
            document.getElementById('doc-modal').style.display = 'flex';
            const extras = document.getElementById('extra-fields');
            const taxDiv = document.getElementById('tax-fields');
            const paymentDiv = document.getElementById('payment-fields');
            extras.innerHTML = '';
            taxDiv.style.display = (type === 'QUOTATION' || type === 'PO') ? 'grid' : 'none';
            paymentDiv.style.display = (type === 'INVOICE') ? 'block' : 'none';
            document.getElementById('doc-vat').value = existingDoc ? (existingDoc.vat || 0) : 0;
            document.getElementById('doc-ait').value = existingDoc ? (existingDoc.ait || 0) : 0;
            document.getElementById('doc-paid').value = existingDoc ? (existingDoc.paid || 0) : 0;
            let prefix = ''; let tableHead = '';
            
            // UPDATED: Set proper modal titles
            if(type === 'QUOTATION') { 
                document.getElementById('doc-title').innerText = 'Quotation';
                prefix = 'FE-Q-'; 
                tableHead = '<th>SL</th><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th>Action</th>'; 
                extras.innerHTML = `<div class="form-group"><label>Reference</label><input type="text" id="extra-ref" readonly></div><div class="form-group"><label>Subject</label><input type="text" id="extra-sub"></div>`; 
            }
            else if (type === 'INVOICE') { 
                document.getElementById('doc-title').innerText = 'Invoice';
                prefix = 'FE-INV-'; 
                tableHead = '<th>SL</th><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th>Action</th>'; 
                extras.innerHTML = `<div class="form-group"><label>Order ID</label><input type="text" id="extra-order"></div>`; 
            }
            else if (type === 'CHALLAN') { 
                document.getElementById('doc-title').innerText = 'Delivery Challan';
                prefix = 'FE-DC-'; 
                tableHead = '<th>SL</th><th>Item</th><th>Desc</th><th>Qty</th><th>Remarks</th><th>Action</th>'; 
                extras.innerHTML = `<div style="display:flex; gap:10px;"><div class="form-group" style="flex:1;"><label>Order ID</label><input type="text" id="extra-order"></div><div class="form-group" style="flex:1;"><label>Gate Pass</label><input type="text" id="extra-gate"></div></div>`; 
            }
            else if (type === 'PO') { 
                document.getElementById('doc-title').innerText = 'Purchase Order';
                prefix = 'FE-PO-'; 
                tableHead = '<th>SL</th><th>Desc</th><th>Qty</th><th>Price</th><th>Total</th><th>Action</th>'; 
                extras.innerHTML = `<div class="form-group"><label>Subject</label><input type="text" id="extra-sub"></div>`; 
            }
            
            if(existingDoc) {
                document.getElementById('doc-id').value = existingDoc.id;
                document.getElementById('doc-date').value = existingDoc.date;
                document.getElementById('doc-client').value = existingDoc.client;
                if(document.getElementById('extra-ref')) document.getElementById('extra-ref').value = existingDoc.reference || '';
                if(document.getElementById('extra-order')) document.getElementById('extra-order').value = existingDoc.orderId || '';
                if(document.getElementById('extra-gate')) document.getElementById('extra-gate').value = existingDoc.gatePass || '';
                if(document.getElementById('extra-sub')) document.getElementById('extra-sub').value = existingDoc.subject || '';
                document.getElementById('doc-address').value = getClientAddrFromStorage(existingDoc.client);
            } else {
                Storage.get(`last_id_${type}`).then(lastId => {
                    document.getElementById('doc-id').value = prefix + (parseInt(lastId || 10049) + 1);
                });
                document.getElementById('doc-date').valueAsDate = new Date();
                document.getElementById('doc-client').value = '';
                document.getElementById('doc-address').value = '';
                if(type === 'QUOTATION') document.getElementById('extra-ref').value = generateReference();
            }
            document.getElementById('doc-table-head').innerHTML = tableHead;
            renderDocTable();
        }

        function calculateDueAmount() {
            if (currentDocType !== 'INVOICE') return;
            renderDocTable();
        }

        function renderDocTable() {
            const body = document.getElementById('doc-table-body');
            const foot = document.getElementById('doc-table-foot');
            Storage.get('faith_settings').then(s => {
                const settings = s || {};
                const curr = settings.currency || '৳';
                body.innerHTML = ''; 
                let subtotal = 0;
                
                docItems.forEach((it, idx) => {
                    subtotal += it.total;
                    
                    let rowHtml = `<tr>`;
                    rowHtml += `<td>${idx + 1}</td>`;
                    
                    if(currentDocType === 'CHALLAN') {
                        rowHtml += `<td>${it.name || ''}</td>`;
                        rowHtml += `<td>${it.desc || ''}</td>`;
                        rowHtml += `<td>${it.qty || 0}</td>`;
                        rowHtml += `<td>${it.remarks || ''}</td>`;
                    } else {
                        rowHtml += `<td>${it.name || it.desc || ''}</td>`;
                        rowHtml += `<td>${it.qty || 0}</td>`;
                        rowHtml += `<td>${(it.price || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>`;
                        rowHtml += `<td>${(it.total || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>`;
                    }
                    
                    rowHtml += `<td><button onclick="deleteItemFromList(${idx})" style="color:#ef4444; border:none; background:none; cursor:pointer;" title="Delete"><i class="fas fa-trash"></i></button></td>`;
                    rowHtml += `</tr>`;
                    body.innerHTML += rowHtml;
                });
                
                if(currentDocType !== 'CHALLAN') {
                    const vat = parseFloat(document.getElementById('doc-vat').value) || 0;
                    const ait = parseFloat(document.getElementById('doc-ait').value) || 0;
                    const grandTotal = subtotal + (vat/100 * subtotal) + (ait/100 * subtotal);
                    
                    let footHtml = `<tr class="grand-total-row"><td colspan="4">Grand Total</td><td>${curr} ${grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td><td></td></tr>`;
                    
                    if(currentDocType === 'INVOICE') {
                        const paid = parseFloat(document.getElementById('doc-paid').value) || 0;
                        const due = grandTotal - paid;
                        footHtml += `<tr><td colspan="4" style="color:#4ade80">Paid Amount</td><td>${curr} ${paid.toLocaleString(undefined, {minimumFractionDigits: 2})}</td><td></td></tr>`;
                        footHtml += `<tr><td colspan="4" style="color:#ef4444">Due Amount</td><td>${curr} ${due.toLocaleString(undefined, {minimumFractionDigits: 2})}</td><td></td></tr>`;
                    }
                    foot.innerHTML = footHtml;
                } else { 
                    foot.innerHTML = ''; 
                }
            });
        }

        function deleteItemFromList(idx) {
            if(!confirm("Delete this item from the list?")) return;
            docItems.splice(idx, 1);
            renderDocTable();
        }

        async function openMR(existingDoc = null) {
            document.getElementById('mr-modal').style.display = 'flex';
            if(existingDoc) {
                document.getElementById('mr-id').value = existingDoc.id;
                document.getElementById('mr-date').value = existingDoc.date;
                document.getElementById('mr-client').value = existingDoc.client;
                document.getElementById('mr-amount').value = existingDoc.amount;
                document.getElementById('mr-words').value = existingDoc.words;
                document.getElementById('mr-mode').value = existingDoc.mode;
                toggleChequeFields();
                if(existingDoc.mode === 'Cheque') { document.getElementById('mr-chq-no').value = existingDoc.chqNo; document.getElementById('mr-bank').value = existingDoc.bank; }
                document.getElementById('mr-address').value = await getClientAddrFromStorage(existingDoc.client);
            } else {
                const lastId = await Storage.get('last_id_RECEIPT') || 10049;
                document.getElementById('mr-id').value = 'FE-MR-' + (parseInt(lastId) + 1);
                document.getElementById('mr-date').valueAsDate = new Date();
                document.getElementById('mr-amount').value = ''; 
                document.getElementById('mr-words').value = '';
                document.getElementById('mr-client').value = ''; 
                document.getElementById('mr-address').value = '';
            }
        }

        function updateWords() {
            const amt = document.getElementById('mr-amount').value;
            document.getElementById('mr-words').value = numberToWords(amt);
        }

        async function saveDocument() {
            const id = document.getElementById('doc-id').value;
            const subtotal = docItems.reduce((sum, item) => sum + (item.total || 0), 0);
            const vat = parseFloat(document.getElementById('doc-vat').value) || 0;
            const ait = parseFloat(document.getElementById('doc-ait').value) || 0;
            const grandTotal = subtotal + (vat/100 * subtotal) + (ait/100 * subtotal);
            
            const docData = {
                type: currentDocType, 
                id, 
                date: document.getElementById('doc-date').value,
                client: document.getElementById('doc-client').value, 
                grid: 'grid-' + currentDocType.toLowerCase(),
                items: docItems, 
                vat: vat,
                ait: ait,
                paid: document.getElementById('doc-paid')?.value || 0,
                orderId: document.getElementById('extra-order')?.value || '',
                reference: document.getElementById('extra-ref')?.value || '',
                gatePass: document.getElementById('extra-gate')?.value || '', 
                subject: document.getElementById('extra-sub')?.value || ''
            };
            await updateOrSave(docData);
            closeModal('doc-modal');
        }

        async function saveMoneyReceipt() {
            const id = document.getElementById('mr-id').value;
            const docData = {
                type: 'RECEIPT', 
                id, 
                date: document.getElementById('mr-date').value,
                client: document.getElementById('mr-client').value, 
                amount: document.getElementById('mr-amount').value,
                words: document.getElementById('mr-words').value,
                mode: document.getElementById('mr-mode').value, 
                chqNo: document.getElementById('mr-chq-no').value,
                bank: document.getElementById('mr-bank').value, 
                grid: 'grid-receipt'
            };
            await updateOrSave(docData);
            closeModal('mr-modal');
        }

        async function updateOrSave(newDoc) {
            let docs = await getDocs();
            const index = docs.findIndex(d => d.id === newDoc.id);
            if(index > -1) docs[index] = newDoc;
            else {
                docs.push(newDoc);
                await Storage.save(`last_id_${newDoc.type}`, newDoc.id.split('-').pop());
                renderCard(newDoc.grid, newDoc.id, (newDoc.type === 'RECEIPT' ? '#34d399' : '#c084fc'), (newDoc.type === 'RECEIPT' ? 'fa-receipt' : 'fa-file-contract'));
            }
            await saveDocs(docs);
        }

        function openItemModal() {
            document.getElementById('item-modal').style.display = 'flex';
            document.getElementById('item-remarks-field').style.display = (currentDocType === 'CHALLAN') ? 'block' : 'none';
            document.getElementById('item-price-field').style.display = (currentDocType === 'CHALLAN') ? 'none' : 'block';
            document.getElementById('item-select').value = '';
            document.getElementById('item-desc').value = '';
            document.getElementById('item-qty').value = '';
            document.getElementById('item-unit').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('item-remarks').value = '';
        }

        function addItemToList() {
            const item = {
                name: document.getElementById('item-select').value, 
                desc: document.getElementById('item-desc').value,
                qty: parseFloat(document.getElementById('item-qty').value) || 0, 
                unit: document.getElementById('item-unit').value,
                price: parseFloat(document.getElementById('item-price').value) || 0, 
                remarks: document.getElementById('item-remarks').value
            };
            item.total = item.qty * item.price;
            docItems.push(item);
            renderDocTable();
            closeModal('item-modal');
        }

        async function getClientAddrFromStorage(name) {
            const clients = await getClients();
            const c = clients.find(client => client.name === name);
            return c ? c.address : "";
        }

        function toggleChequeFields() { 
            document.getElementById('cheque-details').style.display = (document.getElementById('mr-mode').value === 'Cheque' ? 'block' : 'none'); 
        }

        // ==================== INITIALIZATION ====================
        async function syncAllData() {
            const s = await Storage.get('faith_settings') || {};
            if(s.compName) document.getElementById('brand-header').innerText = s.compName;
            if(s.compSlogan) document.getElementById('brand-slogan').innerText = s.compSlogan;
            
            const activeView = document.querySelector('.view-container.active')?.id;
            if(activeView) loadViewData(activeView);

            const gridIds = ['grid-quotation', 'grid-invoice', 'grid-challan', 'grid-po', 'grid-receipt', 'grid-letter'];
            
            for (const gid of gridIds) {
                const grid = document.getElementById(gid);
                if(grid) {
                    const header = grid.querySelector('.nav-header');
                    grid.innerHTML = '';
                    if(header) grid.appendChild(header);
                    
                    if(gid === 'grid-letter') {
                        const letters = await getLetterDocuments();
                        letters.forEach(d => {
                            renderCard(gid, d.id, '#a855f7', 'fa-envelope');
                        });
                    } else {
                        const docs = await getDocs();
                        docs.filter(d => d.grid === gid).forEach(d => {
                            let icon = d.type === 'RECEIPT' ? 'fa-receipt' : 'fa-file-contract';
                            let col = d.type === 'RECEIPT' ? '#34d399' : '#c084fc';
                            renderCard(gid, d.id, col, icon);
                        });
                    }
                }
            }
        }

        window.onload = async () => {
            await syncAllData();
            
            // Listen for real-time updates from Firebase
            Storage.listen('faith_commercial_docs', (docs) => {
                if (docs) {
                    syncAllData();
                }
            });
            
            Storage.listen('faith_letter_docs', (docs) => {
                if (docs) {
                    syncAllData();
                }
            });
            
            Storage.listen('faith_clients', (clients) => {
                if (clients) {
                    renderClients();
                }
            });
            
            Storage.listen('faith_suppliers', (suppliers) => {
                if (suppliers) {
                    renderSuppliers();
                }
            });
            
            Storage.listen('faith_income_records', (records) => {
                if (records) {
                    renderIncome();
                    renderTransactions();
                }
            });
            
            Storage.listen('faith_expense_records', (records) => {
                if (records) {
                    renderExpense();
                    renderTransactions();
                }
            });
            
            Storage.listen('faith_work_orders', (orders) => {
                if (orders) {
                    renderWorkOrders();
                }
            });
            
            window.addEventListener('storage', (e) => {
                syncAllData();
            });
        };
    </script>
</body>
</html>