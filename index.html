<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Faith Engineering | Enterprise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #fbbf24;
            --accent: #38bdf8;
            --bg-dark: #020617;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #4ade80;
        }
        body {
            margin: 0; padding: 0; height: 100vh;
            background: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #f8fafc; overflow: hidden;
            display: flex; flex-direction: column;
        }
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #020617;
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            transition: opacity 0.3s ease;
        }
        .login-container { width: 90%; max-width: 380px; position: relative; }
        .login-glow {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 250px; height: 250px; background: var(--primary);
            filter: blur(80px); opacity: 0.15; z-index: -1;
        }
        .login-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            padding: 40px 30px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.5s ease;
        }
        .login-card i.main-lock {
            font-size: 3rem; color: var(--primary); margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }
        .login-card h2 { margin: 0 0 10px 0; font-size: 1.5rem; letter-spacing: 2px; font-weight: 800; text-transform: uppercase; }
        .login-card p { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 30px; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem; }
        .login-input {
            width: 100%; padding: 14px; padding-left: 45px;
            background: rgba(2, 6, 23, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 12px; color: white;
            font-size: 1rem; transition: all 0.3s ease;
            box-sizing: border-box; outline: none;
        }
        .login-input:focus { border-color: var(--primary); background: rgba(2, 6, 23, 0.8); }
        .login-btn {
            width: 100%; padding: 14px; margin-top: 10px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: none; border-radius: 12px; font-weight: 800;
            cursor: pointer; color: #000; text-transform: uppercase;
            letter-spacing: 1px; transition: transform 0.2s;
        }
        .login-btn:hover { transform: scale(1.02); }
        #loginError {
            color: var(--danger); font-size: 0.8rem; margin-top: 15px;
            background: rgba(239, 68, 68, 0.1); padding: 8px;
            border-radius: 8px; display: none;
        }
        .app-bar {
            padding: 25px 15px 15px;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(15px);
            z-index: 100; position: relative;
        }
        .logout-btn {
            position: absolute; right: 20px; top: 25px;
            width: 40px; height: 40px; border-radius: 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--danger); display: flex;
            align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .logout-btn:hover { background: rgba(239, 68, 68, 0.2); }
        .header-top { display: flex; justify-content: center; margin-bottom: 15px; }
        .app-bar h1 {
            font-size: 1.5rem; margin: 0; font-weight: 900; letter-spacing: 4px;
            text-transform: uppercase; background: linear-gradient(135deg, #ffffff 0%, #fbbf24 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .status-strip { display: flex; justify-content: center; align-items: center; gap: 25px; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; font-weight: 500; color: var(--text-muted); }
        .status-item i { font-size: 0.85rem; color: var(--primary); }
        .content-area { flex: 1; position: relative; overflow: hidden; }
        #mainMenu { padding: 15px; box-sizing: border-box; overflow-y: auto; height: 100%; }
        .view { display: none; width: 100%; height: 100%; animation: slideUp 0.3s ease-out; }
        .view.active { display: block; }
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .nav-card {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            border-radius: 15px; height: 80px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: all 0.2s ease;
            backdrop-filter: blur(5px); position: relative; cursor: pointer;
        }
        .nav-card:active { transform: scale(0.95); }
        .nav-card i { font-size: 1.5rem; margin-bottom: 8px; }
        .nav-card span { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; color: #cbd5e1; text-align: center; }
        .icon-bg { position: absolute; width: 40px; height: 40px; border-radius: 50%; filter: blur(20px); z-index: -1; opacity: 0.2; }
        #detailView { background: var(--bg-dark); display: none; flex-direction: column; box-sizing: border-box; }
        #detailView.active { display: flex; }
        .top-nav { display: flex; align-items: center; gap: 15px; padding: 20px; border-bottom: 1px solid var(--glass-border); background: rgba(15,23,42,0.8); position: sticky; top: 0; z-index: 10; }
        .back-circle { width: 40px; height: 40px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .module-body { flex: 1; padding: 15px; overflow-y: auto; scroll-behavior: smooth; }
        .file-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; border: 1px solid var(--glass-border); }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .file-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 12px; overflow: hidden; position: relative; transition: 0.3s; }
        .file-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .file-preview { height: 100px; display: flex; align-items: center; justify-content: center; background: #0f172a; overflow: hidden; }
        .file-preview img { width: 100%; height: 100%; object-fit: contain; background: #fff; }
        .file-preview i { font-size: 2.5rem; color: var(--text-muted); }
        .file-info { padding: 10px; }
        .file-name { font-size: 0.7rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 8px; color: #e2e8f0; }
        .file-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .file-btn { padding: 6px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-download { background: var(--success); color: #000; }
        .btn-print { background: var(--accent); color: #000; }
        .btn-convert { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .btn-convert:hover { background: rgba(168, 85, 247, 0.3); }
        .btn-delete { background: rgba(239, 68, 68, 0.2); color: var(--danger); grid-column: span 3; margin-top: 5px;}
        .btn-edit { background: rgba(251, 191, 36, 0.2); color: var(--primary); }
        .data-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .add-btn { background: var(--success); color: #000; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .add-btn:hover { background: #22c55e; }
        .table-container { background: rgba(30, 41, 59, 0.4); border-radius: 15px; border: 1px solid var(--glass-border); overflow-x: auto; margin-bottom: 60px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 600px; }
        th { background: rgba(255,255,255,0.05); text-align: left; padding: 15px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        th.center, td.center { text-align: center; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--glass-border); color: #e2e8f0; }
        .total-row-fixed {
            position: sticky; bottom: 0; background: #0f172a; border-top: 2px solid var(--primary);
            color: var(--primary); font-weight: 900; font-size: 1rem; z-index: 5;
        }
        .action-btns { display: flex; gap: 15px; justify-content: center; }
        .edit-btn { color: var(--accent); cursor: pointer; font-size: 1rem; }
        .del-btn { color: var(--danger); cursor: pointer; font-size: 1rem; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; width: 95%; max-width: 650px; border-radius: 20px; border: 1px solid var(--primary); padding: 25px; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; }
        .form-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 10px; border-radius: 8px; color: white; box-sizing: border-box; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .save-btn { flex: 1; background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: 800; cursor: pointer; }
        .cancel-btn { flex: 1; background: rgba(255,255,255,0.1); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
        .quote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .q-item-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.75rem; }
        .q-item-table th { padding: 8px; background: rgba(255,255,255,0.05); }
        .q-item-table td { padding: 5px; border: 1px solid var(--glass-border); }
        .q-item-table input { width: 100%; background: transparent; border: none; color: white; outline: none; padding: 5px; font-size: 0.75rem; }
        .q-total-row { background: rgba(56, 189, 248, 0.1); font-weight: 800; color: var(--accent); }
        .search-results { position: absolute; background: #1e293b; border: 1px solid var(--primary); width: 100%; max-height: 150px; overflow-y: auto; z-index: 100; border-radius: 0 0 8px 8px; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--glass-border); font-size: 0.8rem; }
        .search-item:hover { background: var(--primary); color: #000; }
        .payment-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .payment-option { padding: 10px; border: 1px solid var(--glass-border); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .payment-option.selected { border-color: var(--primary); background: rgba(251, 191, 36, 0.1); }
        .payment-option i { font-size: 1.2rem; margin-bottom: 5px; display: block; color: var(--text-muted); }
        .payment-option.selected i { color: var(--primary); }
        .payment-option span { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .payment-details { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid var(--glass-border); display: none; }
        .payment-details.active { display: block; }
        .home-section, .mgmt-section, .settings-section { margin-bottom: 30px; animation: slideUp 0.5s ease; }
        .home-card, .mgmt-card, .settings-card { background: rgba(30, 41, 59, 0.4); border: 1px solid var(--glass-border); padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .home-title, .mgmt-title, .settings-title { color: var(--primary); font-size: 1.1rem; font-weight: 800; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; border-left: 4px solid var(--primary); padding-left: 12px; }
        .home-text, .mgmt-text { font-size: 0.9rem; line-height: 1.6; color: #e2e8f0; text-align: justify; margin-bottom: 15px; }
        .home-highlight { display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-weight: 600; }
        .md-profile-container { text-align: center; margin-bottom: 25px; }
        .md-photo-frame { width: 140px; height: 140px; border-radius: 25px; margin: 0 auto 15px; overflow: hidden; background: #0f172a; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary); }
        .md-photo-frame img { width: 100%; height: 100%; object-fit: cover; }
        .md-photo-placeholder { font-size: 3rem; color: #1e293b; }
        .md-info-block { text-align: center; margin-bottom: 15px; padding-bottom: 10px; }
        .md-name { font-weight: 800; color: white; font-size: 1.15rem; margin: 0; text-transform: uppercase; }
        .md-titles { font-size: 0.7rem; color: var(--accent); font-weight: 600; margin: 6px 0; line-height: 1.4; }
        .mgmt-msg-box {
            text-align: justify;
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 10px;
            font-size: 0.95rem;
            line-height: 1.8;
            color: #f1f5f9;
        }
        .vvm-container { display: flex; flex-direction: column; gap: 15px; }
        .vvm-item { padding: 20px; border-radius: 18px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .vvm-vision { background: linear-gradient(135deg, rgba(56, 189, 248, 0.1) 0%, rgba(2, 6, 23, 0.8) 100%); border-left: 5px solid var(--accent); }
        .vvm-mission { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(2, 6, 23, 0.8) 100%); border-left: 5px solid var(--primary); }
        .vvm-goals { background: linear-gradient(135deg, rgba(167, 139, 250, 0.1) 0%, rgba(2, 6, 23, 0.8) 100%); border-left: 5px solid #a78bfa; }
        .vvm-values { background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(2, 6, 23, 0.8) 100%); border-left: 5px solid var(--success); }
        .vvm-item i { font-size: 2rem; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); opacity: 0.1; }
        .vvm-item h4 { margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; font-size: 0.9rem; }
        
        .process-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
            position: relative;
            padding-left: 10px;
        }
        .process-step {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 18px;
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2;
        }
        .process-step:hover {
            transform: translateX(10px);
            background: rgba(255, 255, 255, 0.07);
            border-color: var(--accent);
        }
        .step-number {
            width: 45px;
            height: 45px;
            background: var(--bg-dark);
            border: 2px solid var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
            color: var(--primary);
            flex-shrink: 0;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
        }
        .process-step:nth-child(even) .step-number {
            border-color: var(--accent);
            color: var(--accent);
        }
        .step-content { flex: 1; }
        .step-title {
            margin: 0;
            font-weight: 800;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff;
        }
        .step-desc {
            margin: 3px 0 0 0;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .step-icon {
            font-size: 1.4rem;
            color: var(--text-muted);
            opacity: 0.4;
            transition: 0.3s;
        }
        .process-step:hover .step-icon {
            opacity: 1;
            color: var(--primary);
            transform: scale(1.2);
        }
        .process-line {
            position: absolute;
            left: 32px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background: linear-gradient(to bottom, var(--primary), var(--accent), var(--success), var(--primary));
            z-index: 1;
            opacity: 0.3;
        }
        
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 10px; }
        .upload-zone { border: 2px dashed var(--glass-border); border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(0,0,0,0.2); }
        .upload-zone:hover { border-color: var(--primary); background: rgba(251, 191, 36, 0.05); }
        .upload-zone i { font-size: 1.5rem; color: var(--text-muted); margin-bottom: 8px; display: block; }
        .upload-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }
        .upload-preview { width: 100%; height: 60px; border-radius: 8px; margin-top: 10px; object-fit: contain; display: none; border: 1px solid var(--primary); background: #fff; }
        .config-form { display: flex; flex-direction: column; gap: 12px; }
        .config-row { display: flex; flex-direction: column; gap: 5px; }
        .config-row label { font-size: 0.7rem; font-weight: 700; color: var(--accent); text-transform: uppercase; }
        .config-input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 10px; border-radius: 8px; color: white; font-size: 0.85rem; }
        .config-area { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 10px; border-radius: 8px; color: white; font-size: 0.8rem; min-height: 60px; resize: vertical; }
        .save-all-btn { background: var(--success); color: #000; border: none; padding: 12px; border-radius: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-top: 10px; width: 100%; }
        .save-all-btn:hover { background: #22c55e; }
        
        .exp-badge-container { display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 30px 0; padding: 30px; background: radial-gradient(circle at center, rgba(56, 189, 248, 0.15) 0%, transparent 70%); border-radius: 30px; position: relative; border: 1px solid rgba(56, 189, 248, 0.1); }
        .exp-badge-main { text-align: center; position: relative; }
        .exp-number { font-size: 3.5rem; font-weight: 900; color: var(--accent); line-height: 1; display: block; text-shadow: 0 0 20px rgba(56, 189, 248, 0.5); }
        .exp-label { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 3px; color: white; margin-top: 5px; }
        .exp-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120px; height: 120px; border: 2px dashed rgba(56, 189, 248, 0.3); border-radius: 50%; animation: rotate 10s linear infinite; }
        
        .contact-pill { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; font-size: 0.85rem; text-decoration: none; color: inherit; }
        .contact-pill i { color: var(--primary); width: 20px; text-align: center; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        .category-card { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; text-align: center; }
        .category-card i { font-size: 1.2rem; color: var(--primary); margin-bottom: 8px; }
        .category-card span { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #cbd5e1; }
        .category-actions { margin-top: 8px; display: flex; justify-content: center; gap: 8px; }
        .category-btn { background: rgba(255,255,255,0.1); border: none; border-radius: 6px; padding: 4px 8px; color: white; font-size: 0.6rem; cursor: pointer; }
        .add-category-form { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid var(--glass-border); }
        .search-container {
            position: relative;
            margin-bottom: 15px;
            width: 100%;
        }
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-size: 0.85rem;
            box-sizing: border-box;
        }
        .search-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .file-type-icon {
            font-size: 2.5rem;
        }
        .pdf-icon { color: #ef4444; }
        .excel-icon { color: #4ade80; }
        .word-icon { color: #2b579a; }
        .image-icon { color: #3b82f6; }
        .text-icon { color: #94a3b8; }
        .xml-icon { color: #f59e0b; }
        .note-icon { color: #c084fc; }
        .switch-container { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 10px; border: 1px solid var(--glass-border); margin-bottom: 10px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .sfpe-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            margin-top: 20px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, rgba(30, 41, 59, 0.5) 100%);
            border-radius: 24px;
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
            animation: float 4s ease-in-out infinite;
        }
        .sfpe-logo-ring {
            width: 80px; height: 80px;
            background: #fff;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; color: #000; font-size: 1.4rem;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
            z-index: 2;
        }
        .sfpe-pulse {
            position: absolute;
            width: 80px; height: 80px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            animation: pulse 2s linear infinite;
            z-index: 1;
        }
        
        /* Lazy loading styles */
        .lazy-load {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .lazy-load.loaded {
            opacity: 1;
        }
        .skeleton {
            background: linear-gradient(90deg, rgba(30, 41, 59, 0.4) 25%, rgba(30, 41, 59, 0.6) 50%, rgba(30, 41, 59, 0.4) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        .file-card.skeleton .file-preview {
            background: #0f172a;
        }
        .file-card.skeleton .file-name {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .file-card.skeleton .file-actions {
            visibility: hidden;
        }
        .table-row.skeleton td {
            height: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.6); opacity: 0; } }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes rotate { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @media print {
    /* Force the body to be visible and scrollable for the print engine */
    body, html {
        overflow: visible !important;
        height: auto !important;
        display: block !important;
    }

    /* Hide the UI elements that shouldn't be on a PDF */
    .app-bar, .logout-btn, .nav-grid, .modal-overlay, #loginOverlay {
        display: none !important;
    }

    /* Ensure the content area takes up the full page */
    .content-area, #mainMenu, #detailView {
        display: block !important;
        overflow: visible !important;
        position: static !important;
    }
}

    </style>
</head>
<body>
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div id="modalTitle" class="modal-title">Add Record</div>
            <form id="genericForm"></form>
            <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                <button type="button" class="save-btn" id="modalSaveBtn" onclick="saveRecord()">Save Entry</button>
            </div>
        </div>
    </div>
    <div id="loginOverlay">
        <div class="login-glow"></div>
        <div class="login-container">
            <div class="login-card">
                <i class="fas fa-shield-halved main-lock"></i>
                <h2>Faith Engineering</h2>
                <p>Authorized Personnel Only</p>
                <div class="input-group">
                    <i class="fas fa-user-shield"></i>
                    <input type="text" id="loginId" class="login-input" placeholder="User ID">
                </div>
                <div class="input-group">
                    <i class="fas fa-key"></i>
                    <input type="password" id="loginPass" class="login-input" placeholder="Secure Password">
                </div>
                <button class="login-btn" onclick="checkLogin()">System Login</button>
                <div id="loginError"><i class="fas fa-circle-exclamation"></i> Access Denied: Invalid Credentials</div>
            </div>
        </div>
    </div>
    <header class="app-bar">
        <div class="header-top"><h1>FAITH ENGINEERING</h1></div>
        <div class="logout-btn" onclick="logout()" title="Logout"><i class="fas fa-power-off"></i></div>
        <div class="status-strip">
            <div class="status-item"><i class="fa-regular fa-calendar-check"></i><span id="date-display">Loading...</span></div>
            <div class="status-item"><i class="fa-regular fa-clock"></i><span id="clock">00:00</span></div>
        </div>
    </header>
    <main class="content-area">
        <div id="mainMenu" class="view active">
            <div class="nav-grid">
                <div class="nav-card" onclick="openModule('Home', '#38bdf8')"><div class="icon-bg" style="background:#38bdf8"></div><i class="fas fa-house" style="color:#38bdf8"></i><span>Home</span></div>
                <div class="nav-card" onclick="openModule('Mgmt', '#f87171')"><div class="icon-bg" style="background:#f87171"></div><i class="fas fa-user-gear" style="color:#f87171"></i><span>Mgmt</span></div>
                <div class="nav-card" onclick="openModule('Clients', '#4ade80')"><div class="icon-bg" style="background:#4ade80"></div><i class="fas fa-handshake" style="color:#4ade80"></i><span>Clients</span></div>
                <div class="nav-card" onclick="openModule('Supplier', '#2dd4bf')"><div class="icon-bg" style="background:#2dd4bf"></div><i class="fas fa-truck-ramp-box" style="color:#2dd4bf"></i><span>Supplier</span></div>
                <div class="nav-card" onclick="openModule('Products', '#fbbf24')"><div class="icon-bg" style="background:#fbbf24"></div><i class="fas fa-boxes-stacked" style="color:#fbbf24"></i><span>Products</span></div>
                <div class="nav-card" onclick="openModule('Inventory', '#8b5cf6')"><div class="icon-bg" style="background:#8b5cf6"></div><i class="fas fa-warehouse" style="color:#8b5cf6"></i><span>Inventory</span></div>
                <div class="nav-card" onclick="openModule('Docs', '#a78bfa')"><div class="icon-bg" style="background:#a78bfa"></div><i class="fas fa-file-shield" style="color:#a78bfa"></i><span>Docs</span></div>
                <div class="nav-card" onclick="openModule('Quotation', '#c084fc')"><div class="icon-bg" style="background:#c084fc"></div><i class="fas fa-file-signature" style="color:#c084fc"></i><span>Quote</span></div>
                <div class="nav-card" onclick="openModule('Invoice', '#34d399')"><div class="icon-bg" style="background:#34d399"></div><i class="fas fa-file-invoice-dollar" style="color:#34d399"></i><span>Invoice</span></div>
                <div class="nav-card" onclick="openModule('Delivery', '#60a5fa')"><div class="icon-bg" style="background:#60a5fa"></div><i class="fas fa-truck-fast" style="color:#60a5fa"></i><span>Delivery</span></div>
                <div class="nav-card" onclick="openModule('Purchase', '#f472b6')"><div class="icon-bg" style="background:#f472b6"></div><i class="fas fa-cart-shopping" style="color:#f472b6"></i><span>Purchase</span></div>
                <div class="nav-card" onclick="openModule('Receipt', '#fb7185')"><div class="icon-bg" style="background:#fb7185"></div><i class="fas fa-receipt" style="color:#fb7185"></i><span>Receipt</span></div>
                <div class="nav-card" onclick="openModule('Letter', '#f97316')"><div class="icon-bg" style="background:#f97316"></div><i class="fas fa-envelope" style="color:#f97316"></i><span>Letter</span></div>
                <div class="nav-card" onclick="openModule('Work Order', '#f97316')"><div class="icon-bg" style="background:#f97316"></div><i class="fas fa-briefcase" style="color:#f97316"></i><span>Work Order</span></div>
                <div class="nav-card" onclick="openModule('Accounts', '#94a3b8')"><div class="icon-bg" style="background:#94a3b8"></div><i class="fas fa-vault" style="color:#94a3b8"></i><span>Accounts</span></div>
                <div class="nav-card" onclick="openModule('Project', '#818cf8')"><div class="icon-bg" style="background:#818cf8"></div><i class="fas fa-folder-open" style="color:#818cf8"></i><span>Project</span></div>
                <div class="nav-card" onclick="openModule('Settings', '#fb923c')"><div class="icon-bg" style="background:#fb923c"></div><i class="fas fa-sliders" style="color:#fb923c"></i><span>Settings</span></div>
            </div>
        </div>
        <div id="detailView" class="view">
            <div class="top-nav">
                <div class="back-circle" onclick="handleBack()"><i class="fas fa-chevron-left"></i></div>
                <h2 id="detailTitle" style="margin:0; font-size:1.1rem; text-transform: uppercase;">Module</h2>
            </div>
            <div id="moduleContent" class="module-body"></div>
        </div>
    </main>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBV_Ph0Xx1f8C7vNbv-q5mErDhDkxncnkE",
            authDomain: "faithengineering-7f75b.firebaseapp.com",
            databaseURL: "https://faithengineering-7f75b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "faithengineering-7f75b",
            storageBucket: "faithengineering-7f75b.firebasestorage.app",
            messagingSenderId: "333974275134",
            appId: "1:333974275134:web:3eedb2a82ab7aca8f93d6f",
            measurementId: "G-98RSMZ9H22"
        };
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Firebase Storage class with lazy loading support
        class FirebaseStorage {
            constructor() {
                this.db = database;
                this.userId = 'default_user';
                this.rootPath = 'faithengineering';
                this.cache = new Map(); // Simple cache for lazy loading
                this.pendingRequests = new Map(); // Track pending requests
            }
            
            getPath(key) {
                return `${this.rootPath}/${key}`;
            }
            
            async save(key, value) {
                try {
                    const path = this.getPath(key);
                    await this.db.ref(path).set(value);
                    console.log('Data saved to Firebase:', key, value);
                    this.cache.set(key, value); // Update cache
                    return true;
                } catch (error) {
                    console.error('Firebase save error:', error);
                    localStorage.setItem(`fe_${key}`, JSON.stringify(value));
                    this.cache.set(key, value); // Update cache
                    return false;
                }
            }
            
            async get(key, useCache = true) {
                // Return from cache if available and requested
                if (useCache && this.cache.has(key)) {
                    return this.cache.get(key);
                }
                
                // Check if request is already pending
                if (this.pendingRequests.has(key)) {
                    return this.pendingRequests.get(key);
                }
                
                // Create new promise for this request
                const requestPromise = new Promise(async (resolve) => {
                    try {
                        const path = this.getPath(key);
                        const snapshot = await this.db.ref(path).once('value');
                        const value = snapshot.val();
                        this.cache.set(key, value); // Cache the result
                        resolve(value);
                    } catch (error) {
                        console.error('Firebase get error:', error);
                        const localData = localStorage.getItem(`fe_${key}`);
                        const value = localData ? JSON.parse(localData) : null;
                        this.cache.set(key, value); // Cache the result
                        resolve(value);
                    } finally {
                        this.pendingRequests.delete(key); // Remove from pending
                    }
                });
                
                this.pendingRequests.set(key, requestPromise);
                return requestPromise;
            }
            
            async remove(key) {
                try {
                    const path = this.getPath(key);
                    await this.db.ref(path).remove();
                    this.cache.delete(key); // Remove from cache
                    return true;
                } catch (error) {
                    console.error('Firebase remove error:', error);
                    localStorage.removeItem(`fe_${key}`);
                    this.cache.delete(key); // Remove from cache
                    return false;
                }
            }
            
            listen(key, callback) {
                const path = this.getPath(key);
                this.db.ref(path).on('value', (snapshot) => {
                    const value = snapshot.val();
                    this.cache.set(key, value); // Update cache
                    callback(value);
                });
            }
            
            stopListening(key) {
                const path = this.getPath(key);
                this.db.ref(path).off();
            }
            
            async push(key, value) {
                try {
                    const path = this.getPath(key);
                    const newRef = this.db.ref(path).push();
                    await newRef.set(value);
                    
                    // Update cache if it exists
                    if (this.cache.has(key)) {
                        const cached = this.cache.get(key) || [];
                        cached.push(value);
                        this.cache.set(key, cached);
                    }
                    
                    return newRef.key;
                } catch (error) {
                    console.error('Firebase push error:', error);
                    const data = await this.get(key) || [];
                    data.push(value);
                    await this.save(key, data);
                    return data.length - 1;
                }
            }
            
            async updateItem(key, index, value) {
                try {
                    const data = await this.get(key) || [];
                    if (index >= 0 && index < data.length) {
                        data[index] = value;
                        await this.save(key, data);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Firebase updateItem error:', error);
                    return false;
                }
            }
            
            async removeItem(key, index) {
                try {
                    const data = await this.get(key) || [];
                    if (index >= 0 && index < data.length) {
                        data.splice(index, 1);
                        await this.save(key, data);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Firebase removeItem error:', error);
                    return false;
                }
            }
            
            // Clear cache for a specific key
            clearCache(key) {
                this.cache.delete(key);
            }
            
            // Clear all cache
            clearAllCache() {
                this.cache.clear();
            }
        }
        
        // Create global Storage instance
        const Storage = new FirebaseStorage();
        
        // Initialize default data if not exists
        async function initializeDefaultData() {
            const defaultData = {
                'clients': [],
                'contacts': [],
                'suppliers': [],
                'detection': [],
                'protection': [],
                'cctv': [],
                'pa': [],
                'pump': [],
                'door': [],
                'electrical': [],
                'lighting': [],
                'config': { 
                    showLogoInPdf: true, 
                    showSealInPdf: true,
                    companyName: 'Faith Engineering',
                    chairmanName: 'Md. Abul Khair',
                    mdName: 'Engr. Md. Jakaria Ahmed',
                    directorName: 'Management Director',
                    chairmanMsg: 'As the Chairman, my vision is to lead with purpose and social responsibility.',
                    mdMsg: 'We strive for excellence in engineering and safety standards.',
                    directorMsg: 'Operational efficiency and customer satisfaction are our primary goals.',
                    currency: 'à§³',
                    tc_quote: '',
                    tc_inv: '',
                    tc_del: '',
                    tc_po: ''
                },
                'wo_calc': [],
                'wo_files': [],
                'income': [],
                'expense': [],
                'product_categories': ['detection', 'protection', 'cctv', 'pa', 'pump', 'door', 'electrical', 'lighting'],
                'project_categories': [],
                'doc_categories': [],
                'work_order_categories': [], 
                'chairman_photo': '',
                'md_photo': '',
                'director_photo': '',
                'co_logo': '',
                'md_sig': '',
                'doc_sig': '',
                'co_seal': '',
                'received_seal': '',
                'saved_letters': []
            };
            
            const transactionModules = ['quotation', 'invoice', 'delivery', 'purchase', 'receipt', 'letter'];
            transactionModules.forEach(mod => {
                defaultData[`${mod}_saved`] = [];
                defaultData[`${mod}_uploaded`] = [];
            });
            
            // Initialize document categories
            if (!defaultData['doc_categories']) {
                defaultData['doc_categories'] = [];
            }
            
            // Check and initialize each key
            for (const [key, defaultValue] of Object.entries(defaultData)) {
                try {
                    const existing = await Storage.get(key, false); // Don't use cache for initialization
                    if (existing === null || existing === undefined) {
                        await Storage.save(key, defaultValue);
                        console.log(`Initialized ${key} with default data`);
                    }
                } catch (error) {
                    console.error(`Error initializing ${key}:`, error);
                }
            }
            
            // Initialize transaction IDs
            const draftIdData = await Storage.get('draft_transaction_ids', false);
            if (!draftIdData) {
                await Storage.save('draft_transaction_ids', {});
            }
            
            const lastIdData = await Storage.get('last_transaction_ids', false);
            if (!lastIdData) {
                await Storage.save('last_transaction_ids', {
                    quotation: 10079,
                    invoice: 10079,
                    delivery: 10079,
                    purchase: 10079,
                    receipt: 10079,
                    letter: 10079
                });
            }
        }
        
        // Call initialization
        initializeDefaultData().catch(console.error);
        
        let currentModule = '';
        let currentSubModule = '';
        let currentEditIndex = -1;
        let navHistory = [];
        let invoiceItems = [];
        let deliveryItems = [];
        let purchaseItems = [];
        let quoteItems = [];
        let currentDraftId = '';
        let selectedPaymentMode = 'cash';
        let currentLetterEditIndex = -1;
        let lazyLoadObserver = null;
        
        // Initialize Intersection Observer for lazy loading
        function initLazyLoadObserver() {
            if (lazyLoadObserver) return;
            
            lazyLoadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        
                        if (element.classList.contains('lazy-file')) {
                            loadFilePreview(element);
                        } else if (element.classList.contains('lazy-image')) {
                            loadImage(element);
                        } else if (element.classList.contains('lazy-table-row')) {
                            loadTableRow(element);
                        }
                        
                        lazyLoadObserver.unobserve(element);
                    }
                });
            }, {
                root: null,
                rootMargin: '100px',
                threshold: 0.1
            });
        }
        
        function loadFilePreview(element) {
            const fileData = element.dataset.fileData;
            const isImage = element.dataset.isImage === 'true';
            
            if (isImage && fileData) {
                const img = document.createElement('img');
                img.src = fileData;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'contain';
                img.onload = () => {
                    element.innerHTML = '';
                    element.appendChild(img);
                    element.classList.add('loaded');
                };
                img.onerror = () => {
                    element.innerHTML = '<i class="fas fa-file file-type-icon note-icon"></i>';
                    element.classList.add('loaded');
                };
            } else {
                const fileType = element.dataset.fileType || 'note';
                element.innerHTML = `<i class="fas fa-file-${fileType} file-type-icon ${fileType}-icon"></i>`;
                element.classList.add('loaded');
            }
        }
        
        function loadImage(element) {
            const src = element.dataset.src;
            if (src) {
                element.src = src;
                element.onload = () => element.classList.add('loaded');
                element.onerror = () => element.classList.add('loaded');
            }
        }
        
        function loadTableRow(element) {
            element.classList.remove('skeleton');
            element.classList.add('loaded');
        }
        
        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Throttle function for performance
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}.${m}.${y}`;
        }
        
        function scrollToTop() {
            const container = document.getElementById('moduleContent');
            if(container) container.scrollTop = 0;
        }
        
        async function generateDraftID(prefix) {
            const draftIds = await Storage.get('draft_transaction_ids') || {};
            const draftKey = `${prefix}_draft`;
            if (!draftIds[draftKey]) draftIds[draftKey] = 1;
            else draftIds[draftKey] += 1;
            await Storage.save('draft_transaction_ids', draftIds);
            return `DRAFT-${prefix}-${draftIds[draftKey]}`;
        }
        
        async function generateSavedID(prefix) {
            const lastIds = await Storage.get('last_transaction_ids') || {
                quotation: 10079,
                invoice: 10079,
                delivery: 10079,
                purchase: 10079,
                receipt: 10079,
                letter: 10079
            };
            const prefixMap = {
                'Q': 'quotation',
                'INV': 'invoice',
                'DC': 'delivery',
                'PO': 'purchase',
                'MR': 'receipt',
                'LTR': 'letter'
            };
            const type = prefixMap[prefix];
            if(!type) return `FE-${prefix}-${10080}`;
            const lastID = lastIds[type] || 10079;
            const newID = lastID + 1;
            lastIds[type] = newID;
            await Storage.save('last_transaction_ids', lastIds);
            return `FE-${prefix}-${newID}`;
        }
        
        function generateRef() {
            const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const pref = Array.from({length:3}, () => alpha[Math.floor(Math.random()*26)]).join('');
            const num = Math.floor(1000 + Math.random() * 9000);
            return pref + num;
        }
        
        function checkLogin() {
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            const loginOverlay = document.getElementById('loginOverlay');
            
            // Smooth transition for login
            loginOverlay.style.transition = 'opacity 0.5s ease';
            loginOverlay.style.opacity = '0';
            
            setTimeout(() => {
                if (id === '7' && pass === '7') {
                    loginOverlay.style.display = 'none';
                    // Persist session locally
                    localStorage.setItem('fe_session', JSON.stringify({ active: true, timestamp: Date.now() }));
                    document.getElementById('loginError').style.display = 'none';
                    // Reset opacity for next logout
                    loginOverlay.style.opacity = '1';
                } else {
                    loginOverlay.style.opacity = '1';
                    document.getElementById('loginError').style.display = 'block';
                }
            }, 500);
        }
        
        function logout() {
            const loginOverlay = document.getElementById('loginOverlay');
            
            // Show overlay with smooth transition
            loginOverlay.style.display = 'flex';
            setTimeout(() => {
                loginOverlay.style.transition = 'opacity 0.5s ease';
                loginOverlay.style.opacity = '1';
            }, 10);
            
            // Clear session
            localStorage.removeItem('fe_session');
            
            // Reset form fields
            document.getElementById('loginId').value = '';
            document.getElementById('loginPass').value = '';
            document.getElementById('loginError').style.display = 'none';
            
            // Go to home
            goHome();
        }
        
        function handleBack() {
            if (navHistory.length > 0) {
                const prev = navHistory.pop();
                if (prev.type === 'home') {
                    goHome(true);
                } else if (prev.type === 'module') {
                    openModule(prev.name, prev.color, true);
                }
            } else {
                goHome();
            }
        }
        
        function goHome(isBack = false) { 
            if(!isBack) navHistory = [];
            currentModule = '';
            currentSubModule = '';
            document.getElementById('detailView').classList.remove('active'); 
            document.getElementById('mainMenu').classList.add('active'); 
            scrollToTop();
        }
        
        const createFolders = (modKey) => [
            { name: 'Create', icon: 'fa-plus-circle', type: 'create', color: '#4ade80' },
            { name: 'Saved Files', icon: 'fa-file-circle-check', storage: `${modKey}_saved`, color: '#38bdf8' },
            { name: 'Uploaded Files', icon: 'fa-cloud-arrow-up', storage: `${modKey}_uploaded`, color: '#fbbf24' }
        ];
        
        const subModules = {
            'Clients': [
                { name: 'Client List', icon: 'fa-address-book', storage: 'clients' }, 
                { name: 'Contacts', icon: 'fa-id-card-clip', storage: 'contacts' }
            ],
            'Products': [
                { name: 'Master List', icon: 'fa-database', storage: 'master' },
                { name: 'Manage Categories', icon: 'fa-layer-group', type: 'manage_categories', color: '#f59e0b' }
            ],
            'Inventory': [
                { name: 'Stock View', icon: 'fa-warehouse', storage: 'inventory', color: '#8b5cf6' }
            ],
            'Docs': [
                { name: 'Manage Documents', icon: 'fa-layer-group', type: 'manage_docs', color: '#4ade80' }
            ],
            'Quotation': createFolders('quotation'),
            'Invoice': createFolders('invoice'),
            'Delivery': createFolders('delivery'),
            'Purchase': createFolders('purchase'),
            'Receipt': createFolders('receipt'),
            'Letter': createFolders('letter'),
            'Work Order': [
                { name: 'Calculation', icon: 'fa-calculator', storage: 'wo_calc' },
                { name: 'Manage Work Orders', icon: 'fa-folder-tree', type: 'manage_wo_folders', color: '#f97316' }
            ],
            'Accounts': [
                { name: 'Income', icon: 'fa-money-bill-trend-up', storage: 'income', color: '#4ade80' }, 
                { name: 'Expense', icon: 'fa-money-bill-transfer', storage: 'expense', color: '#ef4444' }, 
                { name: 'Transactions', icon: 'fa-list-check', color: '#38bdf8' }
            ],
            'Project': [
                { name: 'Manage Projects', icon: 'fa-layer-group', type: 'manage_projects', color: '#4ade80' }
            ]
        };
        
        const formConfigs = {
            'Client List': ['SL', 'Client Name', 'Address', 'Phone', 'Email'],
            'Contacts': ['SL', 'Name', 'Designation', 'Organization', 'Email', 'Phone'],
            'Supplier': ['SL', 'Organization', 'Address', 'Contact Person', 'Email', 'Phone', 'Product Type'],
            'Products': ['SL', 'Items', 'Description', 'Unit', 'Unit Price', 'Available Quantity'],
            'Master List': ['SL', 'Category', 'Items', 'Description', 'Unit', 'Unit Price', 'Available Quantity'],
            'Calculation': ['SL', 'Date', 'Project', 'Order ID', 'Scope Type', 'Amount', 'Cost', 'Profit'],
            'Income': ['SL', 'Date', 'Purpose', 'Amount'],
            'Expense': ['SL', 'Date', 'Purpose', 'Amount']
        };
        
        async function openModule(name, color, isBack = false) {
            if (!isBack && currentModule === '') {
                navHistory.push({ type: 'home' });
            } else if (!isBack && currentModule !== '' && currentSubModule === '') {
                 navHistory.push({ type: 'module', name: currentModule, color: document.getElementById('detailTitle').style.color });
            }
            
            currentModule = name;
            currentSubModule = '';
            document.getElementById('mainMenu').classList.remove('active');
            const detailView = document.getElementById('detailView');
            detailView.classList.add('active');
            const title = document.getElementById('detailTitle');
            title.innerText = name; title.style.color = color;
            const container = document.getElementById('moduleContent');
            container.innerHTML = '';
            
            if (name === 'Home') await renderHome(container);
            else if (name === 'Mgmt') await renderMgmt(container);
            else if (name === 'Settings') await renderSettings(container);
            else if (name === 'Supplier') await renderDataTable('Supplier', 'suppliers', color);
            else if (name === 'Inventory') await renderInventory(color);
            else if (subModules[name]) {
                if (name === 'Products') {
                    const categories = await Storage.get('product_categories') || [];
                    const productSubModules = [...subModules[name]];
                    categories.forEach(cat => {
                        const formattedCat = cat.charAt(0).toUpperCase() + cat.slice(1);
                        productSubModules.push({ 
                            name: formattedCat, 
                            icon: 'fa-box', 
                            storage: cat,
                            type: 'product_category'
                        });
                    });
                    renderSubModuleGrid(productSubModules, name, color);
                } else if (name === 'Project') {
                    const categories = await Storage.get('project_categories') || [];
                    const projectSubModules = [...subModules[name]];
                    categories.forEach(cat => {
                        projectSubModules.push({ 
                            name: cat, 
                            icon: 'fa-folder', 
                            storage: `project_${cat.toLowerCase().replace(/\s+/g, '_')}`,
                            type: 'project_category'
                        });
                    });
                    renderSubModuleGrid(projectSubModules, name, color);
                } else if (name === 'Docs') {
                    const categories = await Storage.get('doc_categories') || [];
                    const docSubModules = [...subModules[name]];
                    categories.forEach(cat => {
                        docSubModules.push({ 
                            name: cat, 
                            icon: 'fa-folder', 
                            storage: `doc_${cat.toLowerCase().replace(/\s+/g, '_')}`,
                            type: 'doc_category'
                        });
                    });
                    renderSubModuleGrid(docSubModules, name, color);
                } else if (name === 'Work Order') {
                    const categories = await Storage.get('work_order_categories') || [];
                    const woSubModules = [...subModules[name]];
                    categories.forEach(cat => {
                        woSubModules.push({ 
                            name: cat, 
                            icon: 'fa-folder-closed', 
                            storage: `wo_folder_${cat.toLowerCase().replace(/\s+/g, '_')}`,
                            type: 'wo_category'
                        });
                    });
                    renderSubModuleGrid(woSubModules, name, color);
                } else {
                    renderSubModuleGrid(subModules[name], name, color);
                }
            }
            
            currentLetterEditIndex = -1;
            scrollToTop();
        }
        
        function renderSubModuleGrid(items, moduleName, color) {
            const container = document.getElementById('moduleContent');
            const grid = document.createElement('div');
            grid.className = 'nav-grid';
            
            items.forEach(sub => {
                grid.innerHTML += `
                    <div class="nav-card" onclick="handleSubModuleClick('${sub.name}', '${sub.storage || ''}', '${sub.color || color}', '${sub.type || ''}')">
                        <div class="icon-bg" style="background:${sub.color || color}"></div>
                        <i class="fas ${sub.icon}" style="color:${sub.color || color}"></i>
                        <span>${sub.name}</span>
                    </div>`;
            });
            container.appendChild(grid);
        }
        
        async function handleSubModuleClick(subName, storageKey, color, type) {
            navHistory.push({ type: 'module', name: currentModule, color: document.getElementById('detailTitle').style.color });
            currentSubModule = subName;
            
            if (type === 'create') {
                if (currentModule === 'Quotation') renderQuotationCreator(color);
                else if (currentModule === 'Invoice') renderInvoiceCreator(color);
                else if (currentModule === 'Delivery') renderDeliveryCreator(color);
                else if (currentModule === 'Purchase') renderPurchaseCreator(color);
                else if (currentModule === 'Receipt') renderReceiptCreator(color);
                else if (currentModule === 'Letter') renderLetterCreator(color);
                else {
                    const container = document.getElementById('moduleContent');
                    container.innerHTML = `<div style="text-align:center; padding:50px; opacity:0.6;"><i class="fas fa-hammer" style="font-size:3rem; color:${color}; margin-bottom:15px;"></i><br>Creation interface for ${currentModule} coming soon.</div>`;
                }
            } else if (type === 'manage_docs') {
                await renderDocCategories(color);
            } else if (type === 'manage_categories') await renderProductCategories(color);
            else if (type === 'manage_projects') await renderProjectCategories(color);
            else if (type === 'manage_wo_folders') await renderWorkOrderFolders(color);
            else if (type === 'product_category' || type === 'project_category' || type === 'doc_category' || type === 'wo_category') {
                if (type === 'product_category') {
                    await renderProductCategoryData(subName, storageKey, color);
                } else {
                    await renderFileManager(subName, storageKey, color);
                }
            } else if (storageKey.includes('_saved') || storageKey.includes('_uploaded')) {
                if (storageKey && storageKey.includes('_saved')) await renderSavedFilesManager(subName, storageKey, color);
                else await renderFileManager(subName, storageKey, color);
            } else if (subName === 'Calculation') await renderWODataTable(subName, storageKey, color);
            else if (subName === 'Master List') await renderMasterList(color);
            else if (subName === 'Stock View') await renderInventoryView(color);
            else if (subName === 'Income' || subName === 'Expense') await renderAccountsTable(subName, storageKey, color);
            else if (subName === 'Transactions') await renderTransactions(color);
            else {
                const formType = currentModule === 'Products' ? 'Products' : subName;
                await renderDataTable(subName, storageKey, color, formType);
            }
            scrollToTop();
        }
        
        // INVENTORY FUNCTIONS
        async function renderInventory(color) {
            await renderInventoryView(color);
        }

        async function renderInventoryView(color) {
            const container = document.getElementById('moduleContent');
            const categories = await Storage.get('product_categories') || [];
            let inventoryData = [];
            
            // Fetch all products from all categories
            for (const category of categories) {
                const products = await Storage.get(category) || [];
                products.forEach(product => {
                    inventoryData.push({
                        Category: category.charAt(0).toUpperCase() + category.slice(1),
                        Items: product.Items || '',
                        Description: product.Description || '',
                        Quantity: product.Quantity || 0
                    });
                });
            }
            
            container.innerHTML = `
                <div class="data-header">
                    <h3 style="margin:0; font-size:1rem; color:${color}">Inventory Stock View</h3>
                </div>
                <div class="search-container">
                    <input type="text" class="search-input" id="inventorySearch" placeholder="Search inventory..." oninput="filterInventory()">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th class="center">SL</th>
                                <th>Category</th>
                                <th>Items</th>
                                <th>Description</th>
                                <th class="center">Available Quantity</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            ${inventoryData.length === 0 ? 
                                `<tr><td colspan="5" style="text-align:center; opacity:0.5">No inventory items found</td></tr>` : 
                                inventoryData.map((item, idx) => `
                                    <tr data-index="${idx}">
                                        <td class="center">${idx + 1}</td>
                                        <td>${item.Category}</td>
                                        <td style="font-weight:600; color:${color}">${item.Items}</td>
                                        <td style="font-size:0.75rem">${item.Description}</td>
                                        <td class="center" style="font-weight:800; color:${item.Quantity > 0 ? 'var(--success)' : 'var(--danger)'}">${item.Quantity || 0}</td>
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
            `;
        }

        function filterInventory() {
            const searchInput = document.getElementById('inventorySearch');
            const searchTerm = searchInput.value.toLowerCase();
            const tableBody = document.getElementById('inventoryTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let found = false;
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }
                row.style.display = found ? '' : 'none';
            }
        }
        
        // LETTER FUNCTIONS
        async function renderLetterCreator(color, editIndex = -1, editData = null) {
            const container = document.getElementById('moduleContent');
            const isDraft = editIndex === -1 && !editData;
            const ltrID = isDraft ? await generateDraftID('LTR') : (editData ? editData.id : await generateSavedID('LTR'));
            const today = new Date().toISOString().split('T')[0];
            currentDraftId = isDraft ? ltrID : '';
            
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">${editIndex !== -1 ? 'Edit' : 'Create New'} Letter ${isDraft ? '<span style="color:var(--accent); font-size:0.7rem;">(DRAFT)</span>' : ''}</h3>
                    <div class="quote-grid">
                        <div class="form-group">
                            <label>Letter ID</label>
                            <input type="text" id="ltr_id" class="form-input" value="${ltrID}" readonly style="color:${isDraft ? 'var(--accent)' : 'var(--primary)'}; font-weight:800">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="ltr_date" class="form-input" value="${editData ? editData.date : today}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Document Title</label>
                        <input type="text" id="ltr_title" class="form-input" placeholder="Enter letter title" value="${editData ? editData.title : ''}">
                    </div>
                    <div class="form-group">
                        <label>Letter Content (Supports HTML formatting)</label>
                        <textarea id="ltr_content" class="config-area" rows="10" placeholder="Type your letter content here...">${editData ? editData.content : ''}</textarea>
                        <small style="color:var(--text-muted); font-size:0.7rem;">Use &lt;br&gt; for line breaks, &lt;strong&gt; for bold text</small>
                    </div>
                    <button class="save-all-btn" onclick="saveLetter(${editIndex})" style="margin-top:20px;">
                        ${editIndex !== -1 ? 'Update Letter' : 'Save Letter to System'}
                    </button>
                    ${editIndex !== -1 ? `<button class="cancel-btn" onclick="handleSubModuleClick('Saved Files', 'letter_saved', '#f97316')" style="margin-top:10px; width:100%;">Cancel</button>` : ''}
                </div>
            `;
        }

        async function saveLetter(editIndex = -1) {
            const title = document.getElementById('ltr_title').value;
            const content = document.getElementById('ltr_content').value;
            
            if(!title || !content) { 
                alert('Please enter both title and content.'); 
                return; 
            }
            
            const config = await Storage.get('config') || {};
            let finalId = document.getElementById('ltr_id').value;
            const isDraft = finalId.startsWith('DRAFT-');
            if (isDraft && editIndex === -1) finalId = await generateSavedID('LTR');
            
            const letterData = {
                id: finalId,
                title: title,
                date: document.getElementById('ltr_date').value,
                content: content,
                name: `${finalId}_${title}.pdf`,
                type: 'application/pdf',
                createdAt: editIndex === -1 ? new Date().toISOString() : undefined,
                companyName: config.companyName || 'Faith Engineering',
                companyAddress: config.companyAddress || 'Dhaka, Bangladesh',
                signatory: config.signName || '',
                designation: config.signDesig || ''
            };
            
            const saved = await Storage.get('letter_saved') || [];
            if (editIndex !== -1) {
                if (saved[editIndex] && saved[editIndex].createdAt) letterData.createdAt = saved[editIndex].createdAt;
                saved[editIndex] = letterData;
            } else {
                letterData.createdAt = new Date().toISOString();
                saved.push(letterData);
            }
            
            await Storage.save('letter_saved', saved);
            alert(`Letter ${editIndex !== -1 ? 'updated' : 'saved'} successfully!`);
            handleSubModuleClick('Saved Files', 'letter_saved', '#f97316');
        }

        async function downloadLetterPDF(data, fileName) {
            const config = await Storage.get('config') || {};
            const companyLogo = await Storage.get('co_logo') || '';
            const docSignature = await Storage.get('doc_sig') || '';
            const companySeal = await Storage.get('co_seal') || '';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>LETTER - ${data.id}</title>
                    <style>
                        @page { size: auto; margin: 8mm 12mm; }
                        body { font-family: "Times New Roman", Times, serif; margin: 0; color: #000; font-size: 11px; -webkit-print-color-adjust: exact; }
                        .page-header { display: table-header-group; }
                        .page-footer { display: table-footer-group; }
                        
                        .header-wrapper { border-bottom: 3px solid #ef4444; text-align: center; padding-bottom: 8px; margin-bottom: 8px; position: relative; }
                        .pdf-logo { position: absolute; left: 0; top: 0; max-height: 85px; max-width: 170px; object-fit: contain; }
                        .company-name { font-size: 32px; font-weight: bold; color: #ff0000; margin: 0; }
                        .header-line2, .header-line3 { color: #1e40af; font-weight: bold; margin: 1px 0; font-size: 11px; }
                        
                        .footer-wrapper { border-top: 3px solid #10b981; padding-top: 6px; font-size: 10px; font-weight: bold; font-style: italic; color: #1e40af; text-align: center; }
                        
                        .document-title { text-align: center; font-size: 18px; font-weight: bold; color: #1e40af; text-transform: uppercase; margin: 6px 0; padding: 2px; }
                        .info-area { width: 100%; margin-bottom: 6px; border-collapse: collapse; font-size: 11px; }
                        .info-area td { padding: 2px 0; border: none; vertical-align: top; }
                        
                        .letter-content { 
                            text-align: justify; 
                            line-height: 1.6; 
                            font-size: 12px; 
                            margin-top: 15px;
                        }
                        
                        @media print {
                            .footer-wrapper { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background: white; z-index: 1000; }
                        }
                        
                        .signature-section { font-size: 11px; margin-top: 40px; position: relative; page-break-inside: avoid; }
                        .seal-box { position: absolute; bottom: 5px; left: 40%; z-index: 100; }
                    </style>
                </head>
                <body>
                    <table style="width: 100%;">
                        <thead class="page-header">
                            <tr><td>
                                <div class="header-wrapper">
                                    ${config.showLogoInPdf && companyLogo ? `<img src="${companyLogo}" class="pdf-logo">` : ''}
                                    <h1 class="company-name">${config.companyName || 'FAITH ENGINEERING'}</h1>
                                    <p class="header-line2">${config.companyAddress || ''}</p>
                                    <p class="header-line3">Mobile: ${config.mobile || ''} â¢ Email: ${config.email || ''} â¢ Web: ${config.website || ''}</p>
                                </div>
                            </td></tr>
                        </thead>
                        <tfoot class="page-footer">
                            <tr><td><div style="height: 40px;"></div></td></tr> </tfoot>
                        <tbody>
                            <tr><td>
                                <div class="document-title">${data.title || 'OFFICIAL LETTER'}</div>
                                
                                <table class="info-area">
                                    <tr>
                                        <td style="width:60%"></td>
                                        <td style="width:40%; text-align:right">
                                            <strong>No:</strong> ${data.id}<br>
                                            <strong>Date:</strong> ${formatDate(data.date)}
                                        </td>
                                    </tr>
                                </table>

                                <div class="letter-content">
                                    ${data.content.replace(/\n/g, '<br>')}
                                </div>

                                <div class="signature-section">
                                    <div style="text-align:center; width:230px; margin-left: auto;">
                                        ${docSignature ? `<img src="${docSignature}" style="max-height:55px; margin-bottom:-8px; position:relative; z-index:5;">` : '<div style="height:45px;"></div>'}
                                        <div style="border-top:1px solid #000; padding-top:4px;">
                                            <strong>For ${config.companyName || 'Faith Engineering'}</strong><br>
                                            ${data.signatory || config.signName || ''}<br>
                                            ${data.designation || config.signDesig || ''}
                                        </div>
                                    </div>
                                    <div class="seal-box">
                                        ${config.showSealInPdf && companySeal ? `<img src="${companySeal}" style="max-width:80px; opacity:0.9;">` : ''}
                                    </div>
                                </div>
                            </td></tr>
                        </tbody>
                    </table>
                    <div class="footer-wrapper">"${config.slogan || ''}"</div>
                    <script>window.onload = function() { window.print(); setTimeout(function() { window.close(); }, 500); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        async function renderDocCategories(color) {
            const container = document.getElementById('moduleContent');
            const categories = await Storage.get('doc_categories') || [];
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">Manage Document Categories</h3>
                    <p style="color:var(--text-muted); font-size:0.8rem; margin-bottom:20px;">Organize documents into dedicated folders.</p>
                    <div class="category-grid">
                        ${categories.map((cat, idx) => `
                            <div class="category-card">
                                <i class="fas fa-folder"></i>
                                <span>${cat}</span>
                                <div class="category-actions">
                                    <button class="category-btn" style="background:var(--danger);" onclick="deleteDocCategory(${idx})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-category-form">
                        <h4 style="color:var(--accent); margin-top:0; font-size:0.9rem;">Add New Document Category</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newDocCategoryName" class="config-input" placeholder="e.g., Trade License, Certificates" style="flex:1;">
                            <button class="add-btn" onclick="addDocCategory()" style="padding:8px 15px;"><i class="fas fa-plus"></i> Create</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function addDocCategory() {
            const nameInput = document.getElementById('newDocCategoryName');
            const name = nameInput.value.trim();
            if (!name) return;
            const categories = await Storage.get('doc_categories') || [];
            if (categories.includes(name)) { alert('Category exists!'); return; }
            categories.push(name);
            await Storage.save('doc_categories', categories);
            const storageKey = `doc_${name.toLowerCase().replace(/\s+/g, '_')}`;
            await Storage.save(storageKey, []);
            nameInput.value = '';
            await renderDocCategories('#a78bfa');
        }
        
        async function deleteDocCategory(index) {
            if (confirm('Delete this category and all its contents?')) {
                const categories = await Storage.get('doc_categories') || [];
                const catName = categories[index];
                categories.splice(index, 1);
                await Storage.save('doc_categories', categories);
                await Storage.remove(`doc_${catName.toLowerCase().replace(/\s+/g, '_')}`);
                await renderDocCategories('#a78bfa');
            }
        }
        
        async function renderWorkOrderFolders(color) {
            const container = document.getElementById('moduleContent');
            const categories = await Storage.get('work_order_categories') || [];
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">Manage Work Order Folders</h3>
                    <p style="color:var(--text-muted); font-size:0.8rem; margin-bottom:20px;">Organize Work Orders by client or project folders.</p>
                    <div class="category-grid">
                        ${categories.map((cat, idx) => `
                            <div class="category-card">
                                <i class="fas fa-folder-open"></i>
                                <span>${cat}</span>
                                <div class="category-actions">
                                    <button class="category-btn" style="background:var(--danger);" onclick="deleteWOFolder(${idx})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-category-form">
                        <h4 style="color:var(--accent); margin-top:0; font-size:0.9rem;">Add New Folder</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newWOFolderName" class="config-input" placeholder="e.g., Client X Work Orders" style="flex:1;">
                            <button class="add-btn" onclick="addWOFolder()" style="padding:8px 15px;"><i class="fas fa-plus"></i> Create</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function addWOFolder() {
            const nameInput = document.getElementById('newWOFolderName');
            const name = nameInput.value.trim();
            if (!name) return;
            const categories = await Storage.get('work_order_categories') || [];
            if (categories.includes(name)) { alert('Folder exists!'); return; }
            categories.push(name);
            await Storage.save('work_order_categories', categories);
            const storageKey = `wo_folder_${name.toLowerCase().replace(/\s+/g, '_')}`;
            await Storage.save(storageKey, []);
            nameInput.value = '';
            await renderWorkOrderFolders('#f97316');
        }
        
        async function deleteWOFolder(index) {
            if (confirm('Delete this folder and all its contents?')) {
                const categories = await Storage.get('work_order_categories') || [];
                const catName = categories[index];
                categories.splice(index, 1);
                await Storage.save('work_order_categories', categories);
                await Storage.remove(`wo_folder_${catName.toLowerCase().replace(/\s+/g, '_')}`);
                await renderWorkOrderFolders('#f97316');
            }
        }
        
        async function renderDeliveryCreator(color, editIndex = -1, editData = null) {
            const container = document.getElementById('moduleContent');
            const isDraft = editIndex === -1 && !editData;
            const dcID = isDraft ? await generateDraftID('DC') : (editData ? editData.id : await generateSavedID('DC'));
            const today = new Date().toISOString().split('T')[0];
            currentDraftId = isDraft ? dcID : '';
            if (editIndex !== -1 && editData) deliveryItems = editData.items || [];
            else deliveryItems = [];
            
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">${editIndex !== -1 ? 'Edit' : 'Create New'} Delivery Challan ${isDraft ? '<span style="color:var(--accent); font-size:0.7rem;">(DRAFT)</span>' : ''}</h3>
                    <div class="quote-grid">
                        <div class="form-group" style="position:relative">
                            <label>Client Search</label>
                            <input type="text" id="dc_client_search" class="form-input" placeholder="Search Client..." 
                                   value="${editData ? editData.client : ''}" 
                                   oninput="searchDeliveryClients(this.value)">
                            <div id="dc_client_results" class="search-results" style="display:none"></div>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="dc_address" class="form-input" value="${editData ? editData.address : ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Delivery Challan ID</label>
                            <input type="text" id="dc_id" class="form-input" value="${dcID}" readonly style="color:${isDraft ? 'var(--accent)' : 'var(--primary)'}; font-weight:800">
                        </div>
                        <div class="form-group">
                            <label>Order ID</label>
                            <input type="text" id="dc_order_id" class="form-input" placeholder="Enter Order ID" value="${editData ? editData.orderId : ''}">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="dc_date" class="form-input" value="${editData ? editData.date : today}">
                        </div>
                        <div class="form-group">
                            <label>Gate Pass No.</label>
                            <input type="text" id="dc_gate_pass" class="form-input" placeholder="Enter Gate Pass Number" value="${editData ? editData.gatePass : ''}">
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <h4 style="margin:0; color:var(--accent)">Delivery Items</h4>
                        <button class="add-btn" onclick="openDeliveryItemModal()" style="padding:5px 12px; font-size:0.6rem"><i class="fas fa-plus"></i> Add Item</button>
                    </div>
                    <div class="table-container" style="margin-top:10px; min-height:150px;">
                        <table class="q-item-table" id="delivery_table">
                            <thead>
                                <tr>
                                    <th width="5%">SL</th>
                                    <th width="25%">Item</th>
                                    <th width="35%">Description</th>
                                    <th width="10%">Qty</th>
                                    <th width="25%">Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="delivery_items_body"></tbody>
                        </table>
                    </div>
                    <button class="save-all-btn" onclick="saveDeliveryChallan(${editIndex})" style="margin-top:20px;">
                        ${editIndex !== -1 ? 'Update Delivery Challan' : 'Save Delivery Challan to System'}
                    </button>
                    ${editIndex !== -1 ? `<button class="cancel-btn" onclick="handleSubModuleClick('Saved Files', 'delivery_saved', '#60a5fa')" style="margin-top:10px; width:100%;">Cancel</button>` : ''}
                </div>
            `;
            updateDeliveryTable();
        }
        
        async function searchDeliveryClients(val) {
            const results = document.getElementById('dc_client_results');
            if(!val) { results.style.display = 'none'; return; }
            const clients = await Storage.get('clients') || [];
            const filtered = clients.filter(c => c['Client Name'].toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                results.innerHTML = filtered.map(c => `<div class="search-item" onclick="selectDeliveryClient('${c['Client Name']}', '${c.Address}')">${c['Client Name']}</div>`).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectDeliveryClient(name, addr) {
            document.getElementById('dc_client_search').value = name;
            document.getElementById('dc_address').value = addr;
            document.getElementById('dc_client_results').style.display = 'none';
        }
        
        function openDeliveryItemModal(itemIndex = -1) {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('genericForm');
            let itemData = {};
            if (itemIndex !== -1 && deliveryItems[itemIndex]) itemData = deliveryItems[itemIndex];
            title.innerText = itemIndex !== -1 ? "Edit Delivery Item" : "Add Item to Delivery Challan";
            form.innerHTML = `
                <div class="form-group" style="position:relative">
                    <label>Item Name (Search or Manual)</label>
                    <input type="text" id="di_name" class="form-input" value="${itemData.name || ''}" oninput="searchProductsForDelivery(this.value)">
                    <div id="delivery_product_results" class="search-results" style="display:none"></div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="di_desc" class="form-input" style="min-height:60px;">${itemData.desc || ''}</textarea>
                </div>
                <div class="quote-grid">
                    <div class="form-group"><label>Qty</label><input type="number" id="di_qty" class="form-input" value="${itemData.qty || 1}"></div>
                    <div class="form-group"><label>Remarks</label><input type="text" id="di_remarks" class="form-input" placeholder="Any special notes" value="${itemData.remarks || ''}"></div>
                </div>
            `;
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.onclick = () => {
                const item = {
                    name: document.getElementById('di_name').value,
                    desc: document.getElementById('di_desc').value,
                    qty: parseFloat(document.getElementById('di_qty').value) || 0,
                    remarks: document.getElementById('di_remarks').value
                };
                if (itemIndex !== -1) deliveryItems[itemIndex] = item;
                else deliveryItems.push(item);
                updateDeliveryTable();
                closeModal();
            };
            modal.style.display = 'flex';
        }
        
        async function searchProductsForDelivery(val) {
            const results = document.getElementById('delivery_product_results');
            if(!val) { results.style.display = 'none'; return; }
            const categories = await Storage.get('product_categories') || [];
            let allProducts = [];
            for (const k of categories) {
                const products = await Storage.get(k) || [];
                allProducts = [...allProducts, ...products];
            }
            const filtered = allProducts.filter(p => p.Items.toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                results.innerHTML = filtered.map(p => `<div class="search-item" onclick="selectProductForDelivery('${p.Items.replace(/'/g, "\\'")}', '${p.Description.replace(/'/g, "\\'")}')">${p.Items}</div>`).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectProductForDelivery(name, desc) {
            document.getElementById('di_name').value = name;
            document.getElementById('di_desc').value = desc;
            document.getElementById('delivery_product_results').style.display = 'none';
        }
        
        function updateDeliveryTable() {
            const body = document.getElementById('delivery_items_body');
            body.innerHTML = deliveryItems.map((item, idx) => `
                <tr>
                    <td class="center">${idx+1}</td>
                    <td style="font-weight:700">${item.name}</td>
                    <td style="font-size:0.65rem">${item.desc}</td>
                    <td class="center">${item.qty}</td>
                    <td class="center" style="font-size:0.65rem">${item.remarks || '-'}</td>
                    <td class="center" style="width:50px;">
                        <div class="action-btns">
                            <i class="fas fa-pen edit-btn" onclick="openDeliveryItemModal(${idx})" title="Edit Item"></i>
                            <i class="fas fa-trash del-btn" onclick="deleteDeliveryItem(${idx})" title="Delete Item"></i>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function deleteDeliveryItem(index) {
            if(confirm('Delete this item from delivery challan?')) {
                deliveryItems.splice(index, 1);
                updateDeliveryTable();
            }
        }
        
        async function saveDeliveryChallan(editIndex = -1) {
            const client = document.getElementById('dc_client_search').value;
            if(!client || deliveryItems.length === 0) { alert('Please select a client and add at least one item.'); return; }
            const config = await Storage.get('config') || {};
            let finalId = document.getElementById('dc_id').value;
            const isDraft = finalId.startsWith('DRAFT-');
            if (isDraft && editIndex === -1) finalId = await generateSavedID('DC');
            const dcData = {
                id: finalId,
                client: client,
                address: document.getElementById('dc_address').value,
                orderId: document.getElementById('dc_order_id').value,
                date: document.getElementById('dc_date').value,
                gatePass: document.getElementById('dc_gate_pass').value,
                items: deliveryItems,
                name: `${finalId}_${client}.pdf`,
                type: 'application/pdf',
                createdAt: editIndex === -1 ? new Date().toISOString() : undefined,
                companyName: config.companyName || 'Faith Engineering',
                companyAddress: config.companyAddress || 'Dhaka, Bangladesh',
                signatory: config.signName || '',
                designation: config.signDesig || '',
                terms: config.tc_del || ''
            };
            const saved = await Storage.get('delivery_saved') || [];
            if (editIndex !== -1) {
                if (saved[editIndex] && saved[editIndex].createdAt) dcData.createdAt = saved[editIndex].createdAt;
                saved[editIndex] = dcData;
            } else {
                dcData.createdAt = new Date().toISOString();
                saved.push(dcData);
            }
            await Storage.save('delivery_saved', saved);
            alert(`Delivery Challan ${editIndex !== -1 ? 'updated' : 'saved'} successfully!`);
            deliveryItems = [];
            handleSubModuleClick('Saved Files', 'delivery_saved', '#60a5fa');
        }
        
        async function renderPurchaseCreator(color, editIndex = -1, editData = null) {
            const container = document.getElementById('moduleContent');
            const isDraft = editIndex === -1 && !editData;
            const poID = isDraft ? await generateDraftID('PO') : (editData ? editData.id : await generateSavedID('PO'));
            const today = new Date().toISOString().split('T')[0];
            currentDraftId = isDraft ? poID : '';
            if (editIndex !== -1 && editData) purchaseItems = editData.items || [];
            else purchaseItems = [];
            
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">${editIndex !== -1 ? 'Edit' : 'Create New'} Purchase Order ${isDraft ? '<span style="color:var(--accent); font-size:0.7rem;">(DRAFT)</span>' : ''}</h3>
                    <div class="quote-grid">
                        <div class="form-group" style="position:relative">
                            <label>Supplier Search</label>
                            <input type="text" id="po_supplier_search" class="form-input" placeholder="Search Supplier..." value="${editData ? editData.supplier : ''}" oninput="searchSuppliers(this.value)">
                            <div id="po_supplier_results" class="search-results" style="display:none"></div>
                        </div>
                        <div class="form-group"><label>Address</label><input type="text" id="po_address" class="form-input" value="${editData ? editData.address : ''}" readonly></div>
                        <div class="form-group"><label>Purchase Order ID</label><input type="text" id="po_id" class="form-input" value="${poID}" readonly style="color:${isDraft ? 'var(--accent)' : 'var(--primary)'}; font-weight:800"></div>
                        <div class="form-group"><label>Date</label><input type="date" id="po_date" class="form-input" value="${editData ? editData.date : today}"></div>
                        <div class="form-group"><label>Subject</label><input type="text" id="po_subject" class="form-input" placeholder="e.g. Purchase Order for Fire Detection Equipment" value="${editData ? editData.subject : ''}"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <h4 style="margin:0; color:var(--accent)">Purchase Items</h4>
                        <button class="add-btn" onclick="openPurchaseItemModal()" style="padding:5px 12px; font-size:0.6rem"><i class="fas fa-plus"></i> Add Item</button>
                    </div>
                    <div class="table-container" style="margin-top:10px; min-height:150px;">
                        <table class="q-item-table" id="purchase_table">
                            <thead>
                                <tr>
                                    <th width="5%">SL</th>
                                    <th width="35%">Description</th>
                                    <th width="10%">Qty</th>
                                    <th width="10%">Unit</th>
                                    <th width="15%">Unit Price</th>
                                    <th width="15%">Total Price</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchase_items_body"></tbody>
                            <tfoot>
                                <tr class="q-total-row">
                                    <td colspan="5" style="text-align:right; padding:10px;">GRAND TOTAL</td>
                                    <td id="po_grand_total" style="text-align:center; font-weight:900; color:var(--success)">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <button class="save-all-btn" onclick="savePurchaseOrder(${editIndex})" style="margin-top:20px;">${editIndex !== -1 ? 'Update Purchase Order' : 'Save Purchase Order to System'}</button>
                    ${editIndex !== -1 ? `<button class="cancel-btn" onclick="handleSubModuleClick('Saved Files', 'purchase_saved', '#f472b6')" style="margin-top:10px; width:100%;">Cancel</button>` : ''}
                </div>
            `;
            updatePurchaseTable();
        }
        
        async function searchSuppliers(val) {
            const results = document.getElementById('po_supplier_results');
            if(!val) { results.style.display = 'none'; return; }
            const suppliers = await Storage.get('suppliers') || [];
            const filtered = suppliers.filter(s => s.Organization.toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                results.innerHTML = filtered.map(s => `<div class="search-item" onclick="selectSupplier('${s.Organization.replace(/'/g, "\\'")}', '${s.Address.replace(/'/g, "\\'")}')">${s.Organization}</div>`).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectSupplier(name, addr) {
            document.getElementById('po_supplier_search').value = name;
            document.getElementById('po_address').value = addr;
            document.getElementById('po_supplier_results').style.display = 'none';
        }
        
        function openPurchaseItemModal(itemIndex = -1) {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('genericForm');
            let itemData = {};
            if (itemIndex !== -1 && purchaseItems[itemIndex]) itemData = purchaseItems[itemIndex];
            title.innerText = itemIndex !== -1 ? "Edit Purchase Item" : "Add Item to Purchase Order";
            form.innerHTML = `
                <div class="form-group"><label>Description</label><textarea id="pi_desc" class="form-input" style="min-height:60px;" placeholder="Item description">${itemData.desc || ''}</textarea></div>
                <div class="quote-grid">
                    <div class="form-group"><label>Qty</label><input type="number" id="pi_qty" class="form-input" value="${itemData.qty || 1}"></div>
                    <div class="form-group"><label>Unit</label><input type="text" id="pi_unit" class="form-input" placeholder="e.g., pcs, set, meter" value="${itemData.unit || ''}"></div>
                </div>
                <div class="form-group"><label>Unit Price</label><input type="number" id="pi_price" class="form-input" step="0.01" value="${itemData.price || ''}"></div>
            `;
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.onclick = () => {
                const qty = parseFloat(document.getElementById('pi_qty').value) || 0;
                const price = parseFloat(document.getElementById('pi_price').value) || 0;
                const item = {
                    desc: document.getElementById('pi_desc').value,
                    qty: qty,
                    unit: document.getElementById('pi_unit').value,
                    price: price,
                    total: qty * price
                };
                if (itemIndex !== -1) purchaseItems[itemIndex] = item;
                else purchaseItems.push(item);
                updatePurchaseTable();
                closeModal();
            };
            modal.style.display = 'flex';
        }
        
        function updatePurchaseTable() {
            const body = document.getElementById('purchase_items_body');
            let total = 0;
            body.innerHTML = purchaseItems.map((item, idx) => {
                const rowTotal = item.qty * item.price;
                total += rowTotal;
                return `
                    <tr>
                        <td class="center">${idx+1}</td>
                        <td style="font-size:0.65rem">${item.desc}</td>
                        <td class="center">${item.qty}</td>
                        <td class="center">${item.unit}</td>
                        <td class="center">${item.price.toLocaleString()}</td>
                        <td class="center" style="color:var(--success); font-weight:800">${rowTotal.toLocaleString()}</td>
                        <td class="center">
                            <div class="action-btns">
                                <i class="fas fa-pen edit-btn" onclick="openPurchaseItemModal(${idx})" title="Edit Item"></i>
                                <i class="fas fa-trash del-btn" onclick="deletePurchaseItem(${idx})" title="Delete Item"></i>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('po_grand_total').innerText = total.toLocaleString();
        }
        
        function deletePurchaseItem(index) {
            if(confirm('Delete this item from purchase order?')) {
                purchaseItems.splice(index, 1);
                updatePurchaseTable();
            }
        }
        
        async function savePurchaseOrder(editIndex = -1) {
            const supplier = document.getElementById('po_supplier_search').value;
            if(!supplier || purchaseItems.length === 0) { alert('Please select a supplier and add at least one item.'); return; }
            const config = await Storage.get('config') || {};
            let finalId = document.getElementById('po_id').value;
            const isDraft = finalId.startsWith('DRAFT-');
            if (isDraft && editIndex === -1) finalId = await generateSavedID('PO');
            const poData = {
                id: finalId,
                supplier: supplier,
                address: document.getElementById('po_address').value,
                date: document.getElementById('po_date').value,
                subject: document.getElementById('po_subject').value,
                items: purchaseItems,
                total: document.getElementById('po_grand_total').innerText,
                name: `${finalId}_${supplier}.pdf`,
                type: 'application/pdf',
                createdAt: editIndex === -1 ? new Date().toISOString() : undefined,
                companyName: config.companyName || 'Faith Engineering',
                companyAddress: config.companyAddress || 'Dhaka, Bangladesh',
                signatory: config.signName || '',
                designation: config.signDesig || '',
                terms: config.tc_po || ''
            };
            const saved = await Storage.get('purchase_saved') || [];
            if (editIndex !== -1) {
                if (saved[editIndex] && saved[editIndex].createdAt) poData.createdAt = saved[editIndex].createdAt;
                saved[editIndex] = poData;
            } else {
                poData.createdAt = new Date().toISOString();
                saved.push(poData);
            }
            await Storage.save('purchase_saved', saved);
            alert(`Purchase Order ${editIndex !== -1 ? 'updated' : 'saved'} successfully!`);
            purchaseItems = [];
            handleSubModuleClick('Saved Files', 'purchase_saved', '#f472b6');
        }
        
        async function renderReceiptCreator(color, editIndex = -1, editData = null) {
            const container = document.getElementById('moduleContent');
            const isDraft = editIndex === -1 && !editData;
            const mrID = isDraft ? await generateDraftID('MR') : (editData ? editData.id : await generateSavedID('MR'));
            const today = new Date().toISOString().split('T')[0];
            currentDraftId = isDraft ? mrID : '';
            
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">${editIndex !== -1 ? 'Edit' : 'Create New'} Money Receipt ${isDraft ? '<span style="color:var(--accent); font-size:0.7rem;">(DRAFT)</span>' : ''}</h3>
                    <div class="quote-grid">
                        <div class="form-group" style="position:relative">
                            <label>Received From (Client Search)</label>
                            <input type="text" id="mr_client_search" class="form-input" placeholder="Search Client..." value="${editData ? editData.client : ''}" oninput="searchReceiptClients(this.value)">
                            <div id="mr_client_results" class="search-results" style="display:none"></div>
                        </div>
                        <div class="form-group"><label>Address</label><input type="text" id="mr_address" class="form-input" value="${editData ? editData.address : ''}" readonly></div>
                        <div class="form-group"><label>Money Receipt ID</label><input type="text" id="mr_id" class="form-input" value="${mrID}" readonly style="color:${isDraft ? 'var(--accent)' : 'var(--primary)'}; font-weight:800"></div>
                        <div class="form-group"><label>Date</label><input type="date" id="mr_date" class="form-input" value="${editData ? editData.date : today}"></div>
                        <div class="form-group"><label>Received Amount</label><input type="number" id="mr_amount" class="form-input" placeholder="0.00" step="0.01" value="${editData ? editData.amount : ''}"></div>
                        <div class="form-group"><label>Received By</label><input type="text" id="mr_received_by" class="form-input" placeholder="Collector/Personnel Name" value="${editData ? (editData.receivedBy || '') : ''}"></div>
                    </div>
                    <div style="margin:20px 0;">
                        <h4 style="margin:0 0 10px 0; color:var(--accent)">Payment Mode</h4>
                        <div class="payment-options" id="paymentOptions">
                            <div class="payment-option" data-mode="cash" onclick="selectPaymentMode('cash')"><i class="fas fa-money-bill-wave"></i><span>Cash</span></div>
                            <div class="payment-option" data-mode="cheque" onclick="selectPaymentMode('cheque')"><i class="fas fa-money-check"></i><span>Cheque</span></div>
                            <div class="payment-option" data-mode="payorder" onclick="selectPaymentMode('payorder')"><i class="fas fa-file-invoice-dollar"></i><span>Pay Order</span></div>
                            <div class="payment-option" data-mode="bkash" onclick="selectPaymentMode('bkash')"><i class="fas fa-mobile-alt"></i><span>Bkash</span></div>
                            <div class="payment-option" data-mode="mobile" onclick="selectPaymentMode('mobile')"><i class="fas fa-university"></i><span>Mobile Banking</span></div>
                        </div>
                    </div>
                    <div id="chequeDetails" class="payment-details">
                        <div class="quote-grid">
                            <div class="form-group"><label>Cheque No.</label><input type="text" id="mr_cheque_no" class="form-input" placeholder="Cheque Number" value="${editData && editData.paymentMode === 'cheque' ? editData.chequeNo : ''}"></div>
                            <div class="form-group"><label>Bank</label><input type="text" id="mr_bank" class="form-input" placeholder="Bank Name" value="${editData && editData.paymentMode === 'cheque' ? editData.bank : ''}"></div>
                        </div>
                    </div>
                    <button class="save-all-btn" onclick="saveMoneyReceipt(${editIndex})" style="margin-top:20px;">${editIndex !== -1 ? 'Update Money Receipt' : 'Save Money Receipt to System'}</button>
                    ${editIndex !== -1 ? `<button class="cancel-btn" onclick="handleSubModuleClick('Saved Files', 'receipt_saved', '#fb7185')" style="margin-top:10px; width:100%;">Cancel</button>` : ''}
                </div>
            `;
            const mode = editData ? editData.paymentMode : 'cash';
            selectPaymentMode(mode);
        }
        
        function selectPaymentMode(mode) {
            selectedPaymentMode = mode;
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            const target = document.querySelector(`.payment-option[data-mode="${mode}"]`);
            if (target) target.classList.add('selected');
            const chequeDetails = document.getElementById('chequeDetails');
            if (mode === 'cheque') {
                if (chequeDetails) chequeDetails.classList.add('active');
            } else {
                if (chequeDetails) chequeDetails.classList.remove('active');
            }
        }
        
        async function searchReceiptClients(val) {
            const results = document.getElementById('mr_client_results');
            if(!val) { results.style.display = 'none'; return; }
            const clients = await Storage.get('clients') || [];
            const filtered = clients.filter(c => c['Client Name'].toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                results.innerHTML = filtered.map(c => `<div class="search-item" onclick="selectReceiptClient('${c['Client Name']}', '${c.Address}')">${c['Client Name']}</div>`).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectReceiptClient(name, addr) {
            document.getElementById('mr_client_search').value = name;
            document.getElementById('mr_address').value = addr;
            document.getElementById('mr_client_results').style.display = 'none';
        }
        
        async function saveMoneyReceipt(editIndex = -1) {
            const client = document.getElementById('mr_client_search').value;
            const amount = parseFloat(document.getElementById('mr_amount').value);
            const receivedBy = document.getElementById('mr_received_by').value;
            if(!client || !amount || amount <= 0) { alert('Please select a client and enter a valid amount.'); return; }
            const config = await Storage.get('config') || {};
            let finalId = document.getElementById('mr_id').value;
            const isDraft = finalId.startsWith('DRAFT-');
            if (isDraft && editIndex === -1) finalId = await generateSavedID('MR');
            const receiptData = {
                id: finalId,
                client: client,
                address: document.getElementById('mr_address').value,
                date: document.getElementById('mr_date').value,
                amount: amount,
                receivedBy: receivedBy,
                paymentMode: selectedPaymentMode,
                chequeNo: selectedPaymentMode === 'cheque' ? document.getElementById('mr_cheque_no').value : null,
                bank: selectedPaymentMode === 'cheque' ? document.getElementById('mr_bank').value : null,
                name: `${finalId}_${client}.pdf`,
                type: 'application/pdf',
                createdAt: editIndex === -1 ? new Date().toISOString() : undefined,
                companyName: config.companyName || 'Faith Engineering',
                companyAddress: config.companyAddress || 'Dhaka, Bangladesh',
                signatory: config.signName || '',
                designation: config.signDesig || '',
                terms: config.tc_rec || ''
            };
            const saved = await Storage.get('receipt_saved') || [];
            if (editIndex !== -1) {
                if (saved[editIndex] && saved[editIndex].createdAt) receiptData.createdAt = saved[editIndex].createdAt;
                saved[editIndex] = receiptData;
            } else {
                receiptData.createdAt = new Date().toISOString();
                saved.push(receiptData);
            }
            await Storage.save('receipt_saved', saved);
            if (editIndex === -1) {
                const incomeData = await Storage.get('income') || [];
                incomeData.push({
                    Date: receiptData.date,
                    Purpose: `Payment from ${client} via ${selectedPaymentMode}`,
                    Amount: amount.toString()
                });
                await Storage.save('income', incomeData);
            }
            alert(`Money Receipt ${editIndex !== -1 ? 'updated' : 'saved'} successfully!`);
            handleSubModuleClick('Saved Files', 'receipt_saved', '#fb7185');
        }
        
        async function renderInvoiceCreator(color, editIndex = -1, editData = null) {
            const container = document.getElementById('moduleContent');
            const isDraft = editIndex === -1 && !editData;
            const invID = isDraft ? await generateDraftID('INV') : (editData ? editData.id : await generateSavedID('INV'));
            const today = new Date().toISOString().split('T')[0];
            currentDraftId = isDraft ? invID : '';
            if (editIndex !== -1 && editData) invoiceItems = editData.items || [];
            else invoiceItems = [];
            
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">${editIndex !== -1 ? 'Edit' : 'Create New'} Invoice ${isDraft ? '<span style="color:var(--accent); font-size:0.7rem;">(DRAFT)</span>' : ''}</h3>
                    <div class="quote-grid">
                        <div class="form-group" style="position:relative">
                            <label>Client Search</label>
                            <input type="text" id="inv_client_search" class="form-input" placeholder="Search Client..." value="${editData ? editData.client : ''}" oninput="searchInvoiceClients(this.value)">
                            <div id="inv_client_results" class="search-results" style="display:none"></div>
                        </div>
                        <div class="form-group"><label>Address</label><input type="text" id="inv_address" class="form-input" value="${editData ? editData.address : ''}" readonly></div>
                        <div class="form-group"><label>Invoice ID</label><input type="text" id="inv_id" class="form-input" value="${invID}" readonly style="color:${isDraft ? 'var(--accent)' : 'var(--primary)'}; font-weight:800"></div>
                        <div class="form-group"><label>Order ID</label><input type="text" id="inv_order_id" class="form-input" placeholder="Enter Order ID" value="${editData ? editData.orderId : ''}"></div>
                        <div class="form-group"><label>Date</label><input type="date" id="inv_date" class="form-input" value="${editData ? editData.date : today}"></div>
                        <div class="form-group"><label>Paid Amount</label><input type="number" id="inv_paid_amount" class="form-input" placeholder="0.00" value="${editData ? editData.paidAmount : '0'}" oninput="updateInvoiceTable()"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <h4 style="margin:0; color:var(--accent)">Invoice Items</h4>
                        <button class="add-btn" onclick="openInvoiceItemModal()" style="padding:5px 12px; font-size:0.6rem"><i class="fas fa-plus"></i> Add Item</button>
                    </div>
                    <div class="table-container" style="margin-top:10px; min-height:150px;">
                        <table class="q-item-table" id="invoice_table">
                            <thead>
                                <tr>
                                    <th width="5%">SL</th>
                                    <th width="25%">Item</th>
                                    <th width="30%">Description</th>
                                    <th width="10%">Qty</th>
                                    <th width="15%">Unit Price</th>
                                    <th width="15%">Total Price</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoice_items_body"></tbody>
                            <tfoot>
                                <tr class="q-total-row">
                                    <td colspan="5" style="text-align:right; padding:10px;">GRAND TOTAL</td>
                                    <td id="inv_grand_total" style="text-align:center; font-weight:900; color:var(--success)">0.00</td>
                                    <td></td>
                                </tr>
                                <tr style="background: rgba(239, 68, 68, 0.1);">
                                    <td colspan="5" style="text-align:right; padding:10px; font-weight:800; color:var(--danger);">DUE AMOUNT</td>
                                    <td id="inv_due_total" style="text-align:center; font-weight:900; color:var(--danger)">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <button class="save-all-btn" onclick="saveInvoice(${editIndex})" style="margin-top:20px;">${editIndex !== -1 ? 'Update Invoice' : 'Save Invoice to System'}</button>
                    ${editIndex !== -1 ? `<button class="cancel-btn" onclick="handleSubModuleClick('Saved Files', 'invoice_saved', '#34d399')" style="margin-top:10px; width:100%;">Cancel</button>` : ''}
                </div>
            `;
            updateInvoiceTable();
        }
        
        async function searchInvoiceClients(val) {
            const results = document.getElementById('inv_client_results');
            if(!val) { results.style.display = 'none'; return; }
            const clients = await Storage.get('clients') || [];
            const filtered = clients.filter(c => c['Client Name'].toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                results.innerHTML = filtered.map(c => `<div class="search-item" onclick="selectInvoiceClient('${c['Client Name']}', '${c.Address}')">${c['Client Name']}</div>`).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectInvoiceClient(name, addr) {
            document.getElementById('inv_client_search').value = name;
            document.getElementById('inv_address').value = addr;
            document.getElementById('inv_client_results').style.display = 'none';
        }
        
        function openInvoiceItemModal(itemIndex = -1) {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('genericForm');
            let itemData = {};
            if (itemIndex !== -1 && invoiceItems[itemIndex]) itemData = invoiceItems[itemIndex];
            title.innerText = itemIndex !== -1 ? "Edit Invoice Item" : "Add Item to Invoice";
            form.innerHTML = `
                <div class="form-group" style="position:relative">
                    <label>Item Name (Search from Products)</label>
                    <input type="text" id="inv_item_name" class="form-input" value="${itemData.name || ''}" oninput="searchProductsForInvoice(this.value)">
                    <div id="inv_product_results" class="search-results" style="display:none"></div>
                </div>
                <div class="form-group"><label>Description</label><textarea id="inv_item_desc" class="form-input" style="min-height:60px;">${itemData.desc || ''}</textarea></div>
                <div class="quote-grid">
                    <div class="form-group"><label>Qty</label><input type="number" id="inv_item_qty" class="form-input" value="${itemData.qty || 1}"></div>
                    <div class="form-group"><label>Unit Price</label><input type="number" id="inv_item_price" class="form-input" step="0.01" value="${itemData.price || ''}"></div>
                </div>
            `;
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.onclick = () => {
                const item = {
                    name: document.getElementById('inv_item_name').value,
                    desc: document.getElementById('inv_item_desc').value,
                    qty: parseFloat(document.getElementById('inv_item_qty').value) || 0,
                    price: parseFloat(document.getElementById('inv_item_price').value) || 0
                };
                if (itemIndex !== -1) invoiceItems[itemIndex] = item;
                else invoiceItems.push(item);
                updateInvoiceTable();
                closeModal();
            };
            modal.style.display = 'flex';
        }
        
        async function searchProductsForInvoice(val) {
            const results = document.getElementById('inv_product_results');
            if(!val) { results.style.display = 'none'; return; }
            const categories = await Storage.get('product_categories') || [];
            let allProducts = [];
            for (const k of categories) {
                const products = await Storage.get(k) || [];
                allProducts = [...allProducts, ...products];
            }
            const filtered = allProducts.filter(p => p.Items.toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                results.innerHTML = filtered.map(p => `<div class="search-item" onclick="selectProductForInvoice('${p.Items.replace(/'/g, "\\'")}', '${p.Description.replace(/'/g, "\\'")}', '${p['Unit Price']}')">${p.Items} - <small>${p['Unit Price']}</small></div>`).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectProductForInvoice(name, desc, price) {
            document.getElementById('inv_item_name').value = name;
            document.getElementById('inv_item_desc').value = desc;
            document.getElementById('inv_item_price').value = price;
            document.getElementById('inv_product_results').style.display = 'none';
        }
        
        function updateInvoiceTable() {
            const body = document.getElementById('invoice_items_body');
            let total = 0;
            body.innerHTML = invoiceItems.map((item, idx) => {
                const rowTotal = item.qty * item.price;
                total += rowTotal;
                return `
                    <tr>
                        <td class="center">${idx+1}</td>
                        <td style="font-weight:700">${item.name}</td>
                        <td style="font-size:0.65rem">${item.desc}</td>
                        <td class="center">${item.qty}</td>
                        <td class="center">${item.price.toLocaleString()}</td>
                        <td class="center" style="color:var(--success); font-weight:800">${rowTotal.toLocaleString()}</td>
                        <td class="center">
                            <div class="action-btns">
                                <i class="fas fa-pen edit-btn" onclick="openInvoiceItemModal(${idx})" title="Edit Item"></i>
                                <i class="fas fa-trash del-btn" onclick="deleteInvoiceItem(${idx})" title="Delete Item"></i>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            const paidAmount = parseFloat(document.getElementById('inv_paid_amount').value) || 0;
            const dueAmount = total - paidAmount;
            document.getElementById('inv_grand_total').innerText = total.toLocaleString();
            document.getElementById('inv_due_total').innerText = dueAmount.toLocaleString();
        }
        
        function deleteInvoiceItem(index) {
            if(confirm('Delete this item from invoice?')) {
                invoiceItems.splice(index, 1);
                updateInvoiceTable();
            }
        }
        
        async function saveInvoice(editIndex = -1) {
            const client = document.getElementById('inv_client_search').value;
            if(!client || invoiceItems.length === 0) { alert('Please select a client and add at least one item.'); return; }
            const config = await Storage.get('config') || {};
            let finalId = document.getElementById('inv_id').value;
            const isDraft = finalId.startsWith('DRAFT-');
            if (isDraft && editIndex === -1) finalId = await generateSavedID('INV');
            const invData = {
                id: finalId,
                client: client,
                address: document.getElementById('inv_address').value,
                orderId: document.getElementById('inv_order_id').value,
                date: document.getElementById('inv_date').value,
                paidAmount: document.getElementById('inv_paid_amount').value,
                items: invoiceItems,
                total: document.getElementById('inv_grand_total').innerText,
                name: `${finalId}_${client}.pdf`,
                type: 'application/pdf',
                createdAt: editIndex === -1 ? new Date().toISOString() : undefined,
                companyName: config.companyName || 'Faith Engineering',
                companyAddress: config.companyAddress || 'Dhaka, Bangladesh',
                signatory: config.signName || '',
                designation: config.signDesig || '',
                terms: config.tc_inv || ''
            };
            const saved = await Storage.get('invoice_saved') || [];
            if (editIndex !== -1) {
                if (saved[editIndex] && saved[editIndex].createdAt) invData.createdAt = saved[editIndex].createdAt;
                saved[editIndex] = invData;
            } else {
                invData.createdAt = new Date().toISOString();
                saved.push(invData);
            }
            await Storage.save('invoice_saved', saved);
            alert(`Invoice ${editIndex !== -1 ? 'updated' : 'saved'} successfully!`);
            invoiceItems = [];
            handleSubModuleClick('Saved Files', 'invoice_saved', '#34d399');
        }
        
        async function renderQuotationCreator(color, editIndex = -1, editData = null) {
            const container = document.getElementById('moduleContent');
            const isDraft = editIndex === -1 && !editData;
            const qid = isDraft ? await generateDraftID('Q') : (editData ? editData.id : await generateSavedID('Q'));
            const ref = editData ? editData.ref : generateRef();
            const today = new Date().toISOString().split('T')[0];
            currentDraftId = isDraft ? qid : '';
            if (editIndex !== -1 && editData) quoteItems = editData.items || [];
            else quoteItems = [];
            
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">${editIndex !== -1 ? 'Edit' : 'Create New'} Quotation ${isDraft ? '<span style="color:var(--accent); font-size:0.7rem;">(DRAFT)</span>' : ''}</h3>
                    <div class="quote-grid">
                        <div class="form-group" style="position:relative">
                            <label>Client Search</label>
                            <input type="text" id="q_client_search" class="form-input" placeholder="Search Client..." value="${editData ? editData.client : ''}" oninput="searchClients(this.value)">
                            <div id="client_results" class="search-results" style="display:none"></div>
                        </div>
                        <div class="form-group"><label>Address</label><input type="text" id="q_address" class="form-input" value="${editData ? editData.address : ''}" readonly></div>
                        <div class="form-group"><label>Quotation ID</label><input type="text" id="q_id" class="form-input" value="${qid}" readonly style="color:${isDraft ? 'var(--accent)' : 'var(--primary)'}; font-weight:800"></div>
                        <div class="form-group"><label>Reference</label><input type="text" id="q_ref" class="form-input" value="${ref}" readonly></div>
                        <div class="form-group"><label>Date</label><input type="date" id="q_date" class="form-input" value="${editData ? editData.date : today}"></div>
                        <div class="form-group"><label>Subject</label><input type="text" id="q_sub" class="form-input" placeholder="e.g. Quotation for Fire Detection System" value="${editData ? editData.subject : ''}"></div>
                    </div>
                    <div class="quote-grid">
                        <div class="form-group"><label>VAT (%)</label><input type="number" id="q_vat_perc" class="form-input" placeholder="e.g. 5" value="${editData ? (editData.vatPerc || '') : ''}"></div>
                        <div class="form-group"><label>AIT (%)</label><input type="number" id="q_ait_perc" class="form-input" placeholder="e.g. 2" value="${editData ? (editData.aitPerc || '') : ''}"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <h4 style="margin:0; color:var(--accent)">Item List</h4>
                        <button class="add-btn" onclick="openQuoteItemModal()" style="padding:5px 12px; font-size:0.6rem"><i class="fas fa-plus"></i> Add Item</button>
                    </div>
                    <div class="table-container" style="margin-top:10px; min-height:150px;">
                        <table class="q-item-table" id="quote_table">
                            <thead>
                                <tr>
                                    <th width="5%">SL</th>
                                    <th width="25%">Item</th>
                                    <th width="35%">Description</th>
                                    <th width="8%">Qty</th>
                                    <th width="8%">Unit</th>
                                    <th width="10%">Price</th>
                                    <th width="10%">Total</th>
                                    <th width="5%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quote_items_body"></tbody>
                            <tfoot>
                                <tr class="q-total-row">
                                    <td colspan="6" style="text-align:right; padding:10px;">TOTAL</td>
                                    <td id="q_grand_total" style="text-align:center; font-weight:900; color:var(--success)">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <button class="save-all-btn" onclick="saveQuotation(${editIndex})" style="margin-top:20px;">${editIndex !== -1 ? 'Update Quotation' : 'Save Quotation to System'}</button>
                    ${editIndex !== -1 ? `<button class="cancel-btn" onclick="handleSubModuleClick('Saved Files', 'quotation_saved', '#c084fc')" style="margin-top:10px; width:100%;">Cancel</button>` : ''}
                </div>
            `;
            updateQuoteTable();
        }
        
        async function searchClients(val) {
            const results = document.getElementById('client_results');
            if(!val) { results.style.display = 'none'; return; }
            const clients = await Storage.get('clients') || [];
            const filtered = clients.filter(c => c['Client Name'].toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                results.innerHTML = filtered.map(c => `<div class="search-item" onclick="selectClient('${c['Client Name']}', '${c.Address}')">${c['Client Name']}</div>`).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectClient(name, addr) {
            document.getElementById('q_client_search').value = name;
            document.getElementById('q_address').value = addr;
            document.getElementById('client_results').style.display = 'none';
        }
        
        function openQuoteItemModal(itemIndex = -1) {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('genericForm');
            let itemData = {};
            if (itemIndex !== -1 && quoteItems[itemIndex]) itemData = quoteItems[itemIndex];
            title.innerText = itemIndex !== -1 ? "Edit Quotation Item" : "Add Item to Quotation";
            form.innerHTML = `
                <div class="form-group" style="position:relative">
                    <label>Item Name (Search or Manual)</label>
                    <input type="text" id="qi_name" class="form-input" value="${itemData.name || ''}" oninput="searchProducts(this.value)">
                    <div id="product_results" class="search-results" style="display:none"></div>
                </div>
                <div class="form-group"><label>Description</label><textarea id="qi_desc" class="form-input" style="min-height:60px;">${itemData.desc || ''}</textarea></div>
                <div class="quote-grid">
                    <div class="form-group"><label>Qty</label><input type="number" id="qi_qty" class="form-input" value="${itemData.qty || 1}"></div>
                    <div class="form-group"><label>Unit</label><input type="text" id="qi_unit" class="form-input" value="${itemData.unit || ''}"></div>
                </div>
                <div class="form-group"><label>Unit Price</label><input type="number" id="qi_price" class="form-input" value="${itemData.price || ''}"></div>
            `;
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.onclick = () => {
                const item = {
                    name: document.getElementById('qi_name').value,
                    desc: document.getElementById('qi_desc').value,
                    qty: parseFloat(document.getElementById('qi_qty').value) || 0,
                    unit: document.getElementById('qi_unit').value,
                    price: parseFloat(document.getElementById('qi_price').value) || 0
                };
                if (itemIndex !== -1) quoteItems[itemIndex] = item;
                else quoteItems.push(item);
                updateQuoteTable();
                closeModal();
            };
            modal.style.display = 'flex';
        }
        
        async function searchProducts(val) {
            const results = document.getElementById('product_results');
            if(!val) { results.style.display = 'none'; return; }
            const categories = await Storage.get('product_categories') || [];
            let allProducts = [];
            for (const k of categories) {
                const products = await Storage.get(k) || [];
                allProducts = [...allProducts, ...products];
            }
            const filtered = allProducts.filter(p => p.Items.toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                results.innerHTML = filtered.map(p => `<div class="search-item" onclick="selectProduct('${p.Items.replace(/'/g, "\\'")}', '${p.Description.replace(/'/g, "\\'")}', '${p.Unit}', '${p['Unit Price']}')">${p.Items} - <small>${p['Unit Price']}</small></div>`).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectProduct(name, desc, unit, price) {
            document.getElementById('qi_name').value = name;
            document.getElementById('qi_desc').value = desc;
            document.getElementById('qi_unit').value = unit;
            document.getElementById('qi_price').value = price;
            document.getElementById('product_results').style.display = 'none';
        }
        
        function updateQuoteTable() {
            const body = document.getElementById('quote_items_body');
            let total = 0;
            body.innerHTML = quoteItems.map((item, idx) => {
                const rowTotal = item.qty * item.price;
                total += rowTotal;
                return `
                    <tr>
                        <td class="center">${idx+1}</td>
                        <td style="font-weight:700">${item.name}</td>
                        <td style="font-size:0.65rem">${item.desc}</td>
                        <td class="center">${item.qty}</td>
                        <td class="center">${item.unit}</td>
                        <td class="center">${item.price.toLocaleString()}</td>
                        <td class="center" style="color:var(--success); font-weight:800">${rowTotal.toLocaleString()}</td>
                        <td class="center">
                            <div class="action-btns">
                                <i class="fas fa-pen edit-btn" onclick="openQuoteItemModal(${idx})" title="Edit Item"></i>
                                <i class="fas fa-trash del-btn" onclick="deleteQuoteItem(${idx})" title="Delete Item"></i>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('q_grand_total').innerText = total.toLocaleString();
        }
        
        function deleteQuoteItem(index) {
            if(confirm('Delete this item from quotation?')) {
                quoteItems.splice(index, 1);
                updateQuoteTable();
            }
        }
        
        async function saveQuotation(editIndex = -1) {
            const client = document.getElementById('q_client_search').value;
            if(!client || quoteItems.length === 0) { alert('Please select a client and add at least one item.'); return; }
            const config = await Storage.get('config') || {};
            let finalId = document.getElementById('q_id').value;
            const isDraft = finalId.startsWith('DRAFT-');
            if (isDraft && editIndex === -1) finalId = await generateSavedID('Q');
            const quoteData = {
                id: finalId,
                ref: document.getElementById('q_ref').value,
                client: client,
                address: document.getElementById('q_address').value,
                date: document.getElementById('q_date').value,
                subject: document.getElementById('q_sub').value,
                vatPerc: document.getElementById('q_vat_perc').value,
                aitPerc: document.getElementById('q_ait_perc').value,
                items: quoteItems,
                total: document.getElementById('q_grand_total').innerText,
                name: `${finalId}_${client}.pdf`,
                type: 'application/pdf',
                createdAt: editIndex === -1 ? new Date().toISOString() : undefined,
                companyName: config.companyName || 'Faith Engineering',
                companyAddress: config.companyAddress || 'Dhaka, Bangladesh',
                signatory: config.signName || '',
                designation: config.signDesig || '',
                terms: config.tc_quote || ''
            };
            const saved = await Storage.get('quotation_saved') || [];
            if (editIndex !== -1) {
                if (saved[editIndex] && saved[editIndex].createdAt) quoteData.createdAt = saved[editIndex].createdAt;
                saved[editIndex] = quoteData;
            } else {
                quoteData.createdAt = new Date().toISOString();
                saved.push(quoteData);
            }
            await Storage.save('quotation_saved', saved);
            alert(`Quotation ${editIndex !== -1 ? 'updated' : 'saved'} successfully!`);
            quoteItems = [];
            handleSubModuleClick('Saved Files', 'quotation_saved', '#c084fc');
        }
        
        async function downloadPDF(data, fileName) {
            const config = await Storage.get('config') || {};
            let docType = 'DOCUMENT';
            let isDelivery = false;
            let isQuotation = false;
            let isInvoice = false;
            let isReceipt = false;
            let isLetter = false;
            
            if (data.id.startsWith('FE-Q-') || data.id.startsWith('DRAFT-Q-')) {
                docType = 'QUOTATION';
                isQuotation = true;
            } else if (data.id.startsWith('FE-INV-') || data.id.startsWith('DRAFT-INV-')) {
                docType = 'INVOICE';
                isInvoice = true;
            } else if (data.id.startsWith('FE-DC-') || data.id.startsWith('DRAFT-DC-')) {
                docType = 'DELIVERY CHALLAN';
                isDelivery = true;
            } else if (data.id.startsWith('FE-PO-') || data.id.startsWith('DRAFT-PO-')) {
                docType = 'PURCHASE ORDER';
            } else if (data.id.startsWith('FE-MR-') || data.id.startsWith('DRAFT-MR-')) {
                docType = 'MONEY RECEIPT';
                isReceipt = true;
            } else if (data.id.startsWith('FE-LTR-') || data.id.startsWith('DRAFT-LTR-')) {
                docType = data.title || 'OFFICIAL LETTER';
                isLetter = true;
            }
            
            const formatDateForPDF = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const d = String(date.getDate()).padStart(2, '0');
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const y = date.getFullYear();
                return `${d}.${m}.${y}`;
            };
            
            const companyLogo = await Storage.get('co_logo') || '';
            const docSignature = await Storage.get('doc_sig') || '';
            const companySeal = await Storage.get('co_seal') || '';
            const receivedBySeal = await Storage.get('received_seal') || '';
            
            // For Letter, use different PDF generation
            if (isLetter) {
                await downloadLetterPDF(data, fileName);
                return;
            }
            
            let itemsHTML = '';
            let totalAmount = 0;
            const cur = config.currency || 'à§³';
            
            function numberToWords(num) {
                const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
                const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
                const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
                if (num === 0) return 'Zero Only';
                function convertLessThanOneThousand(n) {
                    let result = '';
                    if (n >= 100) { result += ones[Math.floor(n / 100)] + ' Hundred '; n %= 100; }
                    if (n >= 20) { result += tens[Math.floor(n / 10)] + ' '; n %= 10; }
                    if (n >= 10) { result += teens[n - 10] + ' '; n = 0; }
                    if (n > 0) { result += ones[n] + ' '; }
                    return result;
                }
                let result = '';
                if (num >= 10000000) { result += convertLessThanOneThousand(Math.floor(num / 10000000)) + 'Crore '; num %= 10000000; }
                if (num >= 100000) { result += convertLessThanOneThousand(Math.floor(num / 100000)) + 'Lakh '; num %= 100000; }
                if (num >= 1000) { result += convertLessThanOneThousand(Math.floor(num / 1000)) + 'Thousand '; num %= 1000; }
                if (num > 0) { result += convertLessThanOneThousand(num); }
                return result.trim() + ' Only';
            }
            
            let tableInnerHTML = '';
            let dueAmountForWords = 0;
            let grandTotalForWords = 0;

            if (!isReceipt && data.items && data.items.length > 0) {
                 if (isDelivery) {
                    tableInnerHTML = `
                        <thead>
                            <tr>
                                <th style="width:5%;">S. L.</th>
                                <th style="width:25%;">Items</th>
                                <th style="width:45%;">Description</th>
                                <th style="width:10%;">Qty</th>
                                <th style="width:15%;">Remarks</th>
                            </tr>
                        </thead>
                        <tbody class="table-data">
                    `;
                    data.items.forEach((item, index) => {
                        tableInnerHTML += `
                            <tr>
                                <td style="text-align:center;">${index + 1}</td>
                                <td>${item.name || ''}</td>
                                <td>${item.desc || ''}</td>
                                <td style="text-align:center;">${item.qty || ''}</td>
                                <td style="text-align:center;">${item.remarks || ''}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableInnerHTML = `
                        <thead>
                            <tr>
                                <th style="width:5%;">S.L.</th>
                                <th style="width:${isQuotation ? '25%' : '30%'};">Items</th>
                                <th style="width:${isQuotation ? '30%' : '25%'};">Description</th>
                                <th style="width:8%;">Qty</th>
                                ${isQuotation ? '<th style="width:8%;">Unit</th>' : ''}
                                <th style="width:12%;">Unit Price</th>
                                <th style="width:12%;">Total Price</th>
                            </tr>
                        </thead>
                        <tbody class="table-data">
                    `;
                    data.items.forEach((item, index) => {
                        const rowTotal = item.qty * (item.price || 0);
                        totalAmount += rowTotal;
                        tableInnerHTML += `
                            <tr>
                                <td style="text-align:center;">${index + 1}</td>
                                <td>${item.name || item.desc || ''}</td>
                                <td>${item.desc || ''}</td>
                                <td style="text-align:center;">${item.qty || ''}</td>
                                ${isQuotation ? `<td style="text-align:center;">${item.unit || ''}</td>` : ''}
                                <td style="text-align:center;">${cur} ${item.price ? item.price.toLocaleString() : ''}</td>
                                <td style="text-align:center;">${cur} ${rowTotal ? rowTotal.toLocaleString() : ''}</td>
                            </tr>
                        `;
                    });
                }
                
                let summaryHTML = '';
                if (!isDelivery) {
                    summaryHTML = `
                        <tr class="final-total-row" style="font-size: 11px;">
                            <td colspan="${isQuotation ? '6' : '5'}" style="text-align:right; font-weight:bold; border: 1px solid #000;">TOTAL</td>
                            <td style="text-align:center; font-weight:bold; border: 1px solid #000;">${cur} ${totalAmount.toLocaleString()}</td>
                        </tr>
                    `;

                    let runningGrandTotal = totalAmount;

                    if(isQuotation) {
                        const vPerc = parseFloat(data.vatPerc) || 0;
                        const aPerc = parseFloat(data.aitPerc) || 0;
                        
                        if(vPerc > 0) {
                            const vAmt = totalAmount * (vPerc / 100);
                            runningGrandTotal += vAmt;
                            summaryHTML += `
                                <tr style="font-size: 11px;">
                                    <td colspan="6" style="text-align:right; border: 1px solid #000;">VAT (${vPerc}%)</td>
                                    <td style="text-align:center; border: 1px solid #000;">${cur} ${vAmt.toLocaleString()}</td>
                                </tr>
                            `;
                        }
                        if(aPerc > 0) {
                            const aAmt = totalAmount * (aPerc / 100);
                            runningGrandTotal += aAmt;
                            summaryHTML += `
                                <tr style="font-size: 11px;">
                                    <td colspan="6" style="text-align:right; border: 1px solid #000;">AIT (${aPerc}%)</td>
                                    <td style="text-align:center; border: 1px solid #000;">${cur} ${aAmt.toLocaleString()}</td>
                                </tr>
                            `;
                        }
                    }

                    grandTotalForWords = runningGrandTotal;

                    summaryHTML += `
                        <tr class="final-total-row" style="font-size: 11px;">
                            <td colspan="${isQuotation ? '6' : '5'}" style="text-align:right; background: #10b981 !important; color:#fff; font-weight:bold; border: 1px solid #000;">GRAND TOTAL</td>
                            <td style="text-align:center; background: #10b981 !important; color:#fff; font-weight:bold; border: 1px solid #000;">${cur} ${runningGrandTotal.toLocaleString()}</td>
                        </tr>
                    `;

                    if (isInvoice) {
                        const paid = parseFloat(data.paidAmount) || 0;
                        const due = totalAmount - paid;
                        dueAmountForWords = due;
                        summaryHTML += `
                            <tr class="final-total-row" style="font-size: 11px;">
                                <td colspan="${isQuotation ? '6' : '5'}" style="text-align:right; font-weight:bold; border: 1px solid #000;">PAID AMOUNT</td>
                                <td style="text-align:center; font-weight:bold; border: 1px solid #000;">${cur} ${paid.toLocaleString()}</td>
                            </tr>
                            <tr class="final-total-row" style="font-size: 11px;">
                                <td colspan="${isQuotation ? '6' : '5'}" style="text-align:right; font-weight:bold; color:red; border: 1px solid #000;">DUE AMOUNT</td>
                                <td style="text-align:center; font-weight:bold; color:red; border: 1px solid #000;">${cur} ${due.toLocaleString()}</td>
                            </tr>
                        `;
                    }
                }
                tableInnerHTML += summaryHTML + `</tbody>`;
            }

            let termsContent = '';
            const tcKey = { 'QUOTATION': 'tc_quote', 'INVOICE': 'tc_inv', 'DELIVERY CHALLAN': 'tc_del', 'PURCHASE ORDER': 'tc_po', 'MONEY RECEIPT': 'tc_rec' }[docType];
            if (tcKey && config[tcKey]) {
                termsContent = `<div class="terms-section"><strong>Terms & Conditions:</strong><br>${config[tcKey].replace(/\n/g, '<br>')}</div>`;
            }

            const amountInWords = isInvoice ? numberToWords(dueAmountForWords) : numberToWords(grandTotalForWords || totalAmount);

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${docType} - ${data.id}</title>
                    <style>
                        @page { size: auto; margin: 8mm 12mm; }
                        body { font-family: "Times New Roman", Times, serif; margin: 0; color: #000; font-size: 11px; -webkit-print-color-adjust: exact; }
                        .page-header { display: table-header-group; }
                        .page-footer { display: table-footer-group; }
                        
                        .header-wrapper { border-bottom: 3px solid #ef4444; text-align: center; padding-bottom: 8px; margin-bottom: 8px; position: relative; }
                        .pdf-logo { position: absolute; left: 0; top: 0; max-height: 85px; max-width: 170px; object-fit: contain; }
                        .company-name { font-size: 32px; font-weight: bold; color: #ff0000; margin: 0; }
                        .header-line2, .header-line3 { color: #1e40af; font-weight: bold; margin: 1px 0; font-size: 11px; }
                        
                        .footer-wrapper { border-top: 3px solid #10b981; padding-top: 6px; font-size: 10px; font-weight: bold; font-style: italic; color: #1e40af; text-align: center; }
                        
                        .document-title { text-align: center; font-size: 18px; font-weight: bold; color: #1e40af; text-transform: uppercase; margin: 6px 0; padding: 2px; }
                        .info-area { width: 100%; margin-bottom: 6px; border-collapse: collapse; font-size: 11px; }
                        .info-area td { padding: 2px 0; border: none; vertical-align: top; }
                        .subject-line { margin: 6px 0; padding: 2px 0; font-weight: bold; font-size: 11.5px; }
                        
                        .main-data-table { width: 100%; border-collapse: collapse; margin: 6px 0; border: 1px solid #000; table-layout: fixed; }
                        .main-data-table th, .main-data-table td { border: 1px solid #000; padding: 4px 6px; word-wrap: break-word; font-size: 10px; }
                        .main-data-table th { background: #f59e0b; color: #000; font-weight: bold; text-align: center; text-transform: uppercase; }
                        .main-data-table tr { page-break-inside: avoid; }
                        
                        @media print {
                            .footer-wrapper { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background: white; z-index: 1000; }
                            .main-data-table { margin-bottom: 20px; } 
                        }
                        
                        .final-summary-block { page-break-inside: avoid; margin-top: 10px; }
                        .amount-words { margin: 4px 0; font-size: 11px; font-weight: bold; }
                        .terms-section { margin-top: 8px; font-size: 9.5px; line-height: 1.3; }
                        .signature-section { font-size: 11px; margin-top: 20px; position: relative; page-break-inside: avoid; }
                        .seal-box { position: absolute; bottom: 5px; left: 40%; z-index: 100; }
                    </style>
                </head>
                <body>
                    <table style="width: 100%;">
                        <thead class="page-header">
                            <tr><td>
                                <div class="header-wrapper">
                                    ${config.showLogoInPdf && companyLogo ? `<img src="${companyLogo}" class="pdf-logo">` : ''}
                                    <h1 class="company-name">${config.companyName || 'FAITH ENGINEERING'}</h1>
                                    <p class="header-line2">${config.companyAddress || ''}</p>
                                    <p class="header-line3">Mobile: ${config.mobile || ''} â¢ Email: ${config.email || ''} â¢ Web: ${config.website || ''}</p>
                                </div>
                            </td></tr>
                        </thead>
                        <tfoot class="page-footer">
                            <tr><td><div style="height: 40px;"></div></td></tr> </tfoot>
                        <tbody>
                            <tr><td>
                                <div class="document-title">${docType}</div>
                                
                                ${!isReceipt ? `
                                <table class="info-area">
                                    <tr>
                                        <td style="width:60%"><strong>To:</strong><br>${data.client || data.supplier || ''}<br>${data.address || ''}</td>
                                        <td style="width:40%; text-align:right">
                                            <strong>No:</strong> ${data.id}<br>
                                            ${isQuotation ? `<strong>Ref:</strong> ${data.ref || '-'}<br>` : ''}
                                            <strong>Date:</strong> ${formatDateForPDF(data.date)}
                                            ${(isDelivery || isInvoice) ? `<br><strong>Order ID:</strong> ${data.orderId || '-'}` : ''}
                                            ${isDelivery ? `<br><strong>Gate Pass No:</strong> ${data.gatePass || '-'}` : ''}
                                        </td>
                                    </tr>
                                </table>
                                ` : ''}

                                ${data.subject ? `<div class="subject-line">Subject: ${data.subject}</div>` : ''}

                                ${isReceipt ? `
                                    <div style="float: right; text-align: right; margin-bottom: 10px; font-size: 11px;">
                                        <strong>No:</strong> ${data.id}<br>
                                        <strong>Date:</strong> ${formatDateForPDF(data.date)}
                                    </div>
                                    <div style="clear: both;"></div>
                                    <div style="border: 1px solid #000; padding: 20px; border-radius: 8px; margin-top: 5px;">
                                        <table style="width: 100%; font-size: 12px; line-height: 2.2;">
                                            <tr><td style="width:30%; font-weight:bold;">Payment Received From:</td><td style="border-bottom:1px dotted #000;">${data.client}</td></tr>
                                            <tr><td style="font-weight:bold;">Address:</td><td style="border-bottom:1px dotted #000;">${data.address || ''}</td></tr>
                                            <tr><td style="font-weight:bold;">Received Amount:</td><td style="border-bottom:1px dotted #000;">${cur} ${parseFloat(data.amount).toLocaleString()}</td></tr>
                                            <tr><td style="font-weight:bold;">Amount in Words:</td><td style="border-bottom:1px dotted #000; font-style:italic;">${numberToWords(data.amount)}</td></tr>
                                            <tr><td style="font-weight:bold;">Payment Mode:</td><td style="border-bottom:1px dotted #000;">${data.paymentMode.toUpperCase()}</td></tr>
                                            ${data.paymentMode === 'cheque' ? `
                                            <tr><td style="font-weight:bold;">Cheque No.:</td><td style="border-bottom:1px dotted #000;">${data.chequeNo || ''}</td></tr>
                                            <tr><td style="font-weight:bold;">Bank Name:</td><td style="border-bottom:1px dotted #000;">${data.bank || ''}</td></tr>
                                            ` : ''}
                                            <tr><td style="font-weight:bold;">Received By:</td><td style="border-bottom:1px dotted #000;">${data.receivedBy || ''}</td></tr>
                                        </table>
                                    </div>
                                ` : `
                                    <table class="main-data-table">
                                        ${tableInnerHTML}
                                    </table>
                                    
                                    <div class="final-summary-block">
                                        <div class="amount-words"><strong>Amount in Words:</strong> ${amountInWords}</div>
                                        ${termsContent}
                                    </div>
                                `}

                                <div class="signature-section">
                                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                                        ${isDelivery ? `
                                            <div style="text-align:center; width:180px;">
                                                ${receivedBySeal ? `<img src="${receivedBySeal}" style="max-height:60px; margin-bottom:4px;">` : '<div style="height:60px;"></div>'}
                                                <div style="border-top:1px solid #000; font-weight:bold;">Received By</div>
                                            </div>
                                        ` : '<div></div>'}
                                        
                                        <div style="text-align:center; width:230px;">
                                            ${docSignature ? `<img src="${docSignature}" style="max-height:55px; margin-bottom:-8px; position:relative; z-index:5;">` : '<div style="height:45px;"></div>'}
                                            <div style="border-top:1px solid #000; padding-top:4px;">
                                                <strong>For ${config.companyName || 'Faith Engineering'}</strong><br>
                                                ${data.signatory || config.signName || ''}<br>
                                                ${data.designation || config.signDesig || ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="seal-box">
                                        ${config.showSealInPdf && companySeal ? `<img src="${companySeal}" style="max-width:80px; opacity:0.9;">` : ''}
                                    </div>
                                </div>
                            </td></tr>
                        </tbody>
                    </table>
                    <div class="footer-wrapper">"${config.slogan || ''}"</div>
                    <script>window.onload = function() { window.print(); setTimeout(function() { window.close(); }, 500); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Optimized file upload function with lazy loading support
        async function uploadFile(storageKey, title, color) {
            const input = document.createElement('input');
            input.type = 'file';
            input.hidden = true;
            input.multiple = true; // Enabled Multiple selection
            input.accept = '.pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.xml,.csv';
            
            input.onchange = async function() {
                if (this.files.length === 0) return;
                
                // Show loading indicator
                const container = document.getElementById('moduleContent');
                const originalContent = container.innerHTML;
                container.innerHTML = `
                    <div style="text-align:center; padding:50px;">
                        <div class="skeleton" style="width:60px; height:60px; border-radius:50%; margin:0 auto 20px;"></div>
                        <div class="skeleton" style="width:200px; height:20px; border-radius:10px; margin:0 auto 10px;"></div>
                        <div class="skeleton" style="width:150px; height:15px; border-radius:8px; margin:0 auto;"></div>
                        <p style="color:var(--accent); margin-top:20px;">Uploading ${this.files.length} file(s)...</p>
                    </div>
                `;
                
                // Process each selected file
                for(let i = 0; i < this.files.length; i++){
                    await handleFileUpload(this.files[i], storageKey, title, color, (i === this.files.length - 1));
                }
                
                // Restore original content after upload
                if (storageKey.includes('_saved')) {
                    await renderSavedFilesManager(title, storageKey, color);
                } else {
                    await renderFileManager(title, storageKey, color);
                }
            };
            
            document.body.appendChild(input);
            input.click();
            setTimeout(() => document.body.removeChild(input), 100);
        }
        
        async function handleFileUpload(file, storageKey, title, color, isLast = true) {
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) { alert(`File ${file.name} exceeds 10MB limit.`); return; }
            
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const files = await Storage.get(storageKey) || [];
                        const newFile = {
                            name: file.name,
                            type: file.type,
                            data: e.target.result,
                            date: new Date().toLocaleDateString(),
                            createdAt: new Date().toISOString(),
                            size: file.size
                        };
                        files.push(newFile);
                        await Storage.save(storageKey, files);
                        resolve();
                    } catch (error) {
                        console.error('Error uploading file:', error);
                        resolve();
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Fast file download function
        function downloadFile(data, name) {
            if(!data) { alert('No data available to download.'); return; }
            
            // Create a hidden anchor element
            const link = document.createElement('a');
            link.href = data;
            link.download = name;
            link.style.display = 'none';
            
            // Add to document, click, and remove
            document.body.appendChild(link);
            link.click();
            
            // Clean up after a short delay
            setTimeout(() => {
                document.body.removeChild(link);
                // Revoke object URL to free memory
                if (link.href.startsWith('blob:')) {
                    URL.revokeObjectURL(link.href);
                }
            }, 100);
        }
        
        async function renderTransactions(color) {
            const container = document.getElementById('moduleContent');
            
            // Show skeleton loading
            container.innerHTML = `
                <div class="data-header">
                    <h3 style="margin:0; font-size:1rem; color:${color}">All Transactions</h3>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border);">
                    <div class="skeleton" style="width:120px; height:20px; border-radius:8px; margin-bottom:10px;"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div style="text-align: center; padding: 10px;">
                            <div class="skeleton" style="width:80px; height:12px; border-radius:6px; margin:0 auto 8px;"></div>
                            <div class="skeleton" style="width:100px; height:24px; border-radius:10px; margin:0 auto;"></div>
                        </div>
                        <div style="text-align: center; padding: 10px;">
                            <div class="skeleton" style="width:80px; height:12px; border-radius:6px; margin:0 auto 8px;"></div>
                            <div class="skeleton" style="width:100px; height:24px; border-radius:10px; margin:0 auto;"></div>
                        </div>
                        <div style="text-align: center; padding: 10px;">
                            <div class="skeleton" style="width:80px; height:12px; border-radius:6px; margin:0 auto 8px;"></div>
                            <div class="skeleton" style="width:100px; height:24px; border-radius:10px; margin:0 auto;"></div>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="center">SL</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Purpose</th>
                                <th class="center">Amount</th>
                                <th class="center">Balance</th>
                                <th class="center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_transactions">
                            ${Array.from({length: 5}).map(() => `
                                <tr class="table-row skeleton lazy-table-row">
                                    <td class="center"><div class="skeleton" style="width:30px; height:15px; margin:0 auto;"></div></td>
                                    <td><div class="skeleton" style="width:80px; height:15px;"></div></td>
                                    <td><div class="skeleton" style="width:60px; height:20px; border-radius:6px;"></div></td>
                                    <td><div class="skeleton" style="width:120px; height:15px;"></div></td>
                                    <td class="center"><div class="skeleton" style="width:70px; height:15px; margin:0 auto;"></div></td>
                                    <td class="center"><div class="skeleton" style="width:80px; height:15px; margin:0 auto;"></div></td>
                                    <td class="center"><div class="skeleton" style="width:60px; height:20px; margin:0 auto; border-radius:6px;"></div></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load data in background
            setTimeout(async () => {
                const incomeData = await Storage.get('income') || [];
                const expenseData = await Storage.get('expense') || [];
                const config = await Storage.get('config') || {};
                const cur = config.currency || 'à§³';
                let allTransactions = [];
                
                incomeData.forEach((item, idx) => {
                    allTransactions.push({
                        ...item,
                        type: 'Income',
                        originalIndex: idx,
                        date: item.Date,
                        amount: parseFloat(item.Amount) || 0
                    });
                });
                
                expenseData.forEach((item, idx) => {
                    allTransactions.push({
                        ...item,
                        type: 'Expense',
                        originalIndex: idx,
                        date: item.Date,
                        amount: parseFloat(item.Amount) || 0
                    });
                });
                
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                let balanceMap = new Map();
                let runningBal = 0;
                const chronological = [...allTransactions].sort((a, b) => new Date(a.date) - new Date(b.date));
                chronological.forEach(t => {
                    if (t.type === 'Income') runningBal += t.amount;
                    else runningBal -= t.amount;
                    balanceMap.set(t.type + t.originalIndex + t.date, runningBal);
                });
                
                const totalIncome = incomeData.reduce((sum, item) => sum + (parseFloat(item.Amount) || 0), 0);
                const totalExpense = expenseData.reduce((sum, item) => sum + (parseFloat(item.Amount) || 0), 0);
                const netBalance = totalIncome - totalExpense;
                
                container.innerHTML = `
                    <div class="data-header">
                        <h3 style="margin:0; font-size:1rem; color:${color}">All Transactions</h3>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border);">
                        <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:0.9rem;">Transaction Summary:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: rgba(74, 222, 128, 0.1); border-radius: 10px; border: 1px solid rgba(74, 222, 128, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Total Income</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: var(--success);">${cur} ${totalIncome.toLocaleString()}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Total Expense</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: var(--danger);">${cur} ${totalExpense.toLocaleString()}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(56, 189, 248, 0.1); border-radius: 10px; border: 1px solid rgba(56, 189, 248, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Net Balance</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: ${netBalance >= 0 ? 'var(--success)' : 'var(--danger)'};">${cur} ${netBalance.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="center">SL</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Purpose</th>
                                    <th class="center">Amount</th>
                                    <th class="center">Balance</th>
                                    <th class="center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_transactions">
                                ${allTransactions.length === 0 ? `<tr><td colspan="7" style="text-align:center; opacity:0.5">No transactions found</td></tr>` : allTransactions.map((trans, idx) => {
                                    const currentBal = balanceMap.get(trans.type + trans.originalIndex + trans.date);
                                    return `
                                    <tr class="lazy-table-row" data-index="${idx}">
                                        <td class="center">${idx + 1}</td>
                                        <td>${formatDate(trans.date)}</td>
                                        <td><span style="display:inline-block; padding:3px 8px; border-radius:6px; font-size:0.7rem; font-weight:700; background:${trans.type === 'Income' ? 'rgba(74, 222, 128, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color:${trans.type === 'Income' ? 'var(--success)' : 'var(--danger)'};">${trans.type}</span></td>
                                        <td style="color:${color}; font-weight:600">${trans.Purpose || '-'}</td>
                                        <td class="center" style="font-weight:800; color:${trans.type === 'Income' ? 'var(--success)' : 'var(--danger)'}">${trans.type === 'Income' ? '+' : '-'}${cur} ${trans.amount.toLocaleString()}</td>
                                        <td class="center" style="font-weight:900; color:${currentBal >= 0 ? 'var(--success)' : 'var(--danger)'}">${cur} ${currentBal.toLocaleString()}</td>
                                        <td class="center">
                                            <div class="action-btns">
                                                <i class="fas fa-pen edit-btn" onclick="editTransaction('${trans.type}', ${trans.originalIndex})"></i>
                                                <i class="fas fa-trash del-btn" onclick="deleteTransaction('${trans.type}', ${trans.originalIndex})"></i>
                                            </div>
                                        </td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                        </table>
                    </div>`;
                
                // Initialize lazy loading for table rows
                initLazyLoadObserver();
                const lazyRows = container.querySelectorAll('.lazy-table-row');
                lazyRows.forEach(row => lazyLoadObserver.observe(row));
                
            }, 100);
        }
        
        function editTransaction(type, index) {
            if (type === 'Income') openAccountsModal('Income', 'income', index);
            else openAccountsModal('Expense', 'expense', index);
        }
        
        async function deleteTransaction(type, index) {
            const storageKey = type === 'Income' ? 'income' : 'expense';
            if(confirm('Delete this transaction?')) {
                const data = await Storage.get(storageKey);
                data.splice(index, 1);
                await Storage.save(storageKey, data);
                renderTransactions('#38bdf8');
            }
        }
        
        // Optimized file manager with lazy loading
        async function renderSavedFilesManager(title, storageKey, color) {
            const container = document.getElementById('moduleContent');
            
            // Show skeleton loading first
            container.innerHTML = `
                <div class="file-controls">
                    <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                    <button class="add-btn" onclick="uploadFile('${storageKey}', '${title}', '${color}')"><i class="fas fa-cloud-arrow-up"></i> Upload File</button>
                </div>
                <div class="file-grid" id="fileDisplayGrid">
                    ${Array.from({length: 6}).map(() => `
                        <div class="file-card skeleton">
                            <div class="file-preview lazy-load">
                                <div class="skeleton" style="width:100%; height:100%;"></div>
                            </div>
                            <div class="file-info">
                                <div class="file-name skeleton"></div>
                                <div style="font-size:0.6rem; color:var(--text-muted); margin-bottom:8px;" class="skeleton"></div>
                                <div class="file-actions">
                                    <div class="skeleton" style="width:100%; height:24px; border-radius:6px;"></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Load files in background
            setTimeout(async () => {
                const files = await Storage.get(storageKey) || [];
                const sortedFiles = files.sort((a, b) => {
                    const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                    const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                    return dateB - dateA;
                });
                
                // Determine if this is a document type that should hide download button
                const isDocumentType = ['quotation_saved', 'invoice_saved', 'delivery_saved', 'purchase_saved', 'receipt_saved', 'letter_saved'].includes(storageKey);
                
                container.innerHTML = `
                    <div class="file-controls">
                        <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                        <button class="add-btn" onclick="uploadFile('${storageKey}', '${title}', '${color}')"><i class="fas fa-cloud-arrow-up"></i> Upload File</button>
                    </div>
                    <div class="file-grid" id="fileDisplayGrid">
                        ${sortedFiles.length === 0 ? '<p style="grid-column: 1/-1; text-align:center; opacity:0.5; padding:40px;">No saved files found.</p>' : ''}
                        ${sortedFiles.map((file, idx) => {
                            const originalIndex = files.findIndex(f => f.id === file.id);
                            const displayName = file.name || file.id || `Document ${idx + 1}`;
                            const displayDate = file.createdAt ? new Date(file.createdAt).toLocaleDateString() : 'N/A';
                            const isQuotation = storageKey === 'quotation_saved';
                            const isLetter = storageKey === 'letter_saved';
                            
                            // Determine file type for icon
                            const isImage = file.type && file.type.startsWith('image/');
                            const isPDF = file.type && file.type.includes('pdf');
                            const isExcel = file.type && (file.type.includes('excel') || file.type.includes('spreadsheet') || (file.name && (file.name.endsWith('.xls') || file.name.endsWith('.xlsx') || file.name.endsWith('.csv'))));
                            const isWord = file.type && (file.type.includes('document') || file.type.includes('msword') || (file.name && (file.name.endsWith('.doc') || file.name.endsWith('.docx'))));
                            const fileType = isImage ? 'image' : isPDF ? 'pdf' : isExcel ? 'excel' : isWord ? 'word' : 'note';
                            
                            // For document types, don't show download PDF button
                            const fileActionsHTML = isDocumentType ? `
                                <button class="file-btn btn-print" onclick='downloadPDF(${JSON.stringify(file)}, "${displayName}")' title="Print A4"><i class="fas fa-print"></i></button>
                                <button class="file-btn btn-edit" onclick="editSavedFile(${originalIndex}, '${storageKey}', '${color}')" title="Edit"><i class="fas fa-pen"></i></button>
                                ${isQuotation ? `
                                    <button class="file-btn btn-convert" onclick="convertQuotationToInvoice(${originalIndex})" title="Convert to Invoice"><i class="fas fa-file-invoice"></i></button>
                                    <button class="file-btn btn-convert" onclick="convertQuotationToDelivery(${originalIndex})" title="Convert to Delivery"><i class="fas fa-truck"></i></button>
                                ` : ''}
                                ${isLetter ? `
                                    <button class="file-btn btn-print" onclick='downloadLetterPDF(${JSON.stringify(file)}, "${displayName}")' title="Print Letter"><i class="fas fa-print"></i></button>
                                ` : ''}
                                <button class="file-btn btn-delete" onclick="deleteSavedFile(${originalIndex}, '${storageKey}', '${title}', '${color}')" title="Delete"><i class="fas fa-trash-can"></i></button>
                            ` : `
                                <button class="file-btn btn-download" onclick='downloadPDF(${JSON.stringify(file)}, "${displayName}")' title="Download PDF"><i class="fas fa-file-pdf"></i></button>
                                <button class="file-btn btn-print" onclick='downloadPDF(${JSON.stringify(file)}, "${displayName}")' title="Print A4"><i class="fas fa-print"></i></button>
                                <button class="file-btn btn-edit" onclick="editSavedFile(${originalIndex}, '${storageKey}', '${color}')" title="Edit"><i class="fas fa-pen"></i></button>
                                ${isQuotation ? `
                                    <button class="file-btn btn-convert" onclick="convertQuotationToInvoice(${originalIndex})" title="Convert to Invoice"><i class="fas fa-file-invoice"></i></button>
                                    <button class="file-btn btn-convert" onclick="convertQuotationToDelivery(${originalIndex})" title="Convert to Delivery"><i class="fas fa-truck"></i></button>
                                ` : ''}
                                <button class="file-btn btn-delete" onclick="deleteSavedFile(${originalIndex}, '${storageKey}', '${title}', '${color}')" title="Delete"><i class="fas fa-trash-can"></i></button>
                            `;
                            
                            return `
                            <div class="file-card">
                                <div class="file-preview lazy-load lazy-file" 
                                     data-file-data="${isImage ? file.data : ''}"
                                     data-is-image="${isImage}"
                                     data-file-type="${fileType}">
                                    ${isImage ? '' : `<i class="fas fa-file-${fileType} file-type-icon ${fileType}-icon"></i>`}
                                </div>
                                <div class="file-info">
                                    <div class="file-name" title="${displayName}">${displayName}</div>
                                    <div style="font-size:0.6rem; color:var(--text-muted); margin-bottom:8px;">Created: ${displayDate}</div>
                                    <div class="file-actions">
                                        ${fileActionsHTML}
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
                
                // Initialize lazy loading for file previews
                initLazyLoadObserver();
                const lazyFiles = container.querySelectorAll('.lazy-file');
                lazyFiles.forEach(file => lazyLoadObserver.observe(file));
                
            }, 100);
        }
        
        async function convertQuotationToInvoice(quoteIndex) {
            const files = await Storage.get('quotation_saved') || [];
            const quote = files[quoteIndex];
            if (!quote) return;
            
            // Confirm conversion
            if (!confirm(`Convert quotation ${quote.id} to invoice? This will create a new invoice with the same items.`)) {
                return;
            }
            
            // Calculate total amount from quote items
            let totalAmount = 0;
            if (quote.items && quote.items.length > 0) {
                totalAmount = quote.items.reduce((sum, item) => {
                    return sum + (item.qty * item.price || 0);
                }, 0);
            }
            
            // Create invoice data from quote
            const invoiceData = {
                id: await generateSavedID('INV'),
                client: quote.client || '',
                address: quote.address || '',
                orderId: '',
                date: new Date().toISOString().split('T')[0],
                paidAmount: '0',
                items: quote.items || [],
                total: totalAmount.toString(),
                name: `${quote.id}_converted_to_invoice.pdf`,
                type: 'application/pdf',
                createdAt: new Date().toISOString(),
                companyName: quote.companyName || 'Faith Engineering',
                companyAddress: quote.companyAddress || 'Dhaka, Bangladesh',
                signatory: quote.signatory || '',
                designation: quote.designation || '',
                terms: quote.terms || ''
            };
            
            // Save to invoice_saved
            const savedInvoices = await Storage.get('invoice_saved') || [];
            savedInvoices.push(invoiceData);
            await Storage.save('invoice_saved', savedInvoices);
            
            alert(`Quotation converted to invoice successfully! New Invoice ID: ${invoiceData.id}`);
            
            // Optionally navigate to invoices
            handleSubModuleClick('Saved Files', 'invoice_saved', '#34d399');
        }
        
        async function convertQuotationToDelivery(quoteIndex) {
            const files = await Storage.get('quotation_saved') || [];
            const quote = files[quoteIndex];
            if (!quote) return;
            
            // Confirm conversion
            if (!confirm(`Convert quotation ${quote.id} to delivery challan? This will create a new delivery challan with the same items.`)) {
                return;
            }
            
            // Create delivery data from quote
            const deliveryData = {
                id: await generateSavedID('DC'),
                client: quote.client || '',
                address: quote.address || '',
                orderId: '',
                date: new Date().toISOString().split('T')[0],
                gatePass: '',
                items: quote.items ? quote.items.map(item => ({
                    name: item.name || '',
                    desc: item.desc || '',
                    qty: item.qty || 0,
                    remarks: ''
                })) : [],
                name: `${quote.id}_converted_to_delivery.pdf`,
                type: 'application/pdf',
                createdAt: new Date().toISOString(),
                companyName: quote.companyName || 'Faith Engineering',
                companyAddress: quote.companyAddress || 'Dhaka, Bangladesh',
                signatory: quote.signatory || '',
                designation: quote.designation || '',
                terms: quote.terms || ''
            };
            
            // Save to delivery_saved
            const savedDeliveries = await Storage.get('delivery_saved') || [];
            savedDeliveries.push(deliveryData);
            await Storage.save('delivery_saved', savedDeliveries);
            
            alert(`Quotation converted to delivery challan successfully! New Delivery ID: ${deliveryData.id}`);
            
            // Optionally navigate to deliveries
            handleSubModuleClick('Saved Files', 'delivery_saved', '#60a5fa');
        }
        
        async function editSavedFile(index, storageKey, color) {
            const files = await Storage.get(storageKey) || [];
            const file = files[index];
            if (!file) return;
            if (storageKey === 'quotation_saved') renderQuotationCreator('#c084fc', index, file);
            else if (storageKey === 'invoice_saved') renderInvoiceCreator('#34d399', index, file);
            else if (storageKey === 'delivery_saved') renderDeliveryCreator('#60a5fa', index, file);
            else if (storageKey === 'purchase_saved') renderPurchaseCreator('#f472b6', index, file);
            else if (storageKey === 'receipt_saved') renderReceiptCreator('#fb7185', index, file);
            else if (storageKey === 'letter_saved') renderLetterCreator('#f97316', index, file);
            else alert('Editing not supported for this file type.');
        }
        
        async function deleteSavedFile(index, storageKey, title, color) {
            if (confirm('Permanently delete this saved file?')) {
                const files = await Storage.get(storageKey);
                files.splice(index, 1);
                await Storage.save(storageKey, files);
                renderSavedFilesManager(title, storageKey, color);
            }
        }
        
        // Updated renderFileManager with lazy loading
        async function renderFileManager(title, storageKey, color) {
            const container = document.getElementById('moduleContent');
            
            // Check if this is a product category (starts with a lowercase letter and doesn't contain underscores)
            const isProductCategory = /^[a-z]/.test(storageKey) && !storageKey.includes('_') && !storageKey.includes('uploaded');
            
            // Show skeleton loading first
            container.innerHTML = `
                <div class="file-controls">
                    <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                    ${!isProductCategory ? `<button class="add-btn" onclick="uploadFile('${storageKey}', '${title}', '${color}')"><i class="fas fa-cloud-arrow-up"></i> Upload File</button>` : ''}
                </div>
                <div class="file-grid" id="fileDisplayGrid">
                    ${Array.from({length: 6}).map(() => `
                        <div class="file-card skeleton">
                            <div class="file-preview lazy-load">
                                <div class="skeleton" style="width:100%; height:100%;"></div>
                            </div>
                            <div class="file-info">
                                <div class="file-name skeleton"></div>
                                <div class="file-actions">
                                    <div class="skeleton" style="width:100%; height:24px; border-radius:6px;"></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Load files in background
            setTimeout(async () => {
                const files = await Storage.get(storageKey) || [];
                
                container.innerHTML = `
                    <div class="file-controls">
                        <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                        ${!isProductCategory ? `<button class="add-btn" onclick="uploadFile('${storageKey}', '${title}', '${color}')"><i class="fas fa-cloud-arrow-up"></i> Upload File</button>` : ''}
                    </div>
                    <div class="file-grid" id="fileDisplayGrid">
                        ${files.length === 0 ? '<p style="grid-column: 1/-1; text-align:center; opacity:0.5; padding:40px;">No files found.</p>' : ''}
                        ${files.map((file, idx) => {
                            const isImage = file.type && file.type.startsWith('image/');
                            const isPDF = file.type && file.type.includes('pdf');
                            const isExcel = file.type && (file.type.includes('excel') || file.type.includes('spreadsheet') || (file.name && (file.name.endsWith('.xls') || file.name.endsWith('.xlsx') || file.name.endsWith('.csv'))));
                            const isWord = file.type && (file.type.includes('document') || file.type.includes('msword') || (file.name && (file.name.endsWith('.doc') || file.name.endsWith('.docx'))));
                            const fileType = isImage ? 'image' : isPDF ? 'pdf' : isExcel ? 'excel' : isWord ? 'word' : 'note';
                            
                            return `
                            <div class="file-card">
                                <div class="file-preview lazy-load lazy-file" 
                                     data-file-data="${isImage ? file.data : ''}"
                                     data-is-image="${isImage}"
                                     data-file-type="${fileType}">
                                    ${isImage ? '' : `<i class="fas fa-file-${fileType} file-type-icon ${fileType}-icon"></i>`}
                                </div>
                                <div class="file-info">
                                    <div class="file-name" title="${file.name || file.id}">${file.name || file.id}</div>
                                    <div class="file-actions">
                                        <button class="file-btn btn-download" onclick="downloadFile('${file.data || ''}', '${file.name || 'file'}')" title="Download"><i class="fas fa-download"></i></button>
                                        <button class="file-btn btn-delete" onclick="deleteFile('${storageKey}', ${idx}, '${title}', '${color}')" title="Delete"><i class="fas fa-trash-can"></i></button>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
                
                // Initialize lazy loading for file previews
                initLazyLoadObserver();
                const lazyFiles = container.querySelectorAll('.lazy-file');
                lazyFiles.forEach(file => lazyLoadObserver.observe(file));
                
            }, 100);
        }
        
        async function deleteFile(storageKey, idx, title, color) {
            if (confirm('Permanently delete this file?')) {
                const files = await Storage.get(storageKey);
                files.splice(idx, 1);
                await Storage.save(storageKey, files);
                await renderFileManager(title, storageKey, color);
            }
        }
        
        // PRODUCT CATEGORY DATA MANAGEMENT with lazy loading
        async function renderProductCategoryData(subName, storageKey, color) {
            const container = document.getElementById('moduleContent');
            
            // Show skeleton loading
            container.innerHTML = `
                <div class="data-header">
                    <h3 style="margin:0; font-size:1rem; color:${color}">${subName}</h3>
                    <button class="add-btn" onclick="openProductCategoryModal('${storageKey}', '${subName}', ${-1})"><i class="fas fa-plus"></i> Add Product</button>
                </div>
                <div class="search-container">
                    <input type="text" class="search-input" id="search_${storageKey}" placeholder="Search ${subName}..." oninput="filterProductCategory('${storageKey}')">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table id="table_${storageKey}">
                        <thead>
                            <tr>
                                <th class="center">SL</th>
                                <th>Items</th>
                                <th>Description</th>
                                <th class="center">Unit</th>
                                <th class="center">Unit Price</th>
                                <th class="center">Available Quantity</th>
                                <th class="center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_${storageKey}">
                            ${Array.from({length: 5}).map(() => `
                                <tr class="table-row skeleton lazy-table-row">
                                    <td class="center"><div class="skeleton" style="width:30px; height:15px; margin:0 auto;"></div></td>
                                    <td><div class="skeleton" style="width:120px; height:15px;"></div></td>
                                    <td><div class="skeleton" style="width:150px; height:15px;"></div></td>
                                    <td class="center"><div class="skeleton" style="width:40px; height:15px; margin:0 auto;"></div></td>
                                    <td class="center"><div class="skeleton" style="width:60px; height:15px; margin:0 auto;"></div></td>
                                    <td class="center"><div class="skeleton" style="width:50px; height:15px; margin:0 auto;"></div></td>
                                    <td class="center"><div class="skeleton" style="width:60px; height:20px; margin:0 auto; border-radius:6px;"></div></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load data in background
            setTimeout(async () => {
                const data = await Storage.get(storageKey) || [];
                
                container.innerHTML = `
                    <div class="data-header">
                        <h3 style="margin:0; font-size:1rem; color:${color}">${subName}</h3>
                        <button class="add-btn" onclick="openProductCategoryModal('${storageKey}', '${subName}', ${-1})"><i class="fas fa-plus"></i> Add Product</button>
                    </div>
                    <div class="search-container">
                        <input type="text" class="search-input" id="search_${storageKey}" placeholder="Search ${subName}..." oninput="filterProductCategory('${storageKey}')">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="table-container">
                        <table id="table_${storageKey}">
                            <thead>
                                <tr>
                                    <th class="center">SL</th>
                                    <th>Items</th>
                                    <th>Description</th>
                                    <th class="center">Unit</th>
                                    <th class="center">Unit Price</th>
                                    <th class="center">Available Quantity</th>
                                    <th class="center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_${storageKey}">
                                ${data.length === 0 ? `<tr><td colspan="7" style="text-align:center; opacity:0.5">No products found in ${subName}</td></tr>` : 
                                data.map((row, idx) => `
                                    <tr class="lazy-table-row" data-index="${idx}">
                                        <td class="center">${idx + 1}</td>
                                        <td style="color:${color}; font-weight:600">${row.Items || '-'}</td>
                                        <td style="font-size:0.75rem">${row.Description || '-'}</td>
                                        <td class="center">${row.Unit || '-'}</td>
                                        <td class="center" style="font-weight:800">${row['Unit Price'] || '0'}</td>
                                        <td class="center" style="font-weight:800; color:${(row.Quantity || 0) > 0 ? 'var(--success)' : 'var(--danger)'}">${row.Quantity || 0}</td>
                                        <td class="center">
                                            <div class="action-btns">
                                                <i class="fas fa-pen edit-btn" onclick="openProductCategoryModal('${storageKey}', '${subName}', ${idx})"></i>
                                                <i class="fas fa-trash del-btn" onclick="deleteProductCategoryItem('${storageKey}', ${idx}, '${subName}')"></i>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Initialize lazy loading for table rows
                initLazyLoadObserver();
                const lazyRows = container.querySelectorAll('.lazy-table-row');
                lazyRows.forEach(row => lazyLoadObserver.observe(row));
                
            }, 100);
        }

        function filterProductCategory(storageKey) {
            const searchInput = document.getElementById(`search_${storageKey}`);
            const searchTerm = searchInput.value.toLowerCase();
            const tableBody = document.getElementById(`tbody_${storageKey}`);
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let found = false;
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }
                row.style.display = found ? '' : 'none';
            }
        }

        async function openProductCategoryModal(storageKey, subName, editIndex = -1) {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('genericForm');
            const data = await Storage.get(storageKey) || [];
            const editData = editIndex !== -1 ? data[editIndex] : null;
            
            title.innerText = editIndex !== -1 ? `Edit ${subName} Product` : `Add Product to ${subName}`;
            
            form.innerHTML = `
                <div class="form-group">
                    <label>Items</label>
                    <input type="text" class="form-input" id="pc_items" value="${editData ? editData.Items : ''}" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-input" id="pc_description" style="min-height:60px;">${editData ? editData.Description : ''}</textarea>
                </div>
                <div class="quote-grid">
                    <div class="form-group">
                        <label>Unit</label>
                        <input type="text" class="form-input" id="pc_unit" value="${editData ? editData.Unit : ''}">
                    </div>
                    <div class="form-group">
                        <label>Unit Price</label>
                        <input type="number" class="form-input" id="pc_unit_price" value="${editData ? editData['Unit Price'] : ''}" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Available Quantity</label>
                    <input type="number" class="form-input" id="pc_quantity" value="${editData ? (editData.Quantity || 0) : 0}">
                </div>
            `;
            
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.onclick = async () => {
                const newItem = {
                    Items: document.getElementById('pc_items').value,
                    Description: document.getElementById('pc_description').value,
                    Unit: document.getElementById('pc_unit').value,
                    'Unit Price': document.getElementById('pc_unit_price').value,
                    Quantity: parseInt(document.getElementById('pc_quantity').value) || 0
                };
                
                if (editIndex !== -1) {
                    data[editIndex] = newItem;
                } else {
                    data.push(newItem);
                }
                
                await Storage.save(storageKey, data);
                closeModal();
                await renderProductCategoryData(subName, storageKey, '#fbbf24');
            };
            
            modal.style.display = 'flex';
        }

        async function deleteProductCategoryItem(storageKey, index, subName) {
            if (confirm('Delete this product?')) {
                const data = await Storage.get(storageKey) || [];
                data.splice(index, 1);
                await Storage.save(storageKey, data);
                await renderProductCategoryData(subName, storageKey, '#fbbf24');
            }
        }
        
        async function renderProductCategories(color) {
            const container = document.getElementById('moduleContent');
            const categories = await Storage.get('product_categories') || [];
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">Manage Product Categories</h3>
                    <p style="color:var(--text-muted); font-size:0.8rem; margin-bottom:20px;">Add, edit, or delete product categories.</p>
                    <div class="category-grid">
                        ${categories.map((cat, idx) => {
                            const formattedCat = cat.charAt(0).toUpperCase() + cat.slice(1);
                            return `
                                <div class="category-card">
                                    <i class="fas fa-box"></i>
                                    <span>${formattedCat}</span>
                                    <div class="category-actions">
                                        <button class="category-btn" style="background:var(--danger);" onclick="deleteProductCategory(${idx})"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="add-category-form">
                        <h4 style="color:var(--accent); margin-top:0; font-size:0.9rem;">Add New Category</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newCategoryName" class="config-input" placeholder="Enter category name" style="flex:1;">
                            <button class="add-btn" onclick="addProductCategory()" style="padding:8px 15px;"><i class="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function addProductCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const name = nameInput.value.trim().toLowerCase();
            if (!name) return;
            const categories = await Storage.get('product_categories') || [];
            if (categories.includes(name)) return;
            categories.push(name);
            await Storage.save('product_categories', categories);
            await Storage.save(name, []);
            nameInput.value = '';
            await renderProductCategories('#fbbf24');
        }
        
        async function deleteProductCategory(index) {
            if (confirm('Delete category?')) {
                const categories = await Storage.get('product_categories') || [];
                const categoryName = categories[index];
                categories.splice(index, 1);
                await Storage.save('product_categories', categories);
                await Storage.remove(categoryName);
                await renderProductCategories('#fbbf24');
            }
        }
        
        async function renderProjectCategories(color) {
            const container = document.getElementById('moduleContent');
            const categories = await Storage.get('project_categories') || [];
            container.innerHTML = `
                <div class="settings-card" style="border-top: 4px solid ${color}">
                    <h3 style="color:${color}; margin-top:0;">Manage Project Categories</h3>
                    <p style="color:var(--text-muted); font-size:0.8rem; margin-bottom:20px;">Organize project files into dedicated folders.</p>
                    <div class="category-grid">
                        ${categories.map((cat, idx) => `
                            <div class="category-card">
                                <i class="fas fa-folder"></i>
                                <span>${cat}</span>
                                <div class="category-actions">
                                    <button class="category-btn" style="background:var(--danger);" onclick="deleteProjectCategory(${idx})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-category-form">
                        <h4 style="color:var(--accent); margin-top:0; font-size:0.9rem;">Add New Project Category</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newProjectCategoryName" class="config-input" placeholder="Project Name" style="flex:1;">
                            <button class="add-btn" onclick="addProjectCategory()" style="padding:8px 15px;"><i class="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function addProjectCategory() {
            const nameInput = document.getElementById('newProjectCategoryName');
            const name = nameInput.value.trim();
            if (!name) return;
            const categories = await Storage.get('project_categories') || [];
            if (categories.includes(name)) return;
            categories.push(name);
            await Storage.save('project_categories', categories);
            const storageKey = `project_${name.toLowerCase().replace(/\s+/g, '_')}`;
            await Storage.save(storageKey, []);
            nameInput.value = '';
            await renderProjectCategories('#4ade80');
        }
        
        async function deleteProjectCategory(index) {
            if (confirm('Delete category?')) {
                const categories = await Storage.get('project_categories') || [];
                const categoryName = categories[index];
                categories.splice(index, 1);
                await Storage.save('product_categories', categories);
                await Storage.remove(`project_${categoryName.toLowerCase().replace(/\s+/g, '_')}`);
                await renderProjectCategories('#4ade80');
            }
        }
        
        async function renderWODataTable(title, storageKey, color) {
            const container = document.getElementById('moduleContent');
            
            // Show skeleton loading first
            container.innerHTML = `
                <div class="data-header">
                    <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                    <button class="add-btn" onclick="openWOCalculationModal()"><i class="fas fa-plus"></i> Add Calculation</button>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border);">
                    <div class="skeleton" style="width:120px; height:20px; border-radius:8px; margin-bottom:10px;"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        ${Array.from({length: 4}).map(() => `
                            <div style="text-align: center; padding: 10px;">
                                <div class="skeleton" style="width:80px; height:12px; border-radius:6px; margin:0 auto 8px;"></div>
                                <div class="skeleton" style="width:100px; height:24px; border-radius:10px; margin:0 auto;"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="center">SL</th>
                                <th>Date</th>
                                <th>Project</th>
                                <th>Order ID</th>
                                <th>Scope</th>
                                <th class="center">Amount</th>
                                <th class="center">Cost</th>
                                <th class="center">Profit</th>
                                <th class="center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_${storageKey}">
                            ${Array.from({length: 5}).map(() => `
                                <tr class="table-row skeleton lazy-table-row">
                                    ${Array.from({length: 9}).map(() => `
                                        <td class="center"><div class="skeleton" style="width:80%; height:15px; margin:0 auto;"></div></td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load data in background
            setTimeout(async () => {
                const rawData = await Storage.get(storageKey) || [];
                const data = [...rawData].sort((a, b) => new Date(b.Date) - new Date(a.Date));
                const config = await Storage.get('config') || {};
                const cur = config.currency || 'à§³';
                
                // Calculate summary metrics
                const totalOrder = data.length;
                const totalValue = data.reduce((sum, item) => sum + (parseFloat(item.Amount) || 0), 0);
                const totalCost = data.reduce((sum, item) => sum + (parseFloat(item.Cost) || 0), 0);
                const totalProfit = data.reduce((sum, item) => sum + (parseFloat(item.Profit) || 0), 0);
                const profitPercentage = totalValue > 0 ? ((totalProfit / totalValue) * 100).toFixed(1) : 0;
                
                container.innerHTML = `
                    <div class="data-header">
                        <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                        <button class="add-btn" onclick="openWOCalculationModal()"><i class="fas fa-plus"></i> Add Calculation</button>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border);">
                        <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:0.9rem;">Work Order Summary:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: rgba(56, 189, 248, 0.1); border-radius: 10px; border: 1px solid rgba(56, 189, 248, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Total Orders</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: var(--accent);">${totalOrder}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(74, 222, 128, 0.1); border-radius: 10px; border: 1px solid rgba(74, 222, 128, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Total Value</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: var(--success);">${cur} ${totalValue.toLocaleString()}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 10px; border: 1px solid rgba(251, 191, 36, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Total Cost</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: var(--primary);">${cur} ${totalCost.toLocaleString()}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 10px; border: 1px solid rgba(34, 197, 94, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Total Profit</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: #22c55e;">${cur} ${totalProfit.toLocaleString()}</div>
                                <div style="font-size: 0.65rem; color: ${totalProfit >= 0 ? '#22c55e' : '#ef4444'}; font-weight: 700; margin-top: 3px;">
                                    ${profitPercentage}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="center">SL</th>
                                    <th>Date</th>
                                    <th>Project</th>
                                    <th>Order ID</th>
                                    <th>Scope</th>
                                    <th class="center">Amount</th>
                                    <th class="center">Cost</th>
                                    <th class="center">Profit</th>
                                    <th class="center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_${storageKey}">
                                ${data.length === 0 ? `<tr><td colspan="9" style="text-align:center; opacity:0.5">No records found</td></tr>` : ''}
                                ${data.map((row, idx) => {
                                    const amount = parseFloat(row.Amount) || 0;
                                    const cost = parseFloat(row.Cost) || 0;
                                    const profit = parseFloat(row.Profit) || 0;
                                    const profitPercentage = amount > 0 ? ((profit / amount) * 100).toFixed(1) : 0;
                                    return `
                                        <tr class="lazy-table-row" data-index="${idx}">
                                            <td class="center">${idx + 1}</td>
                                            <td>${formatDate(row.Date)}</td>
                                            <td style="color:${color}; font-weight:600">${row.Project || '-'}</td>
                                            <td>${row['Order ID'] || '-'}</td>
                                            <td style="font-size:0.7rem">${row['Scope Type'] || '-'}</td>
                                            <td class="center" style="font-weight:800; color:white">${cur} ${amount.toLocaleString()}</td>
                                            <td class="center" style="font-weight:800; color:var(--primary)">${cur} ${cost.toLocaleString()}</td>
                                            <td class="center" style="font-weight:800; color:${profit >= 0 ? '#22c55e' : '#ef4444'}">
                                                ${cur} ${profit.toLocaleString()}<br>
                                                <small style="font-size:0.6rem; color:${profit >= 0 ? '#22c55e' : '#ef4444'}">
                                                    ${profitPercentage}%
                                                </small>
                                            </td>
                                            <td class="center">
                                                <div class="action-btns">
                                                    <i class="fas fa-pen edit-btn" onclick="editWOCalculation(${idx}, '${storageKey}')"></i>
                                                    <i class="fas fa-trash del-btn" onclick="deleteWOCalculation(${idx}, '${storageKey}')"></i>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot class="total-row-fixed">
                                <tr>
                                    <td colspan="5" style="text-align:right; text-transform:uppercase; letter-spacing:1px; padding:15px;">COMBINED TOTALS</td>
                                    <td class="center" style="font-size:1.1rem; border-left: 1px solid var(--glass-border); color:white">${cur} ${totalValue.toLocaleString()}</td>
                                    <td class="center" style="font-size:1.1rem; border-left: 1px solid var(--glass-border); color:var(--primary)">${cur} ${totalCost.toLocaleString()}</td>
                                    <td class="center" style="font-size:1.1rem; border-left: 1px solid var(--glass-border); color:#22c55e">${cur} ${totalProfit.toLocaleString()}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                // Initialize lazy loading for table rows
                initLazyLoadObserver();
                const lazyRows = container.querySelectorAll('.lazy-table-row');
                lazyRows.forEach(row => lazyLoadObserver.observe(row));
                
            }, 100);
        }
        
        async function openWOCalculationModal(editIndex = -1, storageKey = 'wo_calc') {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('genericForm');
            const rawData = await Storage.get(storageKey) || [];
            const sortedData = [...rawData].sort((a, b) => new Date(b.Date) - new Date(a.Date));
            const editData = editIndex !== -1 ? sortedData[editIndex] : null;
            title.innerText = editIndex !== -1 ? "Edit Calculation" : "Add Calculation";
            form.innerHTML = `
                <div class="form-group"><label>Date</label><input type="date" id="wo_date" class="form-input" value="${editData ? editData.Date : new Date().toISOString().split('T')[0]}" required></div>
                <div class="form-group"><label>Project Name</label><input type="text" id="wo_project" class="form-input" value="${editData ? editData.Project : ''}" required></div>
                <div class="form-group"><label>Order ID</label><input type="text" id="wo_order_id" class="form-input" value="${editData ? editData['Order ID'] : ''}"></div>
                <div class="form-group"><label>Scope Type</label><input type="text" id="wo_scope" class="form-input" value="${editData ? editData['Scope Type'] : ''}" placeholder="Installation, etc."></div>
                <div class="form-group"><label>Amount</label><input type="number" id="wo_amount" class="form-input" value="${editData ? editData.Amount : ''}" step="0.01" required oninput="calculateWOProfit()"></div>
                <div class="form-group"><label>Cost</label><input type="number" id="wo_cost" class="form-input" value="${editData ? editData.Cost : ''}" step="0.01" required oninput="calculateWOProfit()"></div>
                <div class="form-group"><label>Profit</label><input type="number" id="wo_profit" class="form-input" value="${editData ? editData.Profit : ''}" step="0.01" readonly></div>
            `;
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.onclick = async () => {
                const amount = parseFloat(document.getElementById('wo_amount').value) || 0;
                const cost = parseFloat(document.getElementById('wo_cost').value) || 0;
                const profit = parseFloat(document.getElementById('wo_profit').value) || 0;
                
                const newItem = {
                    Date: document.getElementById('wo_date').value,
                    Project: document.getElementById('wo_project').value,
                    'Order ID': document.getElementById('wo_order_id').value,
                    'Scope Type': document.getElementById('wo_scope').value,
                    Amount: amount.toString(),
                    Cost: cost.toString(),
                    Profit: profit.toString()
                };
                let data = await Storage.get(storageKey) || [];
                if (editIndex !== -1) {
                    const itemToFind = sortedData[editIndex];
                    const originalIdx = data.findIndex(i => JSON.stringify(i) === JSON.stringify(itemToFind));
                    data[originalIdx] = newItem;
                } else {
                    data.push(newItem);
                }
                await Storage.save(storageKey, data);
                closeModal();
                await renderWODataTable('Calculation', storageKey, '#f97316');
            };
            modal.style.display = 'flex';
            
            // Calculate initial profit if editing
            if (editData) {
                calculateWOProfit();
            }
        }
        
        function calculateWOProfit() {
            const amount = parseFloat(document.getElementById('wo_amount').value) || 0;
            const cost = parseFloat(document.getElementById('wo_cost').value) || 0;
            const profit = amount - cost;
            document.getElementById('wo_profit').value = profit.toFixed(2);
        }
        
        async function editWOCalculation(index, storageKey) {
            openWOCalculationModal(index, storageKey);
        }
        
        async function deleteWOCalculation(index, storageKey) {
            if(confirm('Delete calculation?')) {
                let data = await Storage.get(storageKey) || [];
                const sortedData = [...data].sort((a, b) => new Date(b.Date) - new Date(a.Date));
                const itemToFind = sortedData[index];
                const originalIdx = data.findIndex(i => JSON.stringify(i) === JSON.stringify(itemToFind));
                data.splice(originalIdx, 1);
                await Storage.save(storageKey, data);
                await renderWODataTable('Calculation', storageKey, '#f97316');
            }
        }
        
        async function renderAccountsTable(title, storageKey, color) {
            const container = document.getElementById('moduleContent');
            
            // Show skeleton loading first
            container.innerHTML = `
                <div class="data-header">
                    <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                    <button class="add-btn" onclick="openAccountsModal('${title}', '${storageKey}', ${-1})"><i class="fas fa-plus"></i> Add Entry</button>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border);">
                    <div class="skeleton" style="width:120px; height:20px; border-radius:8px; margin-bottom:10px;"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        ${Array.from({length: 3}).map(() => `
                            <div style="text-align: center; padding: 10px;">
                                <div class="skeleton" style="width:80px; height:12px; border-radius:6px; margin:0 auto 8px;"></div>
                                <div class="skeleton" style="width:100px; height:24px; border-radius:10px; margin:0 auto;"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="center">SL</th>
                                <th>Date</th>
                                <th>Purpose</th>
                                <th class="center">Amount</th>
                                <th class="center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_${storageKey}">
                            ${Array.from({length: 5}).map(() => `
                                <tr class="table-row skeleton lazy-table-row">
                                    ${Array.from({length: 5}).map(() => `
                                        <td class="center"><div class="skeleton" style="width:80%; height:15px; margin:0 auto;"></div></td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load data in background
            setTimeout(async () => {
                const rawData = await Storage.get(storageKey) || [];
                const data = [...rawData].sort((a, b) => new Date(b.Date) - new Date(a.Date));
                const config = await Storage.get('config') || {};
                const cur = config.currency || 'à§³';
                
                // Calculate summary metrics
                const total = data.reduce((sum, item) => sum + (parseFloat(item.Amount) || 0), 0);
                
                // Calculate This Month (current month)
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const thisMonthTotal = data.reduce((sum, item) => {
                    const itemDate = new Date(item.Date);
                    if (itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear) {
                        return sum + (parseFloat(item.Amount) || 0);
                    }
                    return sum;
                }, 0);
                
                // Calculate This Year (current year)
                const thisYearTotal = data.reduce((sum, item) => {
                    const itemDate = new Date(item.Date);
                    if (itemDate.getFullYear() === currentYear) {
                        return sum + (parseFloat(item.Amount) || 0);
                    }
                    return sum;
                }, 0);
                
                // Determine summary titles based on whether it's Income or Expense
                const summaryTitle = title === 'Income' ? 'Income Summary' : 'Expense Summary';
                const totalLabel = title === 'Income' ? 'Total Income' : 'Total Expense';
                const thisMonthLabel = title === 'Income' ? 'This Month' : 'This Month';
                const thisYearLabel = title === 'Income' ? 'This Year' : 'This Year';
                
                container.innerHTML = `
                    <div class="data-header">
                        <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                        <button class="add-btn" onclick="openAccountsModal('${title}', '${storageKey}', ${-1})"><i class="fas fa-plus"></i> Add Entry</button>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border);">
                        <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:0.9rem;">${summaryTitle}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: rgba(56, 189, 248, 0.1); border-radius: 10px; border: 1px solid rgba(56, 189, 248, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${totalLabel}</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: ${title === 'Income' ? 'var(--success)' : 'var(--danger)'};">${cur} ${total.toLocaleString()}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 10px; border: 1px solid rgba(251, 191, 36, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${thisMonthLabel}</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: var(--primary);">${cur} ${thisMonthTotal.toLocaleString()}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(74, 222, 128, 0.1); border-radius: 10px; border: 1px solid rgba(74, 222, 128, 0.2);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${thisYearLabel}</div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: ${title === 'Income' ? '#22c55e' : '#ef4444'};">${cur} ${thisYearTotal.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="center">SL</th>
                                    <th>Date</th>
                                    <th>Purpose</th>
                                    <th class="center">Amount</th>
                                    <th class="center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_${storageKey}">
                                ${data.length === 0 ? `<tr><td colspan="5" style="text-align:center; opacity:0.5">No records found</td></tr>` : ''}
                                ${data.map((row, idx) => `
                                    <tr class="lazy-table-row" data-index="${idx}">
                                        <td class="center">${idx + 1}</td>
                                        <td>${formatDate(row.Date)}</td>
                                        <td style="color:${color}; font-weight:600">${row.Purpose || '-'}</td>
                                        <td class="center" style="font-weight:800; color:${title === 'Income' ? 'var(--success)' : 'var(--danger)'}">${cur} ${parseFloat(row.Amount || 0).toLocaleString()}</td>
                                        <td class="center">
                                            <div class="action-btns">
                                                <i class="fas fa-pen edit-btn" onclick="openAccountsModal('${title}', '${storageKey}', ${idx})"></i>
                                                <i class="fas fa-trash del-btn" onclick="deleteAccountRecord(${idx}, '${storageKey}', '${title}')"></i>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot class="total-row-fixed">
                                <tr>
                                    <td colspan="3" style="text-align:right; text-transform:uppercase; letter-spacing:1px; padding:15px;">Grand Total</td>
                                    <td class="center" style="font-size:1.1rem; border-left: 1px solid var(--glass-border); color:${title === 'Income' ? 'var(--success)' : 'var(--danger)'}">${cur} ${total.toLocaleString()}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                // Initialize lazy loading for table rows
                initLazyLoadObserver();
                const lazyRows = container.querySelectorAll('.lazy-table-row');
                lazyRows.forEach(row => lazyLoadObserver.observe(row));
                
            }, 100);
        }
        
        async function openAccountsModal(title, storageKey, editIndex = -1) {
            const modal = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('genericForm');
            const rawData = await Storage.get(storageKey) || [];
            const sortedData = [...rawData].sort((a, b) => new Date(b.Date) - new Date(a.Date));
            const editData = editIndex !== -1 ? sortedData[editIndex] : null;
            modalTitle.innerText = editIndex !== -1 ? `Edit ${title}` : `Add ${title}`;
            form.innerHTML = `
                <div class="form-group"><label>Date</label><input type="date" id="acc_date" class="form-input" value="${editData ? editData.Date : new Date().toISOString().split('T')[0]}" required></div>
                <div class="form-group"><label>Purpose</label><input type="text" id="acc_purpose" class="form-input" value="${editData ? editData.Purpose : ''}" required></div>
                <div class="form-group"><label>Amount</label><input type="number" id="acc_amount" class="form-input" value="${editData ? editData.Amount : ''}" step="0.01" required></div>
            `;
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.onclick = async () => {
                const newItem = {
                    Date: document.getElementById('acc_date').value,
                    Purpose: document.getElementById('acc_purpose').value,
                    Amount: document.getElementById('acc_amount').value
                };
                let data = await Storage.get(storageKey) || [];
                if (editIndex !== -1) {
                    const itemToFind = sortedData[editIndex];
                    const originalIdx = data.findIndex(i => JSON.stringify(i) === JSON.stringify(itemToFind));
                    data[originalIdx] = newItem;
                } else {
                    data.push(newItem);
                }
                await Storage.save(storageKey, data);
                closeModal();
                await renderAccountsTable(title, storageKey, title === 'Income' ? '#4ade80' : '#ef4444');
            };
            modal.style.display = 'flex';
        }
        
        async function deleteAccountRecord(idx, storageKey, title) {
            if(confirm('Delete record?')) {
                let data = await Storage.get(storageKey) || [];
                const sortedData = [...data].sort((a, b) => new Date(b.Date) - new Date(a.Date));
                const itemToFind = sortedData[idx];
                const originalIdx = data.findIndex(i => JSON.stringify(i) === JSON.stringify(itemToFind));
                data.splice(originalIdx, 1);
                await Storage.save(storageKey, data);
                await renderAccountsTable(title, storageKey, title === 'Income' ? '#4ade80' : '#ef4444');
            }
        }
        
        async function renderDataTable(title, storageKey, color, formType) {
            const container = document.getElementById('moduleContent');
            
            // Show skeleton loading first
            container.innerHTML = `
                <div class="data-header">
                    <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                    <button class="add-btn" onclick="openAddModal('${title}', '${storageKey}', '${formType || title}')"><i class="fas fa-plus"></i> Add New</button>
                </div>
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput_${storageKey}" placeholder="Search ${title}..." oninput="filterTable('${storageKey}')">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table id="table_${storageKey}">
                        <thead>
                            <tr>
                                ${Array.from({length: 5}).map(() => `
                                    <th><div class="skeleton" style="width:80px; height:20px; border-radius:6px;"></div></th>
                                `).join('')}
                                <th class="center"><div class="skeleton" style="width:60px; height:20px; border-radius:6px; margin:0 auto;"></div></th>
                            </tr>
                        </thead>
                        <tbody id="tbody_${storageKey}">
                            ${Array.from({length: 5}).map(() => `
                                <tr class="table-row skeleton lazy-table-row">
                                    ${Array.from({length: 6}).map(() => `
                                        <td><div class="skeleton" style="width:90%; height:15px;"></div></td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load data in background
            setTimeout(async () => {
                const data = await Storage.get(storageKey) || [];
                const fields = formConfigs[formType || title];
                
                container.innerHTML = `
                    <div class="data-header">
                        <h3 style="margin:0; font-size:1rem; color:${color}">${title}</h3>
                        <button class="add-btn" onclick="openAddModal('${title}', '${storageKey}', '${formType || title}')"><i class="fas fa-plus"></i> Add New</button>
                    </div>
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchInput_${storageKey}" placeholder="Search ${title}..." oninput="filterTable('${storageKey}')">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="table-container">
                        <table id="table_${storageKey}">
                            <thead>
                                <tr>
                                    ${fields.map(f => `<th class="${['SL', 'Unit', 'Unit Price', 'Available Quantity'].includes(f) ? 'center' : ''}">${f}</th>`).join('')}
                                    <th class="center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_${storageKey}">
                                ${data.map((row, idx) => `
                                    <tr class="lazy-table-row" data-index="${idx}">
                                        ${fields.map(f => {
                                            const isCenter = ['SL', 'Unit', 'Unit Price', 'Available Quantity'].includes(f);
                                            let val = (f === 'SL') ? (idx + 1) : (row[f] || '-');
                                            if (f === 'Date') val = formatDate(val);
                                            return `<td class="${isCenter ? 'center' : ''}">${val}</td>`;
                                        }).join('')}
                                        <td class="center">
                                            <div class="action-btns">
                                                <i class="fas fa-pen edit-btn" onclick="openEditModal(${idx}, '${title}', '${storageKey}', '${formType || title}')"></i>
                                                <i class="fas fa-trash del-btn" onclick="deleteRecord(${idx}, '${storageKey}', '${title}', '${formType || title}')"></i>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Initialize lazy loading for table rows
                initLazyLoadObserver();
                const lazyRows = container.querySelectorAll('.lazy-table-row');
                lazyRows.forEach(row => lazyLoadObserver.observe(row));
                
            }, 100);
        }
        
        function filterTable(storageKey) {
            const searchInput = document.getElementById(`searchInput_${storageKey}`);
            const searchTerm = searchInput.value.toLowerCase();
            const tableBody = document.getElementById(`tbody_${storageKey}`);
            const rows = tableBody.getElementsByTagName('tr');
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let found = false;
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }
                row.style.display = found ? '' : 'none';
            }
        }
        
        async function renderMasterList(color) {
            const container = document.getElementById('moduleContent');
            
            // Show skeleton loading first
            container.innerHTML = `
                <div class="data-header">
                    <h3 style="margin:0; font-size:1rem; color:${color}">Product Master List</h3>
                </div>
                <div class="search-container">
                    <input type="text" class="search-input" id="searchMaster" placeholder="Search Master List..." oninput="filterMasterList()">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table id="masterTable">
                        <thead>
                            <tr>
                                ${Array.from({length: 7}).map(() => `
                                    <th><div class="skeleton" style="width:80px; height:20px; border-radius:6px; margin:0 auto;"></div></th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody id="masterTableBody">
                            ${Array.from({length: 5}).map(() => `
                                <tr class="table-row skeleton lazy-table-row">
                                    ${Array.from({length: 7}).map(() => `
                                        <td><div class="skeleton" style="width:90%; height:15px;"></div></td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load data in background
            setTimeout(async () => {
                const categories = await Storage.get('product_categories') || [];
                let masterData = [];
                for (const key of categories) {
                    const categoryData = await Storage.get(key) || [];
                    categoryData.forEach(item => {
                        masterData.push({ 
                            ...item, 
                            Category: key.charAt(0).toUpperCase() + key.slice(1),
                            Quantity: item.Quantity || 0
                        });
                    });
                }
                
                const fields = formConfigs['Master List'];
                container.innerHTML = `
                    <div class="data-header">
                        <h3 style="margin:0; font-size:1rem; color:${color}">Product Master List</h3>
                    </div>
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchMaster" placeholder="Search Master List..." oninput="filterMasterList()">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="table-container">
                        <table id="masterTable">
                            <thead>
                                <tr>${fields.map(f => `<th class="${['SL', 'Unit', 'Unit Price', 'Available Quantity'].includes(f) ? 'center' : ''}">${f}</th>`).join('')}</tr>
                            </thead>
                            <tbody id="masterTableBody">
                                ${masterData.length === 0 ? `<tr><td colspan="${fields.length}" style="text-align:center; opacity:0.5">No products found</td></tr>` : masterData.map((row, idx) => `
                                    <tr class="lazy-table-row" data-index="${idx}">
                                        ${fields.map(f => {
                                            let val = (f === 'SL') ? (idx + 1) : (row[f] || '-');
                                            if (f === 'Date') val = formatDate(val);
                                            if (f === 'Available Quantity') {
                                                val = row.Quantity || 0;
                                                return `<td class="center" style="font-weight:800; color:${val > 0 ? 'var(--success)' : 'var(--danger)'}">${val}</td>`;
                                            }
                                            return `<td class="${['SL', 'Unit', 'Unit Price', 'Available Quantity'].includes(f) ? 'center' : ''}">${val}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Initialize lazy loading for table rows
                initLazyLoadObserver();
                const lazyRows = container.querySelectorAll('.lazy-table-row');
                lazyRows.forEach(row => lazyLoadObserver.observe(row));
                
            }, 100);
        }
        
        function filterMasterList() {
            const searchInput = document.getElementById('searchMaster');
            const searchTerm = searchInput.value.toLowerCase();
            const tableBody = document.getElementById('masterTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let found = false;
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }
                row.style.display = found ? '' : 'none';
            }
        }
        
        function openAddModal(title, storageKey, formType) {
            currentEditIndex = -1;
            showModal(title, storageKey, formType);
        }
        
        function openEditModal(index, title, storageKey, formType) {
            currentEditIndex = index;
            showModal(title, storageKey, formType);
        }
        
        async function showModal(title, storageKey, formType, existingData = null) {
            const data = existingData ? existingData : (await Storage.get(storageKey) || [])[currentEditIndex] || {};
            const fields = formConfigs[formType];
            const form = document.getElementById('genericForm');
            const overlay = document.getElementById('modalOverlay');
            document.getElementById('modalTitle').innerText = (existingData || currentEditIndex > -1 ? 'Edit ' : 'Add ') + title;
            
            form.innerHTML = fields.filter(f => f !== 'SL').map(f => {
                let type = "text";
                if(f === 'Date') type = "date";
                if(['Amount', 'Unit Price', 'WO Amount', 'WO Cost', 'BD Cost', 'Partner Cost', 'Total Profit', 'Qty', 'Cost Price', 'Sale Price', 'Profit', 'Cost', 'Available Quantity'].includes(f)) type = "number";
                
                // Add unique ID for search functionality if it's the "Items" field in Product Form
                const fieldId = (formType === 'Products' && f === 'Items') ? 'item_search_input' : '';
                const searchContainer = fieldId ? `<div style="position:relative"><div id="item_search_results" class="search-results" style="display:none"></div>` : '';
                const searchContainerClose = fieldId ? `</div>` : '';

                return `
                    <div class="form-group" style="position:relative">
                        <label>${f}</label>
                        ${searchContainer}
                        <input type="${type}" class="form-input" id="${fieldId}" name="${f}" value="${data[f] || ''}" ${type === 'number' ? 'step="0.01"' : ''}
                               ${fieldId ? 'oninput="suggestSimilarProducts(this.value)" autocomplete="off"' : ''}>
                        ${searchContainerClose}
                    </div>
                `;
            }).join('');
            
            form.dataset.storage = storageKey;
            form.dataset.title = title;
            form.dataset.type = formType;
            overlay.style.display = 'flex';
        }

        async function suggestSimilarProducts(val) {
            const results = document.getElementById('item_search_results');
            if(!val) { results.style.display = 'none'; return; }
            
            const categories = await Storage.get('product_categories') || [];
            let allProducts = [];
            for (const k of categories) {
                const products = await Storage.get(k) || [];
                allProducts = [...allProducts, ...products];
            }
            
            const filtered = allProducts.filter(p => p.Items.toLowerCase().includes(val.toLowerCase()));
            if(filtered.length > 0) {
                // Show first 5 suggestions
                results.innerHTML = filtered.slice(0,5).map(p => `
                    <div class="search-item" onclick="autoFillProductForm('${p.Items.replace(/'/g, "\\'")}', '${p.Description.replace(/'/g, "\\'")}', '${p['Unit Price']}', '${p.Quantity || 0}')">
                        ${p.Items} <small style="opacity:0.6;">(${p['Unit Price']})</small>
                    </div>
                `).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }

        function autoFillProductForm(name, desc, price, quantity) {
            const nameField = document.getElementById('item_search_input');
            const form = document.getElementById('genericForm');
            
            if(nameField) nameField.value = name;
            
            // Look for Description, Unit Price, and Available Quantity fields by name attribute
            const descField = form.querySelector('[name="Description"]');
            const priceField = form.querySelector('[name="Unit Price"]');
            const quantityField = form.querySelector('[name="Available Quantity"]');
            
            if(descField) descField.value = desc;
            if(priceField) priceField.value = price;
            if(quantityField) quantityField.value = quantity || 0;
            
            document.getElementById('item_search_results').style.display = 'none';
        }

        function closeModal() { 
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('genericForm').innerHTML = '';
        }
        
        async function saveRecord() {
            try {
                const form = document.getElementById('genericForm');
                const storageKey = form.dataset.storage;
                const title = form.dataset.title;
                const type = form.dataset.type;
                if (!storageKey || !title) return;
                const formData = new FormData(form);
                const entry = {};
                formData.forEach((value, key) => { entry[key] = value; });
                const data = await Storage.get(storageKey) || [];
                if (currentEditIndex > -1) data[currentEditIndex] = entry;
                else data.push(entry);
                await Storage.save(storageKey, data);
                closeModal();
                let color = '#4ade80';
                if (currentModule === 'Clients') color = '#4ade80';
                else if (currentModule === 'Supplier') color = '#2dd4bf';
                else if (currentModule === 'Products') color = '#fbbf24';
                if (type === 'Calculation') await renderWODataTable(title, storageKey, '#f97316');
                else if (type === 'Income' || type === 'Expense') await renderAccountsTable(type, storageKey, type === 'Income' ? '#4ade80' : '#ef4444');
                else await renderDataTable(title, storageKey, color, type);
            } catch (error) { console.error('Error saving record:', error); }
        }
        
        async function deleteRecord(index, storageKey, title, type) {
            if(confirm('Delete record?')) {
                const data = await Storage.get(storageKey);
                data.splice(index, 1);
                await Storage.save(storageKey, data);
                let color = '#4ade80';
                if (currentModule === 'Clients') color = '#4ade80';
                else if (currentModule === 'Supplier') color = '#2dd4bf';
                else if (currentModule === 'Products') color = '#fbbf24';
                if(type === 'Calculation') await renderWODataTable(title, storageKey, '#f97316');
                else await renderDataTable(title, storageKey, color, type);
            }
        }
        
        async function renderMgmt(container) {
            const config = await Storage.get('config') || {};
            const mdPhoto = await Storage.get('md_photo');
            const chairmanPhoto = await Storage.get('chairman_photo');
            const directorPhoto = await Storage.get('director_photo');
            
            container.innerHTML = `
                <div class="mgmt-section">
                    <div class="mgmt-title">Leadership Profile</div>
                    <div class="mgmt-card" style="border-top: 4px solid var(--primary);">
                        <div class="md-profile-container">
                            <div class="md-photo-frame" style="border-radius: 50%; width: 160px; height: 160px;">
                                ${chairmanPhoto ? `<img src="${chairmanPhoto}" alt="Chairman" class="lazy-image" data-src="${chairmanPhoto}">` : `<i class="fas fa-user-tie md-photo-placeholder"></i>`}
                            </div>
                            <div class="md-info-block">
                                <p class="md-name" style="color:var(--primary)">${config.chairmanName || 'Md. Abul Khair'}</p>
                                <p style="font-size: 0.75rem; font-weight: 800; color: var(--accent); margin: 5px 0; text-transform: uppercase; letter-spacing:1px;">Honorable Chairman</p>
                            </div>
                            <div class="mgmt-msg-box">
                                ${config.chairmanMsg || 'As the Chairman, my vision is to lead with purpose and social responsibility.'}
                            </div>
                        </div>
                    </div>
                    <div class="mgmt-card" style="border-top: 4px solid var(--primary); margin-top:20px;">
                        <div class="md-profile-container">
                            <div class="md-photo-frame">
                                ${mdPhoto ? `<img src="${mdPhoto}" alt="MD" class="lazy-image" data-src="${mdPhoto}">` : `<i class="fas fa-user-tie md-photo-placeholder"></i>`}
                            </div>
                            <div class="md-info-block">
                                <p class="md-name">${config.mdName || 'Engr. Md. Jakaria Ahmed'}</p>
                                <p class="md-titles">MBA (DU), B.Sc (EEE), PMSFPE (USA), MIEB (Life)</p>
                                <p style="font-size: 0.75rem; font-weight: 800; color: var(--primary); margin: 0; text-transform: uppercase; letter-spacing:1px;">Managing Director</p>
                            </div>
                            <div class="mgmt-msg-box">
                                ${config.mdMsg || 'We strive for excellence in engineering and safety standards.'}
                            </div>
                        </div>
                    </div>
                    <div class="mgmt-card" style="border-top: 4px solid var(--accent); margin-top:20px;">
                        <div class="md-profile-container">
                            <div class="md-photo-frame" style="border-color: var(--accent);">
                                ${directorPhoto ? `<img src="${directorPhoto}" alt="Director" class="lazy-image" data-src="${directorPhoto}">` : `<i class="fas fa-user-tie md-photo-placeholder"></i>`}
                            </div>
                            <div class="md-info-block">
                                <p class="md-name">${config.directorName || 'Management Director'}</p>
                                <p style="font-size: 0.75rem; font-weight: 800; color: var(--accent); margin: 5px 0; text-transform: uppercase; letter-spacing:1px;">Director</p>
                            </div>
                            <div class="mgmt-msg-box">
                                ${config.directorMsg || 'Operational efficiency and customer satisfaction are our primary goals.'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mgmt-section">
                    <div class="mgmt-title">Corporate Identity</div>
                    <div class="vvm-container">
                        <div class="vvm-item vvm-vision">
                            <i class="fas fa-eye"></i>
                            <h4 style="color: var(--accent);">Our Vision</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem; text-align: justify;">To be the global benchmark in life safety and engineering solutions by providing innovative and sustainable technologies.</p>
                        </div>
                        <div class="vvm-item vvm-mission">
                            <i class="fas fa-rocket"></i>
                            <h4 style="color: var(--primary);">Our Mission</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem; text-align: justify;">To deliver unified, high-quality fire safety and security systems through engineering excellence and unwavering commitment to human life.</p>
                        </div>
                        <div class="vvm-item vvm-goals">
                            <i class="fas fa-bullseye"></i>
                            <h4 style="color: #a78bfa;">Our Goals</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem; text-align: justify;">1. Ensure 100% compliance with international fire safety standards.<br>2. Expand our innovative engineering footprint globally.<br>3. Achieve peak customer satisfaction through proactive maintenance and support.</p>
                        </div>
                        <div class="vvm-item vvm-values">
                            <i class="fas fa-handshake-angle"></i>
                            <h4 style="color: var(--success);">Core Values</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem; text-align: justify;"><strong>Integrity:</strong> Uncompromising ethical standards.<br><strong>Excellence:</strong> Superior quality in every installation.<br><strong>Innovation:</strong> Continuously evolving safety technologies.</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize lazy loading for images
            initLazyLoadObserver();
            const lazyImages = container.querySelectorAll('.lazy-image');
            lazyImages.forEach(img => lazyLoadObserver.observe(img));
        }
        
        async function renderSettings(container) {
            const config = await Storage.get('config') || {};
            const assets = ['chairman_photo', 'md_photo', 'director_photo', 'co_logo', 'md_sig', 'doc_sig', 'co_seal', 'received_seal'];
            const assetLabels = ["Chairman's Photo", "MD's Photo", "Director's Photo", "Company Logo", "MD's Signature", "Doc Signature", "Company Seal", "Received By Seal"];
            const assetPreviews = {};
            
            // Load asset previews in parallel
            const previewPromises = assets.map(async (key) => {
                assetPreviews[key] = await Storage.get(key);
            });
            await Promise.all(previewPromises);
            
            container.innerHTML = `
                <div class="settings-section">
                    <div class="settings-title">Company Information</div>
                    <div class="settings-card">
                        <div class="config-form">
                            <div class="config-row"><label>Company Name</label><input type="text" id="conf_company_name" class="config-input" value="${config.companyName || ''}"></div>
                            <div class="config-row"><label>Company Address</label><textarea id="conf_company_address" class="config-area">${config.companyAddress || ''}</textarea></div>
                            <div class="config-row"><label>Company Slogan</label><input type="text" id="conf_slogan" class="config-input" value="${config.slogan || ''}"></div>
                            <div class="quote-grid">
                                <div class="config-row"><label>Email</label><input type="email" id="conf_email" class="config-input" value="${config.email || ''}"></div>
                                <div class="config-row"><label>Mobile</label><input type="tel" id="conf_mobile" class="config-input" value="${config.mobile || ''}"></div>
                            </div>
                            <div class="config-row"><label>Website</label><input type="text" id="conf_website" class="config-input" value="${config.website || ''}"></div>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Official Terms & Conditions</div>
                    <div class="settings-card">
                        <div class="config-form">
                            <div class="config-row"><label>Terms & Conditions (Quotation)</label><textarea id="conf_tc_quote" class="config-area" placeholder="Enter terms for Quotation...">${config.tc_quote || ''}</textarea></div>
                            <div class="config-row"><label>Terms & Conditions (Invoice)</label><textarea id="conf_tc_inv" class="config-area" placeholder="Enter terms for Invoice...">${config.tc_inv || ''}</textarea></div>
                            <div class="config-row"><label>Terms & Conditions (Delivery Challan)</label><textarea id="conf_tc_del" class="config-area" placeholder="Enter terms for Delivery Challan...">${config.tc_del || ''}</textarea></div>
                            <div class="config-row"><label>Terms & Conditions (Purchase Order)</label><textarea id="conf_tc_po" class="config-area" placeholder="Enter terms for Purchase Order...">${config.tc_po || ''}</textarea></div>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Leadership Configuration</div>
                    <div class="settings-card">
                        <div class="config-form">
                            <div class="config-row"><label>Chairman Name</label><input type="text" id="conf_chairman_name" class="config-input" value="${config.chairmanName || ''}"></div>
                            <div class="config-row"><label>Chairman Message</label><textarea id="conf_chairman_msg" class="config-area">${config.chairmanMsg || ''}</textarea></div>
                            <hr style="opacity:0.1; margin:10px 0;">
                            <div class="config-row"><label>Managing Director Name</label><input type="text" id="conf_md_name" class="config-input" value="${config.mdName || ''}"></div>
                            <div class="config-row"><label>MD Message</label><textarea id="conf_md_msg" class="config-area">${config.mdMsg || ''}</textarea></div>
                            <hr style="opacity:0.1; margin:10px 0;">
                            <div class="config-row"><label>Director Name</label><input type="text" id="conf_director_name" class="config-input" value="${config.directorName || ''}"></div>
                            <div class="config-row"><label>Director Message</label><textarea id="conf_director_msg" class="config-area">${config.directorMsg || ''}</textarea></div>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">PDF Display Settings</div>
                    <div class="settings-card">
                        <div class="switch-container">
                            <label class="switch">
                                <input type="checkbox" id="conf_show_logo" ${config.showLogoInPdf !== false ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <span style="font-size: 0.85rem; font-weight: 700; color: #cbd5e1;">Show Company Logo in PDF</span>
                        </div>
                        <div class="switch-container">
                            <label class="switch">
                                <input type="checkbox" id="conf_show_seal" ${config.showSealInPdf !== false ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <span style="font-size: 0.85rem; font-weight: 700; color: #cbd5e1;">Show Company Seal in PDF</span>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Identity Assets</div>
                    <div class="settings-card">
                        <div class="settings-grid">
                            ${assets.map((key, i) => `
                                <div class="upload-zone" onclick="document.getElementById('${key}Input').click()">
                                    <i class="fas fa-camera"></i>
                                    <span class="upload-label">${assetLabels[i]}</span>
                                    ${assetPreviews[key] ? `<img src="${assetPreviews[key]}" id="${key}Prev" class="upload-preview lazy-image" data-src="${assetPreviews[key]}" style="display:block;">` : `<img id="${key}Prev" class="upload-preview" style="display:none;">`}
                                    <input type="file" id="${key}Input" hidden accept="image/*" onchange="handleAssetUpload('${key}', this)">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Business Configuration</div>
                    <div class="settings-card">
                        <div class="config-form">
                            <div class="config-row">
                                <label>Currency Symbol</label>
                                <select id="conf_currency" class="config-input" style="background:#0f172a; color:white;">
                                    <option value="à§³" ${config.currency === 'à§³' ? 'selected' : ''}>à§³ (BDT)</option>
                                    <option value="$" ${config.currency === '$' ? 'selected' : ''}>$ (USD)</option>
                                </select>
                            </div>
                            <div class="config-row"><label>Signatory Name (For Docs)</label><input type="text" id="conf_sign_name" class="config-input" value="${config.signName || ''}"></div>
                            <div class="config-row"><label>Signatory Designation</label><input type="text" id="conf_sign_desig" class="config-input" value="${config.signDesig || ''}"></div>
                            <button class="save-all-btn" onclick="saveConfig()">Save All Settings</button>
                            <p id="saveMsg" style="color:var(--success); font-size:0.7rem; text-align:center; margin-top:10px; display:none;">Settings updated successfully!</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize lazy loading for images
            initLazyLoadObserver();
            const lazyImages = container.querySelectorAll('.lazy-image');
            lazyImages.forEach(img => lazyLoadObserver.observe(img));
        }
        
        async function handleAssetUpload(key, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const data = e.target.result;
                    document.getElementById(key + 'Prev').src = data;
                    document.getElementById(key + 'Prev').style.display = 'block';
                    await Storage.save(key, data);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        async function saveConfig() {
            const config = {
                companyName: document.getElementById('conf_company_name').value,
                companyAddress: document.getElementById('conf_company_address').value,
                slogan: document.getElementById('conf_slogan').value,
                email: document.getElementById('conf_email').value,
                mobile: document.getElementById('conf_mobile').value,
                website: document.getElementById('conf_website').value,
                chairmanName: document.getElementById('conf_chairman_name').value,
                chairmanMsg: document.getElementById('conf_chairman_msg').value,
                mdName: document.getElementById('conf_md_name').value,
                mdMsg: document.getElementById('conf_md_msg').value,
                directorName: document.getElementById('conf_director_name').value,
                directorMsg: document.getElementById('conf_director_msg').value,
                currency: document.getElementById('conf_currency').value,
                signName: document.getElementById('conf_sign_name').value,
                signDesig: document.getElementById('conf_sign_desig').value,
                tc_quote: document.getElementById('conf_tc_quote').value,
                tc_inv: document.getElementById('conf_tc_inv').value,
                tc_del: document.getElementById('conf_tc_del').value,
                tc_po: document.getElementById('conf_tc_po').value,
                showLogoInPdf: document.getElementById('conf_show_logo').checked,
                showSealInPdf: document.getElementById('conf_show_seal').checked
            };
            await Storage.save('config', config);
            const msg = document.getElementById('saveMsg');
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 2000);
        }
        
        async function renderHome(container) {
            container.innerHTML = `
                <div class="home-section">
                    <div class="home-title">GET TO KNOW US</div>
                    <div class="home-card" style="border-top: 4px solid var(--accent)">
                        <p class="home-text">
                            <span class="home-highlight">FAITH ENGINEERING</span> promotes the most unified and unique fire safety and security solutions in various sectors. We offer a wide range of fire system design, installation, regular maintenance, repair, inspection and training services.
                        </p>
                        <p class="home-text">
                            We are recognized across engineering, construction and other multiple industries for our detailed, reliable and responsive services. We promote safety and security to protect life and property across major industries namely residential and commercial facilities, oil and gas refineries, airports and aviation, health care and education, military and police, hospitality and leisure.
                        </p>
                        <p class="home-text" style="font-weight: 800; color: var(--accent);">
                            Visit our official portal: <a href="https://www.faithbd.org" target="_blank" style="color: inherit; text-decoration: underline;">www.faithbd.org</a>
                        </p>
                    </div>

                    <div class="exp-badge-container">
                        <div class="exp-ring"></div>
                        <div class="exp-badge-main">
                            <span class="exp-number">10+</span>
                            <div class="exp-label">Years of Excellence</div>
                        </div>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-title">Our Working Process</div>
                    <div class="process-container">
                        <div class="process-line"></div>
                        
                        <div class="process-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <p class="step-title">Assessment</p>
                                <p class="step-desc">Site inspection and requirement analysis.</p>
                            </div>
                            <i class="fas fa-clipboard-check step-icon"></i>
                        </div>

                        <div class="process-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <p class="step-title">Design</p>
                                <p class="step-desc">Standard engineering and AutoCAD layout.</p>
                            </div>
                            <i class="fas fa-drafting-compass step-icon"></i>
                        </div>

                        <div class="process-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <p class="step-title">Supply</p>
                                <p class="step-desc">Delivery of high-quality standard equipment.</p>
                            </div>
                            <i class="fas fa-truck-ramp-box step-icon"></i>
                        </div>

                        <div class="process-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <p class="step-title">Installation</p>
                                <p class="step-desc">Expert fitting by qualified technical team.</p>
                            </div>
                            <i class="fas fa-tools step-icon"></i>
                        </div>

                        <div class="process-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <p class="step-title">Maintenance</p>
                                <p class="step-desc">Regular servicing and technical support.</p>
                            </div>
                            <i class="fas fa-shield-heart step-icon"></i>
                        </div>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-title">WHAT WE DO</div>
                    <div class="vvm-container">
                        <div class="vvm-item vvm-vision">
                            <i class="fas fa-shield-fire"></i>
                            <h4 style="color: var(--accent);">Fire Safety Services</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem;">FAITH ENGINEERING provides custom fire system designs tailored to meet the unique safety needs of various industries. Our team ensures every design complies with international standards.</p>
                        </div>
                        <div class="vvm-item vvm-mission">
                            <i class="fas fa-video"></i>
                            <h4 style="color: var(--primary);">Security Solutions</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem;">FAITH ENGINEERING offers a comprehensive range of cutting-edge security solutions designed to safeguard people, property, and assets across various industries.</p>
                        </div>
                        <div class="vvm-item vvm-goals" style="border-left-color: #a78bfa;">
                            <i class="fas fa-bolt"></i>
                            <h4 style="color: #a78bfa;">Electrical Engineering</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem;">FAITH ENGINEERING delivers comprehensive electrical engineering solutions tailored to ensure safety, efficiency, and reliability in various industries.</p>
                        </div>
                        <div class="vvm-item vvm-values">
                            <i class="fas fa-screwdriver-wrench"></i>
                            <h4 style="color: var(--success);">Maintenance and Support</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem;">FAITH ENGINEERING provides reliable maintenance and support services to ensure the continuous performance and longevity of fire safety and security systems.</p>
                        </div>
                         <div class="vvm-item" style="background: linear-gradient(135deg, rgba(244, 114, 182, 0.1) 0%, rgba(2, 6, 23, 0.8) 100%); border-left: 5px solid #f472b6;">
                            <i class="fas fa-chalkboard-user" style="opacity:0.1; font-size:2rem; position:absolute; right:20px;"></i>
                            <h4 style="color: #f472b6;">Training and Consultation</h4>
                            <p class="home-text" style="margin:0; font-size: 0.8rem;">FAITH ENGINEERING offers specialized training and consultation services to empower organizations with the knowledge needed for effective safety management.</p>
                        </div>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-title">OUR AFFILIATION</div>
                    <div class="sfpe-container">
                        <div class="sfpe-pulse"></div>
                        <div class="sfpe-logo-ring">SFPE</div>
                        <div style="margin-left: 20px;">
                            <h4 style="margin:0; color: var(--primary); letter-spacing: 2px;">SFPE MEMBER</h4>
                            <p style="margin:0; font-size: 0.75rem; color: #fff; font-weight: 500;">Society of Fire Protection Engineers</p>
                        </div>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-title">Connect With Us</div>
                    <div class="contact-pill"><i class="fas fa-location-dot"></i> Arif Tower (3rd Floor), Road: S - 1, Block : L, Eastern Housing, Mirpur, Dhaka - 1216</div>
                    <div class="contact-pill"><i class="fas fa-envelope"></i> info@faithbd.org</div>
                    <div class="contact-pill"><i class="fas fa-phone"></i> +8801891970197</div>
                    <div class="contact-pill"><i class="fas fa-globe"></i> www.faithbd.org</div>
                </div>
            `;
        }
        
        function updateDateTime() {
            const now = new Date();
            const clock = document.getElementById('clock');
            if(clock) clock.innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true}).toUpperCase();
            const dayNum = now.getDate();
            const month = now.toLocaleString('default', { month: 'long' });
            const year = now.getFullYear();
            const weekday = now.toLocaleString('default', { weekday: 'long' });
            const getOrdinal = (n) => { const s = ["th", "st", "nd", "rd"]; const v = n % 100; return n + (s["(v - 20) % 10"] || s[v] || s[0]); };
            const disp = document.getElementById('date-display');
            if(disp) disp.innerText = `${getOrdinal(dayNum)} ${month} ${year}, ${weekday}`;
        }
        
        // Initialize lazy loading observer on page load
        document.addEventListener('DOMContentLoaded', () => {
            initLazyLoadObserver();
        });
        
        if(localStorage.getItem('fe_session')) document.getElementById('loginOverlay').style.display = 'none';
        updateDateTime();
        setInterval(updateDateTime, 1000);
        window.onload = scrollToTop;
    </script>
</body>
</html>